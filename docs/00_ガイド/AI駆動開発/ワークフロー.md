# AI駆動開発 ワークフロー

## ゴール

**コードとドキュメントを常に同期して、変更容易性を最優先する**

```
Miro（Source of Truth）
    ↕ 同期
Markdown（設計ドキュメント）
    ↕ 同期
Code（実装）
```

---

## 全体フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│  【初期開発】                                                           │
│                                                                         │
│  Phase 0: /project-overview                                             │
│    人間が情報提供 → 統一フォーマットでプロジェクト概要書を生成          │
│    → 申し送り: docs/.context/phase0-handoff.md                          │
│                                                                         │
│  Phase 0.5: /discovery-session（必須）                                  │
│    構造化ヒアリング → ES用サマリー生成                                  │
│    ※ --quick で軽量版（30分）、通常版は3セッション                     │
│    → 申し送り: docs/.context/phase05-handoff.md                         │
│                                                                         │
│  Phase 1: /event-storming                                               │
│    ES用サマリーからES図生成（デフォルト）→ Miroに転記                   │
│    ※ --no-discovery で明示的にディスカバリーなし実行                    │
│    → 品質ゲート → 申し送り: docs/.context/phase1-handoff.md             │
│                                                                         │
│  Phase 2: /domain-modeling                                              │
│    Miro/ES図から構造取得 → 対話で詳細化 → ドメインモデル生成           │
│    ※ --minimal オプションでMust質問のみ                                │
│    → 品質ゲート → 申し送り: docs/.context/phase2-handoff.md             │
│                                                                         │
│  Phase 3: /api-design, /db-design, /screen-design（並列実行可）        │
│    ドメインモデルを元に詳細設計生成                                     │
│    ※ 並列実行ガイド: skills/shared/parallel-execution-guide.md         │
│    → 品質ゲート → 整合性チェック                                       │
│                                                                         │
│  Phase 3.5: /cross-context-design                                       │
│    全集約の Phase 3 完了後、コンテキスト間の連携設計を生成              │
│    → 品質ゲート → 申し送り: docs/.context/phase35-handoff.md           │
│                                                                         │
│  （任意）: /design-review                                               │
│    設計ドキュメントの実装可能性を15項目で定量評価                       │
│                                                                         │
│  （任意）: /estimate                                                     │
│    設計メトリクスから工数見積もりを自動生成                             │
│                                                                         │
│  Phase 4: 実装                                                          │
│    /scaffold でプロジェクト構成生成 → Miro + Markdown → コード生成      │
│                                                                         │
│  進捗管理: docs/.context/workflow-state.yaml                            │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│  【継続開発】                                                           │
│                                                                         │
│  要件追加 → Miro編集 → /sync または --sync オプションで同期            │
│           → Markdown更新 → コード更新                                  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## スキル一覧

| スキル | 用途 | 出力先 |
|--------|------|--------|
| `/project-overview` | プロジェクト概要書 + 技術スタック生成 | `20_ドメイン/プロジェクト概要.md`, `10_アーキテクチャ/技術スタック.md` |
| `/discovery-session` | ES前ヒアリング | `20_ドメイン/ディスカバリー/ES用サマリー.md` |
| `/event-storming` | イベントストーミング図生成 | `20_ドメイン/イベントストーミング/{context}.md` |
| `/domain-modeling` | ドメインモデル生成 | `20_ドメイン/{context}/{aggregate}集約.md` |
| `/api-design` | API設計生成 | `30_設計/API/エンドポイント/{aggregate}.md` |
| `/db-design` | データベース設計生成 | `30_設計/データベース/{aggregate}.md` |
| `/screen-design` | 画面設計生成 | `30_設計/画面/screens/{screen}.md` |
| `/screen-map` | API→画面マップ生成 | `30_設計/画面/{context}/{aggregate}/screen-map.md` |
| `/cross-context-design` | コンテキスト間連携設計 | `30_設計/コンテキスト間連携.md` |
| `/design-review` | 設計実装可能性レビュー | `tmp/design-review-report.md` |
| `/estimate` | 工数見積もり自動生成 | `80_見積もり/{project}_見積もり_{YYYYMMDD}.md` |
| `/create-backlog-issue` | Backlog課題一括生成 | Backlog（集約単位で親子課題作成） |
| `/scaffold` | プロジェクトスキャフォールド生成 | プロジェクトルート |
| `/sync` | 全体同期チェック | - |

### オプション一覧

| スキル | オプション | 説明 |
|--------|-----------|------|
| `/discovery-session` | `--quick` | 30分版（小規模プロジェクト向け） |
| `/event-storming` | `--no-discovery` | ディスカバリーなしで対話のみ（非推奨） |
| `/event-storming` | `--sync` | Miroから同期 |
| `/domain-modeling` | `--sync` | ES図/Miroから同期 |
| `/domain-modeling` | `--minimal` | Must質問12問のみ（短時間版） |
| `/api-design` | `--format openapi` | OpenAPI Spec形式で出力 |
| `/db-design` | `--format sql` | DDL形式で出力 |
| `/scaffold` | `--pattern es` | イベントソーシング + CQRS（Axon Framework） |
| `/scaffold` | `--pattern standard` | DDD + 軽量CQRS（JOOQ）- デフォルト |
| `/create-backlog-issue` | `--milestone` | 既存マイルストーンにリンク |
| `/create-backlog-issue` | `--create-milestone` | 集約名でマイルストーン自動作成 |
| `/create-backlog-issue` | `--dry-run` | 作成プレビューのみ |

### 使用例

```bash
# 標準フロー（推奨）
/project-overview                                  # Phase 0
/discovery-session                                 # Phase 0.5（必須・3セッション版）
/event-storming コアコンテキスト                   # Phase 1（ディスカバリー連携がデフォルト）
/domain-modeling ユーザー                          # Phase 2

# 軽量モード（小規模・時間制約がある場合）
/discovery-session --quick                # 30分版（必須は変わらない）
/domain-modeling ユーザー --minimal       # Must質問のみ

# ディスカバリーなし（非推奨・明示的オプトアウト）
/event-storming コアコンテキスト --no-discovery    # 対話のみ

# 同期モード（継続開発時）
/event-storming コアコンテキスト --sync   # Miroから同期
/domain-modeling ユーザー --sync          # ES図/Miroから同期

# Phase 3 個別実行（並列実行ガイド参照）
/api-design ユーザー                            # API設計
/db-design ユーザー                             # DB設計
/screen-map ユーザー                            # 画面マップ
/screen-design ユーザー一覧                     # 画面設計

# Phase 3.5 コンテキスト間連携設計（全集約の Phase 3 完了後）
/cross-context-design

# 設計レビュー（任意）
/design-review
/design-review --threshold 65                  # 合格ラインを変更

# 工数見積もり（任意）
/estimate
/estimate --update-config                      # 設定更新後に再見積もり

# Phase 4 スキャフォールド生成
/scaffold                                       # 対話形式でパターン選択
/scaffold --pattern standard                        # JOOQベースの軽量CQRS
/scaffold --pattern es                          # Axon Frameworkベースのイベントソーシング

# Backlog課題作成
/create-backlog-issue ユーザー                  # 集約単位で課題作成
/create-backlog-issue ユーザー --milestone "v1.0"  # マイルストーンにリンク
/create-backlog-issue ユーザー --dry-run        # プレビューのみ
```

---

## Phase 0: プロジェクト概要

### 目的

- プロジェクトの基本情報を統一フォーマットで整理
- ドメインモデリングの前提知識を明文化

### 実行方法

```bash
/project-overview
```

人間が自由形式で情報を提供 → AIが統一フォーマットに整形して出力

### 出力ファイル

| ファイル | 内容 |
|---------|------|
| `20_ドメイン/プロジェクト概要.md` | プロジェクト概要書 |
| `10_アーキテクチャ/技術スタック.md` | アーキテクチャ方針・技術スタック詳細 |

### プロジェクト概要書の構成

```markdown
# プロジェクト概要

## 基本情報
## 課題背景
## ソリューション概要
## 主要ステークホルダー
## コア機能
## 技術要件
## アーキテクチャ方針  ← 新規追加
## 成功指標（KPI）
## リスクと制約
## 開発計画
```

※ アーキテクチャ詳細は `10_アーキテクチャ/技術スタック.md` を参照

---

## Phase 0.5: ディスカバリーセッション（必須）

### 目的

- イベントストーミング前の構造化ヒアリング
- ES用サマリーを生成し、Phase 1 の入力とする
- **必須**: スキップ不可。規模に応じてモードを選択する

### 前提条件

- Phase 0（`/project-overview`）が完了していること

### 実行方法

```bash
/discovery-session             # 通常モード（3セッション）
/discovery-session --quick     # 軽量モード（30分）
```

### どの深さでやるか

| モード | セッション数 | 所要時間 | 用途 |
|--------|------------|---------|------|
| 通常 | 3セッション | 3-4時間 | 新規プロジェクト、複雑なドメイン |
| `--quick` | 1セッション | 30分 | 小規模機能追加、シンプルなドメイン |

**どちらも必須。「やらない」ではなく「どの深さでやるか」の選択。**

### 出力

- アクター一覧
- 集約候補
- コマンド/イベント候補
- リードモデル候補
- ビジネスルール候補
- 申し送りレポート（`docs/.context/phase05-handoff.md`）

---

## Phase 1: イベントストーミング

### 目的

- ドメインエキスパートとの対話を通じてビジネスの全体像を把握
- 集約・コマンド・イベント・リードモデルの関係を明確化
- Mermaid形式で叩き台を生成 → レビュー後Miroに転記

### 前提条件

- Phase 0.5（`/discovery-session`）が完了していること（必須）
- `--no-discovery` で明示的にオプトアウト可能（非推奨）

### 実行方法

```bash
/event-storming コアコンテキスト                   # デフォルト（ディスカバリー連携）
/event-storming サポートコンテキスト
/event-storming コアコンテキスト --no-discovery     # ディスカバリーなし（非推奨）
```

### 対話フロー

```
User: ユーザーを管理したい

AI: イベントストーミングの叩き台を作成します。

    ユーザーに対してどのような操作が必要ですか？
    （例: 登録、更新、削除、ステータス変更など）

User: 登録、情報更新、退会

AI: 以下のフローで合っていますか？

    ■ ユーザー集約

    [登録フロー]
    管理者 →発行→ ユーザーを登録する →処理→ ユーザー →発生→ ユーザーが登録された →更新→ ユーザー一覧

    [更新フロー]
    管理者 →発行→ ユーザーを更新する →処理→ ユーザー →発生→ ユーザーが更新された →更新→ ユーザー一覧

    [退会フロー]
    管理者 →発行→ ユーザーを退会させる →処理→ ユーザー →発生→ ユーザーが退会した →更新→ ユーザー一覧

    他に必要な操作はありますか？
```

### 成果物

| 成果物 | 内容 |
|--------|------|
| Mermaid ES図 | `20_ドメイン/イベントストーミング/{context}.md` |
| Miro転記後 | Source of Truth として管理 |

### Miroへの転記

レビュー後、人間がMiroに配置:

- 付箋の色でタイプを表現
- フレームでコンテキスト境界を表現
- 矢印（コネクタ）で関係性を表現

詳細: [Mermaid記法ガイド](./Mermaid記法ガイド.md)

---

## Phase 2: ドメインモデリング

### 目的

- イベントストーミングで特定した集約の内部構造を定義
- 値オブジェクト、状態遷移、不変条件を明確化

### 実行方法

```bash
/domain-modeling ユーザー
/domain-modeling 注文 --context 販売コンテキスト
/domain-modeling ユーザー --minimal  # Must質問のみ（短時間版）
```

| モード | 質問数 | 用途 |
|-------|-------|------|
| 通常 | 30問 | 完全なドメインモデル |
| `--minimal` | 12問 | 最小限のドメインモデル |

### 実行フロー

```
┌─────────────────────────────────────────────────────────────────┐
│  Step 1: 構造取得                                               │
│    Miro（または ES Markdown）から集約・コマンド・イベントを取得 │
│                                                                 │
│  Step 2: Must質問（12問）                                       │
│    構造、状態遷移、不変条件、コマンド、クエリ                   │
│                                                                 │
│  Step 3: Should質問（10問）- 任意                               │
│    実装品質を向上させる追加質問                                 │
│                                                                 │
│  Step 4: ドメインモデル生成                                     │
│    Markdown + Mermaid 形式でドキュメント作成                    │
└─────────────────────────────────────────────────────────────────┘
```

### 成果物構成

| セクション | 内容 |
|-----------|------|
| 構造図 | Mermaidクラス図（集約、値オブジェクト、関連） |
| 状態遷移 | Mermaid stateDiagram + 遷移ルール表 |
| コマンド | 入力項目、制約、事前条件、発行イベント |
| イベント | ペイロード定義 |
| クエリ | 表示カラム、検索条件、権限 |
| 不変条件 | ビジネスルールの一覧 |
| Saga連携 | シーケンス図（集約間連携がある場合） |

---

## Phase 3: 詳細設計

### 目的

- ドメインモデルを元に実装可能な詳細設計を生成
- API、データベース、画面それぞれの設計を作成

### 実行方法

個別に実行するか、並列実行ガイドに従って複数集約を同時に処理できます。
※ 並列実行: `skills/shared/parallel-execution-guide.md` 参照

### 個別実行

#### API設計

```bash
/api-design ユーザー
/api-design ユーザー --format openapi  # OpenAPI Spec出力
```

**出力内容:**
- エンドポイント一覧
- リクエスト/レスポンス定義
- エラーコード
- 認証・認可
- 実装チェックリスト

#### データベース設計

```bash
/db-design ユーザー
/db-design ユーザー --format sql  # DDL出力
```

**出力内容:**
- テーブル定義
- インデックス
- 制約
- ER図
- 実装チェックリスト

#### 画面設計

```bash
/screen-design ユーザー一覧
/screen-design ユーザー詳細
/screen-design ユーザー登録
```

**出力内容:**
- 画面レイアウト（ワイヤーフレーム）
- コンポーネント構成
- 状態管理
- API連携
- 実装チェックリスト

---

## Phase 4: 実装

### 目的

- Miro + Markdown を参照してコード生成
- 不明点はAIが質問し、回答をMarkdownに追記

### スキャフォールド生成

実装開始前に `/scaffold` でプロジェクト構成を生成:

```bash
/scaffold                     # 対話形式でパターン選択
/scaffold --pattern standard      # JOOQベースの軽量CQRS（推奨）
/scaffold --pattern es        # Axon Frameworkベースのイベントソーシング
```

**パターン選択の指針:**

| パターン | 適したケース |
|---------|-------------|
| `cqrs` | シンプルなCRUD、パフォーマンス重視、監査要件なし |
| `es` | 監査証跡が必要、複雑なドメインロジック、イベント駆動 |

### 情報の統合

```
[Miro から取得]（miro-connector MCP使用）
- コンテキスト構造
- 集約・コマンド・イベントの関係
- Saga（コンテキスト間連携）

[Markdown から取得]
- 構造図（エンティティ、値オブジェクト）
- 状態遷移とガード条件
- コマンドのフィールド定義
- バリデーションルール
- 不変条件
```

---

## 継続開発: 同期フロー

### 要件追加時

```
1. Miro編集
   - 新しいコマンド/イベントを追加
   - 関係性を矢印で接続

2. 同期実行
   /sync                           # 全体チェック
   /domain-modeling ユーザー --sync  # 個別同期

3. AIが差分を検出
   AI: Miroに新しいコマンド「パスワードを変更する」が追加されました
       ドメインモデルを更新しますか？

4. 対話で詳細確定
   AI: パスワードの制約を教えてください
   User: 8文字以上、英数字混在

5. ドキュメント更新
   → Markdown自動更新

6. コード更新
   → 差分コード生成（将来: PR自動作成）
```

### 同期の方向

```
Miro → Markdown → Code（下流方向）

※ Miroが Source of Truth
※ コードからの逆方向同期は対象外
```

---

## 品質ゲート

各 Phase の出力は、次の Phase に進む前に品質チェックを通過する必要があります。

| Phase | チェック内容 | チェックリスト |
|-------|------------|-------------|
| Phase 1 | ES図の完全性 | `skills/event-storming/references/quality-checklist.md` |
| Phase 2 | モデルの品質 | `skills/domain-modeling/references/quality-checklist.md` |
| Phase 3 (API) | API設計の品質 | `skills/api-design/references/quality-checklist.md` |
| Phase 3 (DB) | DB設計の品質 | `skills/db-design/references/quality-checklist.md` |
| Phase 3 (画面) | 画面設計の品質 | `skills/screen-design/references/quality-checklist.md` |
| Phase 3 (統合) | スキル間整合性 | `skills/shared/references/consistency-checklist.md` |
| Phase 3.5 | コンテキスト間連携の品質 | `skills/cross-context-design/references/quality-checklist.md` |

**チェック結果:**
- 全項目OK → 次の Phase に進む
- 不足あり → ユーザーに提示し、修正 or 未確定として記録

---

## 申し送りレポート

Phase 間の文脈をファイルで保持し、コンパクション（会話の圧縮）に依存しない設計です。

### 出力先

`docs/.context/` ディレクトリに Phase ごとのファイルとして出力:

| Phase | ファイル | 含む情報 |
|-------|---------|---------|
| Phase 0 | `phase0-handoff.md` | プロジェクト種別、主要ドメイン、技術制約、ディスカバリー推奨モード |
| Phase 0.5 | `phase05-handoff.md` | 集約候補（確信度付き）、未解決論点、重要発言 |
| Phase 1 | `phase1-handoff.md` | 集約一覧、主要フロー要約、境界が曖昧な箇所 |
| Phase 2 | `phase2-handoff.md` | モデル要約、設計判断と理由、実装時注意点 |
| Phase 3.5 | `phase35-handoff.md` | 連携パターン決定事項、未確定事項、実装時注意点 |

### フォーマット

共通フォーマットは `skills/shared/handoff-format.md` を参照。

---

## 進捗管理

`docs/.context/workflow-state.yaml` でワークフロー全体の進捗を一元管理します。

- 各スキル実行時に自動更新される
- reader 系 Agent が前提 Phase の完了を確認する
- 手動編集も可能（進捗の巻き戻しなど）

詳細は `skills/shared/workflow-state-updater.md` を参照。

---

## ベストプラクティス

### 1. 小さく始める

```
✓ 最初は主要な集約（2〜3個）に絞る
✓ Phase 2 は最小限（構造図、状態遷移）から開始
✓ 実装しながら詳細を蓄積
```

### 2. Miro を常に最新に保つ

```
要件変更 → まずMiroを更新 → その後Markdown/Code
```

### 3. 二層構造を意識

```
Miro（What）:
  - 何があるか
  - 集約、コマンド、イベント、リードモデルの関係

Markdown（How）:
  - どう動くか
  - 構造、状態遷移、不変条件、詳細定義
```

### 4. 同期を習慣化

```
定期的に /sync で整合性チェック
→ ドキュメントの陳腐化を防ぐ
```

### 5. ループ検出を活用する

```
同じトピックで3回質問が繰り返されたら自動的に未確定として記録
→ 完璧を求めて止まるより、未確定を明示して前に進む
→ 未確定事項は申し送りレポートで次 Phase に伝達される
```

### 6. 未確定事項を管理する

```
未確定事項は docs/.context/ の申し送りレポートに記録される
→ 後続 Phase で情報が揃った時点で確定に変更
→ workflow-state.yaml の pending_items でも追跡可能
```

---

## 関連ドキュメント

### ガイド
- [ドメインモデリングガイド](./ドメインモデリングガイド.md) - Markdown + Mermaid の書き方
- [Mermaid記法ガイド](./Mermaid記法ガイド.md) - ES図の記法

### スキル定義
- [ディスカバリーセッション](../../../skills/discovery-session/SKILL.md)
- [イベントストーミング](../../../skills/event-storming/SKILL.md)
- [ドメインモデリング](../../../skills/domain-modeling/SKILL.md)
- [API設計](../../../skills/api-design/SKILL.md)
- [データベース設計](../../../skills/db-design/SKILL.md)
- [画面設計](../../../skills/screen-design/SKILL.md)
- [並列設計実行ガイド](../../../skills/shared/parallel-execution-guide.md)
- [コンテキスト間連携設計](../../../skills/cross-context-design/SKILL.md)
- [設計レビュー](../../../skills/design-review/SKILL.md)
- [工数見積もり](../../../skills/estimate/SKILL.md)
- [Backlog課題作成](../../../skills/create-backlog-issue/SKILL.md)
- [スキャフォールド](../../../skills/scaffold/SKILL.md)

### 成果物
- [イベントストーミング](../../20_ドメイン/イベントストーミング/) - ES図
