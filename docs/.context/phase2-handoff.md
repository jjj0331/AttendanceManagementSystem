# Phase 2 → Phase 3 申し送り

## 完了サマリー

4コンテキストの代表的な4集約をドメインモデリングした。勤怠記録（最複雑、コマンド6・イベント7）、残業申請（申請パターンの代表）、有給残高（休暇付与を統合）、月次締め（冪等性要件）。

## 次のPhaseへの入力

### モデル要約

| 集約 | コンテキスト | コマンド | イベント | 不変条件 | VO数 |
|------|-------------|---------|---------|---------|------|
| 勤怠記録 | 勤怠管理 | 6 | 7 | 4 | 10 |
| 残業申請 | 申請承認 | 4 | 4 | 3 | 4 |
| 有給残高 | 休暇管理 | 3+1 | 3+1 | 4 | 9 |
| 月次締め | 月次処理 | 3 | 3 | 3 | 4 |

### 設計判断と理由

| 判断 | 理由 |
|------|------|
| 休暇付与集約を有給残高集約に統合 | 残日数の一元管理と年5日取得義務チェックの簡潔化 |
| 打刻ログはイミュータブル、勤怠サマリーはミュータブル | 打刻の監査ログ要件とパフォーマンスのバランス |
| 申請系集約は共通パターン（DRAFT→SUBMITTED→APPROVED/REJECTED） | 3つの申請集約で状態遷移を統一 |
| 月次締め処理に冪等性を要求 | 中断復旧の信頼性確保 |

## 未確定事項

- [ ] 通知コンテキストの詳細設計（Phase 1 から継続、Phase 3 で通知チャネル・テンプレートを決定）
- [ ] 既存給与システムのCSVフォーマット仕様（Phase 0 から継続、MVP は汎用フォーマットで先行）

## 注意点

- 勤怠記録の**勤務時間計算**が最も複雑なドメインロジック（3勤務パターン×5種の割増率）。ドメインサービスとして切り出すことを推奨
- 有給残高の**FIFO消化**はLeaveGrantのExpiryDate順でソートして消化する実装が必要
- 残業申請の36協定チェックは**勤怠記録の累計時間を参照**する。コンテキスト間のクエリが発生するため、API設計時にエンドポイントを検討
- 月次本締め→勤怠記録FINALIZE→CSVエクスポートの**Saga**はトランザクション境界に注意
