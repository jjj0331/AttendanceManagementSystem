# Phase 3 → Phase 4 申し送り

## 完了サマリー

4集約の設計仕様3種（API/DB/画面）を全て生成した。合計17ファイル（API 4 + DB 4 + 画面 9）。画面設計では勤怠ダッシュボード・有給取得状況ダッシュボードの2種を含む（改善#4の検証）。整合性チェック6項目×4集約 = 24チェック全てOK（月次締めのAPI名前フィールド不足3件は修正済み）。

## 次のPhaseへの入力

### 生成ファイル

#### 勤怠記録（勤怠管理コンテキスト）

| 種別 | ファイル | 概要 |
|------|---------|------|
| API設計 | docs/30_設計/API/エンドポイント/勤怠記録.md | 10エンドポイント（コマンド7+クエリ3）、JWT認証、RFC 7807エラー |
| DB設計 | docs/30_設計/データベース/勤怠記録.md | 3テーブル（attendance_records + clock_entries + clock_corrections）、イミュータブル打刻ログ |
| 画面（一覧） | docs/30_設計/画面/screens/勤怠一覧.md | テーブル形式、3条件検索、ステータスバッジ4色 |
| 画面（詳細） | docs/30_設計/画面/screens/勤怠詳細.md | 打刻タイムライン、勤務時間サマリー、残業内訳、修正申請モーダル |
| 画面（ダッシュボード） | docs/30_設計/画面/screens/勤怠ダッシュボード.md | KPI4指標、チャート2種、直近5件、5分自動更新 |

#### 残業申請（申請承認コンテキスト）

| 種別 | ファイル | 概要 |
|------|---------|------|
| API設計 | docs/30_設計/API/エンドポイント/残業申請.md | 6エンドポイント（コマンド4+クエリ2）、36協定チェック、事後申請ルール |
| DB設計 | docs/30_設計/データベース/残業申請.md | 2テーブル（overtime_requests + overtime_request_events）、イミュータブルイベント履歴 |
| 画面（一覧） | docs/30_設計/画面/screens/残業申請一覧.md | テーブル形式、3条件検索、ステータスバッジ4色（DRAFT/SUBMITTED/APPROVED/REJECTED） |
| 画面（詳細） | docs/30_設計/画面/screens/残業申請詳細.md | 申請内容、36協定状況（プログレスバー）、承認フロータイムライン、却下モーダル |

#### 有給残高（休暇管理コンテキスト）

| 種別 | ファイル | 概要 |
|------|---------|------|
| API設計 | docs/30_設計/API/エンドポイント/有給残高.md | 6エンドポイント（コマンド4+クエリ2）、FIFO消化、時効消滅 |
| DB設計 | docs/30_設計/データベース/有給残高.md | 3テーブル（leave_balances + leave_grants + leave_consumptions）、付与・消化イミュータブル |
| 画面（残日数照会） | docs/30_設計/画面/screens/有給残日数照会.md | サマリーカード5種、付与明細テーブル、時効予定ハイライト |
| 画面（ダッシュボード） | docs/30_設計/画面/screens/有給取得状況ダッシュボード.md | KPI4指標、従業員別テーブル、5分自動更新 |

#### 月次締め（月次処理コンテキスト）

| 種別 | ファイル | 概要 |
|------|---------|------|
| API設計 | docs/30_設計/API/エンドポイント/月次締め.md | 6エンドポイント（コマンド3+クエリ3）、冪等性、Saga起動 |
| DB設計 | docs/30_設計/データベース/月次締め.md | 2テーブル（monthly_closings + monthly_closing_events）、イミュータブルイベント履歴 |
| 画面（一覧） | docs/30_設計/画面/screens/月次締め一覧.md | 年度別12ヶ月グリッド、仮締め/本締めアクション、確認ダイアログ |
| 画面（詳細） | docs/30_設計/画面/screens/月次締め詳細.md | 仮締め結果、エクスポート状況、処理履歴タイムライン |

### 設計判断と理由

| 判断 | 理由 |
|------|------|
| 打刻ログ（clock_entries）はイミュータブル | 監査ログ要件。UPDATE/DELETEをトリガーでブロック |
| 勤怠サマリー（WorkDuration等）はミュータブル | パフォーマンスのため計算結果をattendance_recordsに直接保持 |
| 申請・締めのイベント履歴はイミュータブル追記 | 承認ワークフロー・締め処理の追跡・監査を可能にする |
| ダッシュボードは5分ポーリング自動更新 | WebSocket不要でシンプル。Page Visibility APIでタブ非表示時停止 |
| APIはRESTful標準パターン | アクション系はPOST `/{id}/actions/{action}` で統一 |
| 36協定チェックは承認時に実行 | 申請時は閾値接近の警告のみ、承認時にブロック判定 |
| FIFO消化（有給） | ExpiryDate順で時効が近い付与分から消化 |
| 月次締めの冪等性 | 仮締め再実行可、本締め中断時も再実行で完了 |
| 月次締めにfinal_closed_byカラムを追加 | 仮締めと本締めを別人が実行する場合に備え、実行者を分離管理 |

### 整合性チェック結果

#### 勤怠記録

| チェック項目 | 結果 |
|-------------|------|
| APIリクエストフィールド ⊆ DBカラム | ✅ OK |
| APIレスポンスフィールド ⊆ DBカラム + 計算フィールド | ✅ OK |
| 画面入力項目 = APIリクエストフィールド | ✅ OK |
| 画面表示項目 ⊆ APIレスポンスフィールド | ✅ OK |
| 画面操作 = APIエンドポイント（コマンド系） | ✅ OK |
| 画面一覧表示 = APIエンドポイント（クエリ系） | ✅ OK |

#### 残業申請

| チェック項目 | 結果 |
|-------------|------|
| APIリクエストフィールド ⊆ DBカラム | ✅ OK |
| APIレスポンスフィールド ⊆ DBカラム + 計算フィールド | ✅ OK |
| 画面入力項目 = APIリクエストフィールド | ✅ OK |
| 画面表示項目 ⊆ APIレスポンスフィールド | ✅ OK |
| 画面操作 = APIエンドポイント（コマンド系） | ✅ OK |
| 画面一覧表示 = APIエンドポイント（クエリ系） | ✅ OK |

#### 有給残高

| チェック項目 | 結果 |
|-------------|------|
| APIリクエストフィールド ⊆ DBカラム | ✅ OK |
| APIレスポンスフィールド ⊆ DBカラム + 計算フィールド | ✅ OK |
| 画面入力項目 = APIリクエストフィールド | ✅ OK |
| 画面表示項目 ⊆ APIレスポンスフィールド | ✅ OK |
| 画面操作 = APIエンドポイント（コマンド系） | ✅ OK（参照画面のみ、設計意図通り） |
| 画面一覧表示 = APIエンドポイント（クエリ系） | ✅ OK |

#### 月次締め

| チェック項目 | 結果 |
|-------------|------|
| APIリクエストフィールド ⊆ DBカラム | ✅ OK |
| APIレスポンスフィールド ⊆ DBカラム + 計算フィールド | ✅ OK（closedByName/finalClosedByName/actorName追加で修正済み） |
| 画面入力項目 = APIリクエストフィールド | ✅ OK |
| 画面表示項目 ⊆ APIレスポンスフィールド | ✅ OK（closedByName/finalClosedByName/actorName追加で修正済み） |
| 画面操作 = APIエンドポイント（コマンド系） | ✅ OK |
| 画面一覧表示 = APIエンドポイント（クエリ系） | ✅ OK |

## 未確定事項

- [ ] 既存給与システムのCSVフォーマット仕様（Phase 0 から継続、汎用フォーマットで先行）
- [ ] 通知コンテキストの詳細設計（Phase 1 から継続）
- [ ] ダッシュボードのリアルタイム要件の高度化（WebSocket/SSE化は v2 で検討）

## 注意点

- clock_correctionsテーブルの承認ステータス更新はイミュータブル設計とのトレードオフあり。承認フロー用にUPDATEを許可するか、別テーブル分離を検討
- employee_id, shift_pattern_id のFK参照先はモジュール境界外のため、DDLにFK制約未設定。インフラ構成確定後に追加判断
- ダッシュボード（勤怠・有給）のKPI計算は集約横断クエリが必要。専用のRead Model（マテリアライズドビュー）の導入を推奨
- 36協定チェックは勤怠記録の累計時間を参照するため、コンテキスト間クエリが発生。APIゲートウェイでの集約か、ドメインサービスでの実装を検討
- 月次本締め→勤怠記録FINALIZE→CSVエクスポートのSagaはトランザクション境界に注意。中断復旧の冪等性を実装すること
- 有給のFIFO消化はExpiryDate順のソートが必要。並列消化時の楽観的ロックに注意
