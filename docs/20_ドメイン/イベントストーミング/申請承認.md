# イベントストーミング図: 申請承認

> **更新日**: 2026-02-08
> **種別**: コアドメイン

---

## 全体図

```mermaid
flowchart TB
    subgraph 申請承認
        subgraph 残業申請集約
            A_E1((従業員)):::actor
            A_M1((管理職)):::actor
            C_OT1[残業を申請する]:::command
            C_OT2[残業申請を<br/>承認する]:::command
            C_OT3[残業申請を<br/>却下する]:::command
            C_OT4[残業申請を<br/>再申請する]:::command
            AG_OT{{残業申請}}:::aggregate
            E_OT1>残業が申請された]:::event
            E_OT2>残業申請が<br/>承認された]:::event
            E_OT3>残業申請が<br/>却下された]:::event
            E_OT4>残業申請が<br/>再申請された]:::event
            P_OT1[/未申請残業検知<br/>退勤打刻が所定終業後<br/>かつ申請なし/]:::policy
            RM_OT1[(残業申請一覧)]:::readmodel
            RM_OT2[(承認待ち<br/>残業申請一覧)]:::readmodel
        end
        subgraph 休暇申請集約
            C_LV1[休暇を申請する]:::command
            C_LV2[休暇申請を<br/>承認する]:::command
            C_LV3[休暇申請を<br/>却下する]:::command
            C_LV4[休暇申請を<br/>取り消す]:::command
            AG_LV{{休暇申請}}:::aggregate
            E_LV1>休暇が申請された]:::event
            E_LV2>休暇申請が<br/>承認された]:::event
            E_LV3>休暇申請が<br/>却下された]:::event
            E_LV4>休暇申請が<br/>取り消された]:::event
            RM_LV1[(休暇申請一覧)]:::readmodel
            RM_LV2[(承認待ち<br/>休暇申請一覧)]:::readmodel
        end
        subgraph 打刻修正申請集約
            A_HR1((人事担当者)):::actor
            C_FX1[打刻修正を<br/>申請する]:::command
            C_FX2[打刻修正を<br/>承認する]:::command
            C_FX3[打刻修正を<br/>却下する]:::command
            C_FX4[打刻修正を<br/>再申請する]:::command
            C_FX5[打刻修正を<br/>人事承認する]:::command
            AG_FX{{打刻修正申請}}:::aggregate
            E_FX1>打刻修正が<br/>申請された]:::event
            E_FX2>打刻修正が<br/>承認された]:::event
            E_FX3>打刻修正が<br/>却下された]:::event
            E_FX4>打刻修正が<br/>再申請された]:::event
            E_FX5>打刻修正が<br/>人事承認された]:::event
            P_FX1[/仮締め後<br/>人事承認エスカレーション<br/>上長承認後に人事承認を追加/]:::policy
            RM_FX1[(打刻修正<br/>申請一覧)]:::readmodel
            RM_FX2[(承認待ち<br/>打刻修正一覧)]:::readmodel
        end
    end

    A_E1 -->|発行| C_OT1
    A_E1 -->|発行| C_OT4
    A_M1 -->|発行| C_OT2
    A_M1 -->|発行| C_OT3
    C_OT1 -->|処理| AG_OT
    C_OT2 -->|処理| AG_OT
    C_OT3 -->|処理| AG_OT
    C_OT4 -->|処理| AG_OT
    AG_OT -->|発生| E_OT1
    AG_OT -->|発生| E_OT2
    AG_OT -->|発生| E_OT3
    AG_OT -->|発生| E_OT4
    E_OT1 -->|更新| RM_OT1
    E_OT1 -->|更新| RM_OT2
    E_OT2 -->|更新| RM_OT1
    E_OT2 -->|更新| RM_OT2
    E_OT3 -->|更新| RM_OT1
    E_OT3 -->|更新| RM_OT2
    E_OT4 -->|更新| RM_OT1
    E_OT4 -->|更新| RM_OT2

    A_E1 -->|発行| C_LV1
    A_E1 -->|発行| C_LV4
    A_M1 -->|発行| C_LV2
    A_M1 -->|発行| C_LV3
    C_LV1 -->|処理| AG_LV
    C_LV2 -->|処理| AG_LV
    C_LV3 -->|処理| AG_LV
    C_LV4 -->|処理| AG_LV
    AG_LV -->|発生| E_LV1
    AG_LV -->|発生| E_LV2
    AG_LV -->|発生| E_LV3
    AG_LV -->|発生| E_LV4
    E_LV1 -->|更新| RM_LV1
    E_LV1 -->|更新| RM_LV2
    E_LV2 -->|更新| RM_LV1
    E_LV2 -->|更新| RM_LV2
    E_LV3 -->|更新| RM_LV1
    E_LV3 -->|更新| RM_LV2
    E_LV4 -->|更新| RM_LV1

    A_E1 -->|発行| C_FX1
    A_E1 -->|発行| C_FX4
    A_M1 -->|発行| C_FX2
    A_M1 -->|発行| C_FX3
    A_HR1 -->|発行| C_FX5
    C_FX1 -->|処理| AG_FX
    C_FX2 -->|処理| AG_FX
    C_FX3 -->|処理| AG_FX
    C_FX4 -->|処理| AG_FX
    C_FX5 -->|処理| AG_FX
    AG_FX -->|発生| E_FX1
    AG_FX -->|発生| E_FX2
    AG_FX -->|発生| E_FX3
    AG_FX -->|発生| E_FX4
    AG_FX -->|発生| E_FX5
    E_FX2 -.->|仮締め後| P_FX1
    P_FX1 -.->|人事承認要求| C_FX5
    E_FX1 -->|更新| RM_FX1
    E_FX1 -->|更新| RM_FX2
    E_FX2 -->|更新| RM_FX1
    E_FX3 -->|更新| RM_FX1
    E_FX3 -->|更新| RM_FX2
    E_FX4 -->|更新| RM_FX1
    E_FX4 -->|更新| RM_FX2
    E_FX5 -->|更新| RM_FX1
    E_FX5 -->|更新| RM_FX2

    classDef actor fill:#F3F575,stroke:#333
    classDef command fill:#90CAF9,stroke:#333
    classDef aggregate fill:#FFF59D,stroke:#333
    classDef event fill:#FFB570,stroke:#333
    classDef readmodel fill:#CCFF99,stroke:#333
    classDef policy fill:#B39DDB,stroke:#333
```

---

## 凡例

```mermaid
flowchart LR
    A((アクター)):::actor
    C[コマンド]:::command
    AG{{集約}}:::aggregate
    E>イベント]:::event
    RM[(リードモデル)]:::readmodel
    P[/ポリシー/]:::policy

    classDef actor fill:#F3F575,stroke:#333
    classDef command fill:#90CAF9,stroke:#333
    classDef aggregate fill:#FFF59D,stroke:#333
    classDef event fill:#FFB570,stroke:#333
    classDef readmodel fill:#CCFF99,stroke:#333
    classDef policy fill:#B39DDB,stroke:#333
```

---

## イベント → ReadModel マッピング

| イベント | ReadModel |
|----------|-----------|
| 残業が申請された | 残業申請一覧, 承認待ち残業申請一覧 |
| 残業申請が承認された | 残業申請一覧, 承認待ち残業申請一覧 |
| 残業申請が却下された | 残業申請一覧, 承認待ち残業申請一覧 |
| 残業申請が再申請された | 残業申請一覧, 承認待ち残業申請一覧 |
| 休暇が申請された | 休暇申請一覧, 承認待ち休暇申請一覧 |
| 休暇申請が承認された | 休暇申請一覧, 承認待ち休暇申請一覧 |
| 休暇申請が却下された | 休暇申請一覧, 承認待ち休暇申請一覧 |
| 休暇申請が取り消された | 休暇申請一覧 |
| 打刻修正が申請された | 打刻修正申請一覧, 承認待ち打刻修正一覧 |
| 打刻修正が承認された | 打刻修正申請一覧 |
| 打刻修正が却下された | 打刻修正申請一覧, 承認待ち打刻修正一覧 |
| 打刻修正が再申請された | 打刻修正申請一覧, 承認待ち打刻修正一覧 |
| 打刻修正が人事承認された | 打刻修正申請一覧, 承認待ち打刻修正一覧 |

---

## 集約サマリー

### 残業申請集約

| 種別 | 名称 |
|------|------|
| コマンド | 残業を申請する, 残業申請を承認する, 残業申請を却下する, 残業申請を再申請する |
| イベント | 残業が申請された, 残業申請が承認された, 残業申請が却下された, 残業申請が再申請された |
| リードモデル | 残業申請一覧（従業員別）, 承認待ち残業申請一覧（管理職用） |
| ポリシー | 未申請残業検知（退勤打刻が所定終業後かつ申請なし → アラート送信） |

### 休暇申請集約

| 種別 | 名称 |
|------|------|
| コマンド | 休暇を申請する, 休暇申請を承認する, 休暇申請を却下する, 休暇申請を取り消す |
| イベント | 休暇が申請された, 休暇申請が承認された, 休暇申請が却下された, 休暇申請が取り消された |
| リードモデル | 休暇申請一覧（従業員別）, 承認待ち休暇申請一覧（管理職用） |

### 打刻修正申請集約

| 種別 | 名称 |
|------|------|
| コマンド | 打刻修正を申請する, 打刻修正を承認する, 打刻修正を却下する, 打刻修正を再申請する, 打刻修正を人事承認する |
| イベント | 打刻修正が申請された, 打刻修正が承認された, 打刻修正が却下された, 打刻修正が再申請された, 打刻修正が人事承認された |
| リードモデル | 打刻修正申請一覧（従業員別）, 承認待ち打刻修正一覧（管理職用） |
| ポリシー | 仮締め後人事承認エスカレーション（上長承認後に人事承認ステップを追加） |

<!-- 品質チェック結果
- [x] 全3集約にコマンド・イベント・リードモデルが定義されている
- [x] 申請→承認/却下の双方向フローがある（3集約とも）
- [x] 残業申請・打刻修正申請に再申請フローが含まれている
- [x] 休暇申請の取り消しフローが含まれている
- [x] 未申請残業検知ポリシーが定義されている
- [x] 仮締め後人事承認エスカレーションポリシーが定義されている
- [x] イベント→ReadModelマッピングが網羅的
-->
