# イベントストーミング図: 勤怠管理

> **更新日**: 2026-02-08
> **種別**: コアドメイン

---

## 全体図

```mermaid
flowchart TB
    subgraph 勤怠管理
        subgraph 勤怠記録集約
            A_EMP1((従業員)):::actor
            C_CIN[出勤打刻する]:::command
            C_COUT[退勤打刻する]:::command
            C_BIN[休憩開始する]:::command
            C_BOUT[休憩終了する]:::command
            C_FIX[打刻を修正する]:::command
            C_REG[勤務実績を<br/>登録する]:::command
            AG_ATT{{勤怠記録}}:::aggregate
            E_CIN>出勤が打刻された]:::event
            E_COUT>退勤が打刻された]:::event
            E_BIN>休憩が開始された]:::event
            E_BOUT>休憩が終了された]:::event
            E_CALC>勤務時間が<br/>計算された]:::event
            E_FIX>打刻が修正された]:::event
            E_REG>勤務実績が<br/>登録された]:::event
            RM_DAILY[(日次勤怠一覧)]:::readmodel
            RM_MONTHLY[(月次勤怠<br/>サマリー)]:::readmodel
            RM_DASH[(部門別勤怠<br/>ダッシュボード)]:::readmodel
            P_CALC[/退勤時<br/>勤務時間自動計算/]:::policy
            P_FORGOT[/打刻忘れ検知<br/>翌日9:00/]:::policy
        end
        subgraph シフト集約
            A_HR1((人事担当者)):::actor
            A_MGR1((管理職)):::actor
            C_DEF[シフトパターンを<br/>定義する]:::command
            C_ASSIGN[シフトを<br/>割り当てる]:::command
            C_CHG[シフトを<br/>変更する]:::command
            AG_SHIFT{{シフト}}:::aggregate
            E_DEF>シフトパターンが<br/>定義された]:::event
            E_ASSIGN>シフトが<br/>割り当てられた]:::event
            E_CHG>シフトが<br/>変更された]:::event
            RM_CAL[(シフト<br/>カレンダー)]:::readmodel
            RM_PAT[(シフトパターン<br/>一覧)]:::readmodel
            P_NOTIFY[/シフト割当・変更<br/>本人通知/]:::policy
        end
    end

    A_EMP1 -->|発行| C_CIN
    A_EMP1 -->|発行| C_COUT
    A_EMP1 -->|発行| C_BIN
    A_EMP1 -->|発行| C_BOUT
    A_EMP1 -->|発行| C_REG
    C_CIN -->|処理| AG_ATT
    C_COUT -->|処理| AG_ATT
    C_BIN -->|処理| AG_ATT
    C_BOUT -->|処理| AG_ATT
    C_FIX -->|処理| AG_ATT
    C_REG -->|処理| AG_ATT
    AG_ATT -->|発生| E_CIN
    AG_ATT -->|発生| E_COUT
    AG_ATT -->|発生| E_BIN
    AG_ATT -->|発生| E_BOUT
    AG_ATT -->|発生| E_CALC
    AG_ATT -->|発生| E_FIX
    AG_ATT -->|発生| E_REG
    E_COUT -->|トリガー| P_CALC
    E_CIN -.->|翌日未退勤| P_FORGOT
    E_CIN -->|更新| RM_DAILY
    E_COUT -->|更新| RM_DAILY
    E_CALC -->|更新| RM_MONTHLY
    E_CALC -->|更新| RM_DASH

    A_HR1 -->|発行| C_DEF
    A_MGR1 -->|発行| C_ASSIGN
    A_MGR1 -->|発行| C_CHG
    C_DEF -->|処理| AG_SHIFT
    C_ASSIGN -->|処理| AG_SHIFT
    C_CHG -->|処理| AG_SHIFT
    AG_SHIFT -->|発生| E_DEF
    AG_SHIFT -->|発生| E_ASSIGN
    AG_SHIFT -->|発生| E_CHG
    E_ASSIGN -->|更新| RM_CAL
    E_ASSIGN -->|トリガー| P_NOTIFY
    E_DEF -->|更新| RM_PAT
    E_CHG -->|更新| RM_CAL
    E_CHG -->|トリガー| P_NOTIFY

    classDef actor fill:#F3F575,stroke:#333
    classDef command fill:#90CAF9,stroke:#333
    classDef aggregate fill:#FFF59D,stroke:#333
    classDef event fill:#FFB570,stroke:#333
    classDef readmodel fill:#CCFF99,stroke:#333
    classDef policy fill:#B39DDB,stroke:#333
```

---

## 凡例

```mermaid
flowchart LR
    A((アクター)):::actor
    C[コマンド]:::command
    AG{{集約}}:::aggregate
    E>イベント]:::event
    RM[(リードモデル)]:::readmodel
    P[/ポリシー/]:::policy

    classDef actor fill:#F3F575,stroke:#333
    classDef command fill:#90CAF9,stroke:#333
    classDef aggregate fill:#FFF59D,stroke:#333
    classDef event fill:#FFB570,stroke:#333
    classDef readmodel fill:#CCFF99,stroke:#333
    classDef policy fill:#B39DDB,stroke:#333
```

---

## イベント → ReadModel マッピング

| イベント | ReadModel |
|----------|-----------|
| 出勤が打刻された | 日次勤怠一覧 |
| 退勤が打刻された | 日次勤怠一覧 |
| 勤務時間が計算された | 月次勤怠サマリー, 部門別勤怠ダッシュボード |
| 打刻が修正された | 日次勤怠一覧, 月次勤怠サマリー |
| 勤務実績が登録された | 日次勤怠一覧 |
| シフトパターンが定義された | シフトパターン一覧 |
| シフトが割り当てられた | シフトカレンダー |
| シフトが変更された | シフトカレンダー |

---

## 集約サマリー

### 勤怠記録集約

| 種別 | 名称 |
|------|------|
| コマンド | 出勤打刻する, 退勤打刻する, 休憩開始する, 休憩終了する, 打刻を修正する, 勤務実績を登録する |
| イベント | 出勤が打刻された, 退勤が打刻された, 休憩が開始された, 休憩が終了された, 勤務時間が計算された, 打刻が修正された, 勤務実績が登録された |
| リードモデル | 日次勤怠一覧, 月次勤怠サマリー, 部門別勤怠ダッシュボード |
| ポリシー | 退勤時勤務時間自動計算, 打刻忘れ検知（翌日9:00） |

### シフト集約

| 種別 | 名称 |
|------|------|
| コマンド | シフトパターンを定義する, シフトを割り当てる, シフトを変更する |
| イベント | シフトパターンが定義された, シフトが割り当てられた, シフトが変更された |
| リードモデル | シフトカレンダー, シフトパターン一覧 |
| ポリシー | シフト割当・変更時の本人通知 |

<!-- 品質チェック結果
- [x] 全集約にコマンド・イベント・リードモデルが定義されている
- [x] アクターが明示されている（従業員、管理職、人事担当者）
- [x] ポリシー（自動処理）が記載されている（3件: 退勤時計算, 打刻忘れ検知, シフト変更通知）
- [x] Mermaid記法のclassDef色定義が統一されている
- [x] イベント→ReadModelマッピングが網羅的
-->
