# イベントストーミング図: 休暇管理

> **更新日**: 2026-02-08
> **種別**: コアドメイン

---

## 全体図

```mermaid
flowchart TB
    subgraph 休暇管理
        subgraph 有給残高集約
            SYS1((システム)):::actor
            A_HR((人事担当者)):::actor
            AG_BAL{{有給残高}}:::aggregate
            C_GRANT[有給を付与する]:::command
            C_CONSUME[有給を消化する]:::command
            C_EXPIRE[時効消滅させる]:::command
            C_SP_GRANT[特別休暇を<br/>付与する]:::command
            C_SP_CONSUME[特別休暇を<br/>消化する]:::command
            E_GRANT>有給が付与された]:::event
            E_CONSUME>有給が消化された]:::event
            E_EXPIRE>有給が時効消滅した]:::event
            E_SP_GRANT>特別休暇が<br/>付与された]:::event
            E_SP_CONSUME>特別休暇が<br/>消化された]:::event
            RM_BAL[(有給残日数照会)]:::readmodel
            RM_PROG[(有給取得状況<br/>ダッシュボード<br/>年5日義務の進捗)]:::readmodel
            RM_SP[(特別休暇<br/>残日数照会<br/>種別ごと)]:::readmodel
            P_GRANT[/自動付与<br/>入社日起算<br/>6ヶ月後10日→最大20日/]:::policy
            P_EXPIRE[/時効処理<br/>付与日から2年で消滅<br/>30日前に通知/]:::policy
            P_CONSUME[/休暇承認時消化処理<br/>有給・特別休暇とも<br/>FIFO順で消化/]:::policy
            P_SP_NOTIFY[/特別休暇付与通知<br/>本人に通知送信/]:::policy
        end
    end

    P_GRANT -->|発行| C_GRANT
    P_EXPIRE -->|発行| C_EXPIRE
    P_CONSUME -->|発行| C_CONSUME
    P_CONSUME -->|発行| C_SP_CONSUME
    A_HR -->|発行| C_SP_GRANT
    C_GRANT -->|処理| AG_BAL
    C_CONSUME -->|処理| AG_BAL
    C_EXPIRE -->|処理| AG_BAL
    C_SP_GRANT -->|処理| AG_BAL
    C_SP_CONSUME -->|処理| AG_BAL
    AG_BAL -->|発生| E_GRANT
    AG_BAL -->|発生| E_CONSUME
    AG_BAL -->|発生| E_EXPIRE
    AG_BAL -->|発生| E_SP_GRANT
    AG_BAL -->|発生| E_SP_CONSUME
    E_GRANT -->|更新| RM_BAL
    E_CONSUME -->|更新| RM_BAL
    E_CONSUME -->|更新| RM_PROG
    E_EXPIRE -->|更新| RM_BAL
    E_SP_GRANT -->|更新| RM_SP
    E_SP_GRANT -->|トリガー| P_SP_NOTIFY
    E_SP_CONSUME -->|更新| RM_SP

    classDef actor fill:#F3F575,stroke:#333
    classDef command fill:#90CAF9,stroke:#333
    classDef aggregate fill:#FFF59D,stroke:#333
    classDef event fill:#FFB570,stroke:#333
    classDef readmodel fill:#CCFF99,stroke:#333
    classDef policy fill:#B39DDB,stroke:#333
```

---

## 凡例

```mermaid
flowchart LR
    A((アクター)):::actor
    C[コマンド]:::command
    AG{{集約}}:::aggregate
    E>イベント]:::event
    RM[(リードモデル)]:::readmodel
    P[/ポリシー/]:::policy

    classDef actor fill:#F3F575,stroke:#333
    classDef command fill:#90CAF9,stroke:#333
    classDef aggregate fill:#FFF59D,stroke:#333
    classDef event fill:#FFB570,stroke:#333
    classDef readmodel fill:#CCFF99,stroke:#333
    classDef policy fill:#B39DDB,stroke:#333
```

---

## イベント → ReadModel マッピング

| イベント | ReadModel |
|----------|-----------|
| 有給が付与された | 有給残日数照会 |
| 有給が消化された | 有給残日数照会, 有給取得状況ダッシュボード |
| 有給が時効消滅した | 有給残日数照会 |
| 特別休暇が付与された | 特別休暇残日数照会 |
| 特別休暇が消化された | 特別休暇残日数照会 |

---

## 集約サマリー

### 有給残高集約

| 種別 | 名称 |
|------|------|
| コマンド | 有給を付与する, 有給を消化する, 時効消滅させる, 特別休暇を付与する, 特別休暇を消化する |
| イベント | 有給が付与された, 有給が消化された, 有給が時効消滅した, 特別休暇が付与された, 特別休暇が消化された |
| リードモデル | 有給残日数照会（従業員別）, 有給取得状況ダッシュボード（年5日義務の進捗）, 特別休暇残日数照会（種別ごと） |
| ポリシー | 自動付与（入社日起算、6ヶ月後10日→最大20日）, 時効処理（付与日+2年、30日前通知）, 休暇承認時消化処理（FIFO）, 特別休暇付与通知 |

> **設計判断**: 旧「休暇付与集約」（コマンド1個のみ）を有給残高集約に統合。
> 特別休暇は規程で付与日数が定義済みのため、有給残高と同一ライフサイクルで管理する。

<!-- 品質チェック結果
- [x] 自動処理ポリシーが4件定義されている（付与・時効・消化・特別休暇通知）
- [x] リードモデルに年5日取得義務の進捗ダッシュボードがある
- [x] 特別休暇が有給残高集約に統合されている（設計判断記録あり）
- [x] システムアクターが自動処理の起点として明示
- [x] 人事担当者が特別休暇付与の起点として明示
- [x] イベント→ReadModelマッピングが網羅的
-->
