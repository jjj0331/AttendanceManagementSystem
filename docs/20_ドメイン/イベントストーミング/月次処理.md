# イベントストーミング図: 月次処理

> **更新日**: 2026-02-08
> **種別**: 支援ドメイン

---

## 全体図

```mermaid
flowchart TB
    subgraph 月次処理
        subgraph 月次締め集約
            A_HR((人事担当者)):::actor
            C_PRE[仮締めする]:::command
            C_FIN[本締めする]:::command
            C_EXP[給与データを<br/>エクスポートする]:::command
            AG_CLS{{月次締め}}:::aggregate
            E_PRE>月次が<br/>仮締めされた]:::event
            E_FIN>月次が<br/>本締めされた]:::event
            E_EXP>給与データが<br/>エクスポートされた]:::event
            RM_STAT[(月次締め状況<br/>ダッシュボード<br/>未打刻/未承認件数)]:::readmodel
            P_REM[/締め前リマインド<br/>月末3営業日前<br/>未承認申請の管理職に通知/]:::policy
            P_URG[/締め前督促<br/>月末1営業日前<br/>人事から管理職に督促/]:::policy
            P_FLEX[/フレックス月次清算不足検知<br/>仮締め時にフレックス勤務者の<br/>所定不足を検知→欠勤控除/]:::policy
        end
    end

    A_HR -->|発行| C_PRE
    A_HR -->|発行| C_FIN
    A_HR -->|発行| C_EXP
    C_PRE -->|処理| AG_CLS
    C_FIN -->|処理| AG_CLS
    C_EXP -->|処理| AG_CLS
    AG_CLS -->|発生| E_PRE
    AG_CLS -->|発生| E_FIN
    AG_CLS -->|発生| E_EXP
    E_PRE -->|更新| RM_STAT
    E_PRE -->|トリガー| P_FLEX
    E_FIN -->|更新| RM_STAT
    E_EXP -->|更新| RM_STAT

    classDef actor fill:#F3F575,stroke:#333
    classDef command fill:#90CAF9,stroke:#333
    classDef aggregate fill:#FFF59D,stroke:#333
    classDef event fill:#FFB570,stroke:#333
    classDef readmodel fill:#CCFF99,stroke:#333
    classDef policy fill:#B39DDB,stroke:#333
```

---

## 凡例

```mermaid
flowchart LR
    A((アクター)):::actor
    C[コマンド]:::command
    AG{{集約}}:::aggregate
    E>イベント]:::event
    RM[(リードモデル)]:::readmodel
    P[/ポリシー/]:::policy

    classDef actor fill:#F3F575,stroke:#333
    classDef command fill:#90CAF9,stroke:#333
    classDef aggregate fill:#FFF59D,stroke:#333
    classDef event fill:#FFB570,stroke:#333
    classDef readmodel fill:#CCFF99,stroke:#333
    classDef policy fill:#B39DDB,stroke:#333
```

---

## イベント → ReadModel マッピング

| イベント | ReadModel |
|----------|-----------|
| 月次が仮締めされた | 月次締め状況ダッシュボード |
| 月次が本締めされた | 月次締め状況ダッシュボード |
| 給与データがエクスポートされた | 月次締め状況ダッシュボード |

---

## 集約サマリー

### 月次締め集約

| 種別 | 名称 |
|------|------|
| コマンド | 仮締めする, 本締めする, 給与データをエクスポートする |
| イベント | 月次が仮締めされた, 月次が本締めされた, 給与データがエクスポートされた |
| リードモデル | 月次締め状況ダッシュボード（未打刻/未承認件数） |
| ポリシー | 締め前リマインド（月末3営業日前、未承認申請の管理職に通知）, 締め前督促（月末1営業日前、人事から管理職に督促）, フレックス月次清算不足検知（仮締め時→欠勤控除） |

<!-- 品質チェック結果
- [x] 仮締め→本締めの2段階フローが定義
- [x] 給与エクスポートがコマンド/イベントで明示
- [x] リマインド・督促ポリシーが定義（3営業日前/1営業日前）
- [x] フレックス月次清算不足検知ポリシーが定義
- [x] 月次締め状況ダッシュボードがリードモデルにある
- [x] イベント→ReadModelマッピングが網羅的
-->
