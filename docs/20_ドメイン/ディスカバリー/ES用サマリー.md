# ES用サマリー

> **生成日**: 2026-02-07
> **最終更新**: 2026-02-08（イベントストーミング設計判断を反映）
> **ソース**: ディスカバリーセッション（Session 1-3）

---

## アクター

| アクター | 役割 | 主な操作 |
|---------|------|---------|
| 一般従業員 | 日常の打刻・申請 | 打刻する, 残業申請する, 休暇申請する, 打刻修正申請する |
| 管理職（上長） | 部下の管理・承認 | 申請を承認する, 申請を却下する, 勤怠状況を確認する |
| 人事担当者 | 全社勤怠管理 | 月次仮締めする, 月次本締めする, 有給を付与する, 特別休暇を付与する, 是正指示する, 打刻修正を人事承認する |
| 給与担当者 | 給与計算 | 確定データを受領する |

---

## コンテキスト × 集約

| コンテキスト | 種別 | 集約 |
|-------------|------|------|
| 勤怠管理 | コア | 勤怠記録, シフト |
| 申請承認 | コア | 残業申請, 休暇申請, 打刻修正申請 |
| 休暇管理 | コア | 有給残高 |
| 月次処理 | 支援 | 月次締め |
| 通知 | 汎用 | 通知 |

> **設計判断**: 旧「休暇付与」集約（コマンド1個のみ）は「有給残高」集約に統合。
> 特別休暇は規程で付与日数が定義済みのため、有給残高と同一ライフサイクルで管理する。
> 集約数: 9 → **8**

---

## 集約別 コマンド・イベント

### 勤怠記録集約

**コンテキスト**: 勤怠管理

| コマンド | イベント | アクター |
|---------|---------|---------|
| 出勤打刻する | 出勤が打刻された | 従業員 |
| 退勤打刻する | 退勤が打刻された | 従業員 |
| 休憩開始する | 休憩が開始された | 従業員 |
| 休憩終了する | 休憩が終了された | 従業員 |
| 勤務時間を計算する | 勤務時間が計算された | システム |
| 打刻を修正する | 打刻が修正された | 従業員（承認後） |
| 勤務実績を登録する | 勤務実績が登録された | 従業員（直行直帰等） |

**リードモデル**:
- 日次勤怠一覧（従業員別）
- 月次勤怠サマリー（従業員別）
- 部門別勤怠ダッシュボード

**ポリシー（自動処理）**:
- 退勤打刻時に残業時間を自動計算: `退勤が打刻された` → `勤務時間を計算する`
- 打刻忘れ検知: 翌日9:00に前日の退勤打刻がない場合 → `打刻忘れ通知を送信する`

---

### シフト集約

**コンテキスト**: 勤怠管理

| コマンド | イベント | アクター |
|---------|---------|---------|
| シフトパターンを定義する | シフトパターンが定義された | 人事担当者 |
| シフトを割り当てる | シフトが割り当てられた | 管理職 |
| シフトを変更する | シフトが変更された | 管理職 |

**リードモデル**:
- シフトカレンダー（部門別）
- シフトパターン一覧

**ポリシー（自動処理）**:
- シフト割当・変更時の本人通知: `シフトが割り当てられた` / `シフトが変更された` → 本人に通知送信

> **設計判断**: シフト変更は即反映（承認不要）。月次シフト表作成機能はMVP対象外。
> フレックス月次不足→欠勤控除の検知は月次処理コンテキスト側で実施。

---

### 残業申請集約

**コンテキスト**: 申請承認

| コマンド | イベント | アクター |
|---------|---------|---------|
| 残業を申請する | 残業が申請された | 従業員 |
| 残業申請を承認する | 残業申請が承認された | 管理職 |
| 残業申請を却下する | 残業申請が却下された | 管理職 |
| 残業申請を再申請する | 残業申請が再申請された | 従業員 |

**リードモデル**:
- 残業申請一覧（従業員別）
- 承認待ち残業申請一覧（管理職用）

**ポリシー（自動処理）**:
- 未申請残業検知: `退勤が打刻された` かつ所定終業後 → `未申請残業アラートを送信する`

---

### 休暇申請集約

**コンテキスト**: 申請承認

| コマンド | イベント | アクター |
|---------|---------|---------|
| 休暇を申請する | 休暇が申請された | 従業員 |
| 休暇申請を承認する | 休暇申請が承認された | 管理職 |
| 休暇申請を却下する | 休暇申請が却下された | 管理職 |
| 休暇申請を取り消す | 休暇申請が取り消された | 従業員 |

**リードモデル**:
- 休暇申請一覧（従業員別）
- 承認待ち休暇申請一覧（管理職用）

---

### 打刻修正申請集約

**コンテキスト**: 申請承認

| コマンド | イベント | アクター |
|---------|---------|---------|
| 打刻修正を申請する | 打刻修正が申請された | 従業員 |
| 打刻修正を承認する | 打刻修正が承認された | 管理職 |
| 打刻修正を却下する | 打刻修正が却下された | 管理職 |
| 打刻修正を再申請する | 打刻修正が再申請された | 従業員 |
| 打刻修正を人事承認する | 打刻修正が人事承認された | 人事担当者 |

**リードモデル**:
- 打刻修正申請一覧（従業員別）
- 承認待ち打刻修正一覧（管理職用）

**ポリシー（自動処理）**:
- 仮締め後人事承認エスカレーション: 仮締め後に`打刻修正が承認された`（上長）→ 人事承認ステップを追加

> **設計判断**: 却下後の再申請フローを追加（残業申請と同様）。回数上限なし。

---

### 有給残高集約

**コンテキスト**: 休暇管理

| コマンド | イベント | アクター |
|---------|---------|---------|
| 有給を付与する | 有給が付与された | システム（自動） |
| 有給を消化する | 有給が消化された | システム（休暇承認時） |
| 時効消滅させる | 有給が時効消滅した | システム（自動） |
| 特別休暇を付与する | 特別休暇が付与された | 人事担当者 |
| 特別休暇を消化する | 特別休暇が消化された | システム（休暇承認時） |

**リードモデル**:
- 有給残日数照会（従業員別）
- 有給取得状況ダッシュボード（年5日義務の進捗）
- 特別休暇残日数照会（種別ごと）

**ポリシー（自動処理）**:
- 自動付与: 入社日起算で付与基準日到達時 → `有給を付与する`
- 時効処理: 付与日から2年経過 → `時効消滅させる`
- 消化: `休暇申請が承認された` → `有給を消化する` / `特別休暇を消化する`（種別により分岐）
- 特別休暇付与通知: `特別休暇が付与された` → 本人に通知送信

---

### 月次締め集約

**コンテキスト**: 月次処理

| コマンド | イベント | アクター |
|---------|---------|---------|
| 仮締めする | 月次が仮締めされた | 人事担当者 |
| 本締めする | 月次が本締めされた | 人事担当者 |
| 給与データをエクスポートする | 給与データがエクスポートされた | 人事担当者 |

**リードモデル**:
- 月次締め状況ダッシュボード（未打刻/未承認件数）

**ポリシー（自動処理）**:
- 締め前リマインド: 月末3営業日前 → `未承認リマインドを送信する`
- 締め前督促: 月末1営業日前 → `未承認督促を送信する`
- フレックス月次清算不足検知: 仮締め時にフレックス勤務者の所定不足を検知 → 欠勤控除

---

### 通知集約

**コンテキスト**: 通知

| コマンド | イベント | アクター |
|---------|---------|---------|
| 通知を送信する | 通知が送信された | システム（他コンテキストからの依頼） |
| Slack通知を送信する | Slack通知が送信された | システム（自動） |
| 通知を既読にする | 通知が既読になった | 従業員 |

**リードモデル**:
- 未読通知一覧（ユーザー別）
- 通知履歴

**ポリシー（自動処理）**:
- Slack転送: 重要度が高い通知をSlackにも配信

> **設計判断**: 通知の責務は「配送のみ」。宛先・内容の判断は各コンテキスト側。
> チャネルはアプリ内通知 + Slack（重要通知）。メール対応はMVP後に検討。

---

## ステータス遷移

### 勤怠記録

| From | To | トリガー | ガード条件 |
|------|-----|---------|-----------|
| 未打刻 | 出勤済 | 出勤打刻する | 当日の勤怠記録が存在しない |
| 出勤済 | 退勤済 | 退勤打刻する | 出勤打刻済み |
| 退勤済 | 確定 | 月次本締めする | 当月の全勤怠記録対象 |

### 残業申請

| From | To | トリガー | ガード条件 |
|------|-----|---------|-----------|
| 下書き | 申請中 | 残業を申請する | 予定残業時間+理由が入力済み |
| 申請中 | 承認済 | 承認する | 上長権限 |
| 申請中 | 却下 | 却下する | 上長権限、却下理由必須 |
| 却下 | 申請中 | 再申請する | 内容修正済み |

### 休暇申請

| From | To | トリガー | ガード条件 |
|------|-----|---------|-----------|
| 下書き | 申請中 | 休暇を申請する | 休暇種別+日付が入力済み |
| 申請中 | 承認済 | 承認する | 上長権限、有給残日数≧申請日数 |
| 申請中 | 却下 | 却下する | 上長権限 |
| 承認済 | 取消済 | 取り消す | 休暇日前日まで |

### 打刻修正申請

| From | To | トリガー | ガード条件 |
|------|-----|---------|-----------|
| 下書き | 申請中 | 打刻修正を申請する | 修正対象日時+修正後時刻が入力済み |
| 申請中 | 承認済 | 承認する | 上長権限 |
| 申請中 | 却下 | 却下する | 上長権限、却下理由必須 |
| 却下 | 申請中 | 再申請する | 内容修正済み |
| 承認済 | 人事承認待ち | 仮締め後承認エスカレーション | 対象月が仮締め済み |
| 人事承認待ち | 最終承認済 | 人事承認する | 人事担当者権限 |

### 月次締め

| From | To | トリガー | ガード条件 |
|------|-----|---------|-----------|
| 未処理 | 仮締め | 仮締めする | 当月の全営業日に勤怠データあり |
| 仮締め | 確定 | 本締めする | 人事確認完了 |

---

## Saga（コンテキスト間連携）

| トリガーイベント | 発行コマンド | 対象集約 |
|----------------|-------------|---------|
| 休暇申請が承認された | 有給を消化する / 特別休暇を消化する | 有給残高 |
| 休暇申請が承認された | 勤怠ステータスを休暇にする | 勤怠記録 |
| 打刻修正が承認された | 打刻を修正する | 勤怠記録 |
| 打刻修正が人事承認された | 打刻を修正する | 勤怠記録 |
| 残業申請が承認された | 残業を確定する | 勤怠記録 |
| 月次が本締めされた | 全勤怠記録を確定する | 勤怠記録 |
| 月次が本締めされた | 給与データをエクスポートする | 給与システム（外部） |
| 36協定閾値超過検知 | 通知を送信する | 通知 |

---

## 外部システム連携

| システム | 方向 | トリガー | 処理内容 |
|---------|------|---------|---------|
| 給与システム | 出力 | 給与データがエクスポートされた | CSV形式で勤怠実績を送信 |
| Google Workspace | 出力 | 休暇申請が承認された | Googleカレンダーに休暇予定を同期 |
| Google Workspace | 入力 | ログイン時 | OAuth 2.0 SSO認証 |
| Slack | 出力 | 重要通知発生時 | チャンネルまたはDMに通知送信 |

---

## ビジネスルール（数値化済み）

| ルール | 数値/条件 | 違反時の処理 |
|-------|----------|-------------|
| 月次残業上限 | 45h（特別条項で100h未満） | 45h到達でアラート、以降の残業申請に人事承認追加 |
| 年次残業上限 | 360h（特別条項で720h） | 360h到達でアラート |
| 月45h超回数 | 年6回まで | 6回到達で以降の残業申請を原則不可 |
| 2-6ヶ月平均 | 80h以内 | 超過見込み時点でアラート |
| 有給取得義務 | 年5日 | 基準日10ヶ月経過時点で未達ならアラート |
| 有給時効 | 付与日から2年 | 時効30日前に通知 |
| 打刻修正期限 | 本締め前まで（仮締め後は人事承認追加） | 本締め後は修正不可 |
| 事後残業申請 | 翌営業日中 | 超過時は人事確認が必要 |
| 給与連携SLA | 締め翌営業日中 | 超過時は人事にエスカレーション |

<!-- 品質チェック結果
- [x] 全集約にコマンド/イベントが定義されている（8集約）
- [x] ホットスポットが0個
- [x] ビジネスルールが全て数値化されている（9ルール）
- [x] 外部連携の責任分界点が明確（勤怠システムがマスター）
- [x] ステータス遷移が5集約で定義されている（打刻修正申請を追加）
- [x] Sagaが8パターン特定されている
- [x] 全集約にリードモデルが定義されている
- [x] 設計判断（休暇付与統合、MVP対象外等）が記録されている
- [x] 通知集約が詳細化されている（コマンド/イベント/リードモデル/ポリシー）
-->
