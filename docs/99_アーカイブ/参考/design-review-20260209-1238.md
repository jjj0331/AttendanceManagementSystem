# 設計レビューレポート

> **実行日**: 2026-02-09
> **対象**: Phase 3 設計書（全8集約）+ Phase 3.5 連携設計
> **合格ライン**: 45/75（60%）

---

## 総合結果

| 項目 | 値 |
|------|-----|
| 総合スコア | **541/600（90.2%）** |
| 判定 | ✅ 合格 |
| レビュー対象集約数 | 8 |
| AIブロッカー（P0）数 | **6** |

---

## 集約別スコア

| 集約 | A.充足度 (/25) | B.整合性 (/25) | C.曖昧さ (/25) | 合計 (/75) | 判定 |
|------|---------------|---------------|---------------|-----------|------|
| 残業申請 | 24 | 25 | 21 | **70** | ✅ |
| 有給残高 | 24 | 24 | 22 | **70** | ✅ |
| 通知 | 23 | 24 | 23 | **70** | ✅ |
| 休暇申請 | 23 | 24 | 21 | **68** | ✅ |
| シフト | 23 | 25 | 19 | **67** | ✅ |
| 勤怠記録 | 23 | 23 | 21 | **67** | ✅ |
| 月次締め | 23 | 24 | 20 | **67** | ✅ |
| 打刻修正申請 | 24 | 19 | 19 | **62** | ✅ |

---

## カテゴリ別分析

### A. 実装充足度

- 平均: **23.4/25**（93.5%）
- 最低項目: A-3 エラーハンドリングの網羅性（全8集約で4点、5点なし）
- 傾向: DB設計（A-1）とAPI定義精度（A-2）は全集約で満点。エラーハンドリング（A-3）が共通の弱点で、特にSaga失敗時・部分失敗時のリカバリフローが全体的に不足している

### B. ドキュメント間整合性

- 平均: **23.5/25**（94.0%）
- 最低項目: B-2 API→DB対応（打刻修正申請で3点）
- 傾向: 大半の集約はドメインモデル→API→DB→画面の対応が取れている。打刻修正申請のみ BOTH型修正時のDB Read Model カラム構造がAPIレスポンスと乖離しており深刻。命名規則（B-5）の揺れも打刻修正申請・休暇申請・有給残高で散見

### C. 実装時曖昧さ

- 平均: **20.8/25**（83.0%）← 最弱カテゴリ
- 最低項目: C-4 パフォーマンス要件（全8集約で3点、5点なし）
- 傾向: **C-4（パフォーマンス要件）が全集約で3点** — レスポンスタイム目標値・想定データ量・同時接続数が一切定義されていない。設計文書として体系的に欠落している。C-5（計算ロジック）も勤怠記録・月次締めで不足が目立つ

---

## 改善ロードマップ

### P0: ブロッカー（AIが実装不可能） — 6件 ✅ 全件修正済み

| # | 対象集約 | 項目 | 問題 | 改善案 | 状態 |
|---|---------|------|------|--------|------|
| 1 | 打刻修正申請 | B-2 | DB Read Model の clock_correction_request_summaries が original_clock_time / corrected_clock_time の単一カラムだが、APIは originalClockIn / originalClockOut / correctedClockIn / correctedClockOut の4フィールド。BOTH型で2つの時刻を1カラムに格納できない | Read Model を4カラム（original_clock_in / original_clock_out / corrected_clock_in / corrected_clock_out）に分割 | ✅ 修正済み |
| 2 | 打刻修正申請 | B-5 | 画面設計で clockCorrectionId、API/DB では clockCorrectionRequestId。画面の correctedClockTime（オブジェクト形式）とAPIの correctedClockIn / correctedClockOut（個別HH:mm）が混在 | 全設計書を clockCorrectionRequestId + correctedClockIn / correctedClockOut に統一 | ✅ 修正済み（6ファイル） |
| 3 | 勤怠記録 | C-5 | 勤務時間計算の具体式がない。netWorkMinutes、regularOvertime、lateNightMinutes の算出ロジック、端数処理、36協定閾値の設定可否が未定義 | 計算式を追加: netWorkMinutes = (clockOut - clockIn) - totalBreakMinutes、深夜帯判定、月次集計の端数処理ルール、36協定閾値の定数管理方針 | ✅ 修正済み |
| 4 | シフト | C-1 | コンテキスト間連携設計にシフト集約の連携仕様がほぼ記載されていない。シフト→通知（公開通知）、シフト→勤怠記録（所定勤務時間参照）のインターフェースが未定義 | 連携設計書に ShiftSchedulePublishedEvent と ShiftPatternQueryPort を追加。連携フロー図にシフトノードを追加 | ✅ 修正済み |
| 5 | 有給残高 | A-3 | 内部API /internal/consume に employeeId がなく、どの従業員の残高を消化するか特定不能。FIFO跨ぎ消化時のレスポンス構造も単一grantIdのみ | consumeリクエストに employeeId を追加。FIFO跨ぎ消化のレスポンスを配列形式にするか集約サマリのみにするか方針を決定 | ✅ 修正済み（配列形式採用） |
| 6 | 月次締め | B-3 | ダッシュボード画面の KPI（currentMonthStatus, totalMissingClockCount 等）に対応する API レスポンスフィールドが存在しない | GET /dashboard のレスポンスに kpi オブジェクトを追加、または KPI専用エンドポイント GET /monthly-closings/kpi を新設 | ✅ 修正済み（kpiオブジェクト追加） |

### P1: 重要（実装時に判断が必要） — 19件

| # | 対象集約 | 項目 | 問題 | 改善案 |
|---|---------|------|------|--------|
| 1 | 勤怠記録 | A-3 | /internal/attendances/finalize の部分成功時の挙動不明（ロールバック有無） | 全件ロールバック vs 成功分のみ確定の方針を明記 |
| 2 | 勤怠記録 | A-5 | フレックス月所定時間の端数処理、深夜帯の分単位処理、打刻丸め方針が未定義 | 端数処理ルール（分単位切り捨て等）を追記 |
| 3 | 勤怠記録 | C-4 | パフォーマンス目標値なし | 打刻API p95<200ms、一覧API p95<500ms、想定データ量等を追記 |
| 4 | シフト | A-3 | 一括公開の部分失敗時リカバリ未定義 | 逐次呼び出し方式の失敗リトライ方針を明記 or バルクAPIを新設 |
| 5 | シフト | A-5 | isOvernight フラグと startTime/endTime の組み合わせバリデーション未定義 | isOvernight=false なら endTime>startTime 等のルールを追加 |
| 6 | 残業申請 | C-5 | 36協定計算の対象期間、2-6ヶ月平均の計算式、営業日判定が未定義 | 計算式を数式で定義、営業日判定ロジックを追加 |
| 7 | 休暇申請 | A-5 | 時間単位有給の年間上限の1日換算（8h?所定労働時間?）が未定義 | HOURLY年間上限の換算式を追加 |
| 8 | 休暇申請 | B-5 | 不変条件IDのプレフィックス揺れ（LR vs LV）、ID数が設計書間で不一致 | INV-LV に統一、不変条件リストを同期 |
| 9 | 休暇申請 | C-5 | 有給消化の換算式（HOURLY→日数）、LeavePeriod.days() の計算式が未定義 | 消化換算式と期間計算式を明記 |
| 10 | 打刻修正申請 | A-3 | Saga失敗時のエラーステータス・補償トランザクションが未定義 | CORRECTION_FAILED ステータスと補償フローを定義 |
| 11 | 打刻修正申請 | C-1 | ClockCorrectionCommand のフィールドがAPI/DB間で曖昧 | correctedClockIn / correctedClockOut に統一 |
| 12 | 有給残高 | B-5 | reason文字数バリデーション（1〜500 vs 10〜500）の矛盾。leave_grants.type のCHECK制約に消化単位が混入 | 文字数を10〜500に統一。type制約を付与時の値に限定 |
| 13 | 有給残高 | C-4 | パフォーマンス目標・イベントテーブル肥大化対策・MVリフレッシュ頻度が未定義 | レスポンスタイム目標・パーティション戦略・MV頻度を追記 |
| 14 | 月次締め | A-5 | 仮締め時の対象従業員集計ロジック、営業日計算が未定義 | totalEmployees の集計条件、営業日判定方式を追記 |
| 15 | 月次締め | C-3 | 画面のパーミッション文字列とロールのマッピングが未定義 | ロール→パーミッションのマッピング表を追加 |
| 16 | 月次締め | C-4 | 仮締め処理の想定時間、エクスポートのタイムアウト閾値が未定義 | 処理時間見積もり・タイムアウト閾値を追記 |
| 17 | 月次締め | C-5 | hasIssues 判定式、CSVカラム定義、フレックス不足の端数処理が未定義 | 判定式・CSV最低限カラム定義・端数ルールを追記 |
| 18 | 通知 | A-3 | 一括既読の部分失敗パターンがAPI側で未定義。401がコマンドAPIに欠落 | バルク既読API新設 or 方針明記。401を追加 |
| 19 | 通知 | A-5 | ユーザー個人通知設定テーブルが未存在 | MVPではシステムデフォルトのみと明記し、設定機能をv2に移す |

### P2: 改善推奨（品質向上に寄与） — 12件

| # | 対象集約 | 項目 | 問題 |
|---|---------|------|------|
| 1 | 勤怠記録 | B-4 | 画面の ON_BREAK 表示用ステータスがドメインモデルに未定義 |
| 2 | 勤怠記録 | B-5 | dateFrom/workDateFrom、attendanceId/id の命名差異 |
| 3 | シフト | C-4 | パフォーマンス目標値なし |
| 4 | 残業申請 | C-4 | パフォーマンス目標値なし |
| 5 | 休暇申請 | A-3 | 承認・却下・取り消しのRFC 7807 JSON例が省略 |
| 6 | 休暇申請 | C-4 | パフォーマンス目標値なし |
| 7 | 打刻修正申請 | B-4 | MGR_APPROVED が一時的状態でフィルタの意味が曖昧 |
| 8 | 打刻修正申請 | C-4 | パフォーマンス目標値なし |
| 9 | 有給残高 | C-5 | HOURLY残時間計算式・半日FIFO端数処理が未定義 |
| 10 | 月次締め | A-3 | export-payroll のリトライ回数・間隔が未定義 |
| 11 | 通知 | B-5 | offset→page ページネーションパラメータ不統一 |
| 12 | 通知 | C-4 | パフォーマンス目標値・データ保持期間なし |

---

## 横断的問題の抽出

### 1. パフォーマンス要件の体系的欠落（C-4: 全8集約で3点）

全集約でレスポンスタイム目標値・想定データ量・同時接続数が未定義。これは個別集約の問題ではなく、プロジェクト全体の非機能要件定義が Phase 3 のスコープに含まれていなかったことが原因。

**推奨**: `docs/10_アーキテクチャ/非機能要件.md` を新規作成し、SLO（レスポンスタイム p50/p95/p99）・想定ユーザー数・想定データ量・データ保持ポリシーを一元定義する。各集約の設計書からはこのドキュメントを参照する形にする。

### 2. Saga/非同期処理のエラーハンドリング（A-3: 5集約で4点）

同期APIのエラーは定義されているが、Saga失敗時の補償トランザクション、非同期ジョブのリトライ/タイムアウト、一括操作の部分失敗パターンが体系的に不足。

**推奨**: 連携設計書に「エラーハンドリング方針」セクションを追加し、Saga失敗時の共通パターン（手動再実行 vs 自動補償）を定義する。

### 3. 計算ロジックの具体式不足（C-5: 3集約で3点）

勤務時間計算（勤怠記録）、36協定チェック（残業申請）、月次集計（月次締め）の計算ロジックが自然言語レベルで、具体的な計算式・境界条件・端数処理が不足。

**推奨**: `docs/30_設計/ビジネスロジック/計算ルール.md` を新規作成し、勤務時間計算・残業計算・有給消化計算・月次集計計算の数式を一元定義する。

### 4. 打刻修正申請の設計品質（62/75: 最低スコア）

Round 4 整合性チェックで指摘されていた BOTH型修正・命名不統一の問題が集中していた。**P0 2件は修正済み**（DB Read Model 4カラム分割 + 画面6ファイル命名統一）。残りはP1のSaga失敗時補償フロー定義。

---

## 集約別詳細

### 残業申請（70/75）

**スコア**: 70/75（93.3%）

| 項目 | スコア | 指摘内容 | 改善案 | 優先度 |
|------|--------|---------|--------|--------|
| A-3 | 4 | 36協定チェック超過時のHTTPステータスとエラーレスポンス例が未定義 | 専用エラーtype追加 | P1 |
| C-4 | 3 | パフォーマンス目標値なし | 非機能要件を定義 | P2 |
| C-5 | 3 | 月次累計の計算対象期間、2-6ヶ月平均の計算式、営業日判定が未定義 | 計算式を数式で定義 | P1 |

### 有給残高（70/75）

**スコア**: 70/75（93.3%）

| 項目 | スコア | 指摘内容 | 改善案 | 優先度 |
|------|--------|---------|--------|--------|
| A-3 | 4 | /internal/consume に employeeId がない。FIFO跨ぎレスポンス構造が不明 | employeeId追加、レスポンス方針決定 | ~~P0~~ ✅ |
| B-5 | 4 | reason文字数矛盾（1-500 vs 10-500）。leave_grants.type に消化単位が混入 | 統一修正 | P1 |
| C-4 | 3 | パフォーマンス目標・イベントテーブル対策なし | 非機能要件・パーティション戦略追記 | P1 |
| C-5 | 4 | HOURLY残時間計算式、半日FIFO端数処理が曖昧 | 計算式明記 | P2 |

### 通知（70/75）

**スコア**: 70/75（93.3%）

| 項目 | スコア | 指摘内容 | 改善案 | 優先度 |
|------|--------|---------|--------|--------|
| A-3 | 4 | 一括既読の部分失敗パターン未定義。401がコマンドAPIに欠落 | バルクAPI新設 or 方針明記 | P1 |
| A-5 | 4 | ユーザー個人通知設定テーブルが未存在 | MVPではデフォルトのみと明記 | P1 |
| B-5 | 4 | offset→page パラメータ不統一 | page に統一 | P1 |
| C-4 | 3 | パフォーマンス目標・データ保持期間なし | 非機能要件追記 | P2 |

### 休暇申請（68/75）

**スコア**: 68/75（90.7%）

| 項目 | スコア | 指摘内容 | 改善案 | 優先度 |
|------|--------|---------|--------|--------|
| A-3 | 4 | 承認・却下のRFC 7807 JSON例が省略 | JSON例追加 | P2 |
| A-5 | 4 | HOURLY年間上限の1日換算が未定義 | 換算式追加 | P1 |
| B-5 | 4 | 不変条件ID揺れ（LR vs LV） | INV-LVに統一 | P1 |
| C-4 | 3 | パフォーマンス目標値なし | 非機能要件定義 | P2 |
| C-5 | 3 | 有給消化換算式、LeavePeriod.days() が未定義 | 計算式明記 | P1 |

### シフト（67/75）

**スコア**: 67/75（89.3%）

| 項目 | スコア | 指摘内容 | 改善案 | 優先度 |
|------|--------|---------|--------|--------|
| A-3 | 4 | 一括公開の部分失敗リカバリ未定義 | 方針明記 or バルクAPI新設 | P1 |
| A-5 | 4 | isOvernight/時刻の組み合わせバリデーション未定義 | バリデーションルール追加 | P1 |
| C-1 | 3 | 連携設計にシフトの仕様がほぼ未記載 | ShiftSchedulePublishedEvent + ShiftPatternQueryPort 追加 | ~~P0~~ ✅ |
| C-4 | 3 | パフォーマンス目標値なし | 非機能要件定義 | P2 |

### 勤怠記録（67/75）

**スコア**: 67/75（89.3%）

| 項目 | スコア | 指摘内容 | 改善案 | 優先度 |
|------|--------|---------|--------|--------|
| A-3 | 4 | finalize の部分失敗時の挙動不明 | ロールバック方針を明記 | P1 |
| A-5 | 4 | フレックス端数処理・深夜帯分単位処理・打刻丸め未定義 | 端数処理ルール追記 | P1 |
| B-4 | 4 | ON_BREAK 表示用ステータスがドメインに未定義 | マッピングロジック明記 | P2 |
| B-5 | 4 | dateFrom/workDateFrom 命名差異 | 統一 | P2 |
| C-4 | 3 | パフォーマンス目標値なし | 非機能要件定義 | P1 |
| C-5 | 3 | 勤務時間計算の具体式・端数処理・36協定閾値管理が未定義 | 計算式追加 | ~~P0~~ ✅ |

### 月次締め（67/75）

**スコア**: 67/75（89.3%）

| 項目 | スコア | 指摘内容 | 改善案 | 優先度 |
|------|--------|---------|--------|--------|
| A-3 | 4 | export-payroll のリトライ/タイムアウトが未定義 | リトライ上限・間隔追記 | P2 |
| A-5 | 4 | 対象従業員集計ロジック・営業日計算が未定義 | 集計条件・営業日判定追記 | P1 |
| B-3 | 4 | ダッシュボードKPI集計値がAPIレスポンスにない | kpiオブジェクト追加 or KPI専用エンドポイント新設 | ~~P0~~ ✅ |
| C-3 | 4 | パーミッション文字列→ロールのマッピング未定義 | マッピング表追加 | P1 |
| C-4 | 3 | 仮締め処理時間見積もり・エクスポートタイムアウトなし | 非機能要件追記 | P1 |
| C-5 | 3 | hasIssues判定式・CSVカラム定義・端数処理が未定義 | 判定式・CSV定義・端数ルール追記 | P1 |

### 打刻修正申請（62/75）← 最低スコア

**スコア**: 62/75（82.7%）

| 項目 | スコア | 指摘内容 | 改善案 | 優先度 |
|------|--------|---------|--------|--------|
| B-2 | 3 | DB Read Model が単一カラム、APIは4フィールド。BOTH型で破綻 | 4カラムに分割 | ~~P0~~ ✅ |
| B-5 | 3 | clockCorrectionId vs clockCorrectionRequestId 混在。correctedClockTime vs correctedClockIn/Out 混在 | 全設計書で統一 | ~~P0~~ ✅ |
| A-3 | 4 | Saga失敗時の補償トランザクション未定義 | CORRECTION_FAILED + 補償フロー定義 | P1 |
| B-4 | 4 | MGR_APPROVED が一時的状態でフィルタ意味不明 | フィルタ除外 or 注記追加 | P2 |
| C-1 | 4 | ClockCorrectionCommand のフィールド曖昧 | correctedClockIn/Out に統一 | P1 |
| C-4 | 3 | パフォーマンス目標値なし | 非機能要件定義 | P2 |

---

## サマリー

### 全体評価

| カテゴリ | 平均スコア | 評価 |
|---------|-----------|------|
| A. 実装充足度 | 23.4/25（93.5%） | 優秀 |
| B. ドキュメント間整合性 | 23.5/25（94.0%） | 優秀 |
| C. 実装時曖昧さ | 20.8/25（83.0%） | 改善余地あり |

### P0 修正の推奨順序

1. **打刻修正申請** B-2 + B-5（DB/API/画面の構造的不整合 — 最も影響範囲が広い）
2. **月次締め** B-3（ダッシュボードKPI — API追加が必要）
3. **有給残高** A-3（内部API employeeId 欠落 — Saga連携に直結）
4. **勤怠記録** C-5（勤務時間計算式 — 最もドメインの核心）
5. **シフト** C-1（連携設計追加 — 新規セクション追記）

### 新規ドキュメント作成の推奨

- `docs/10_アーキテクチャ/非機能要件.md` — パフォーマンスSLO・データ量見積もり一元管理
- `docs/30_設計/ビジネスロジック/計算ルール.md` — 勤務時間・残業・有給消化の計算式一元管理

<!-- 品質チェック
- [x] 全8集約のスコアが記載されている
- [x] カテゴリ別分析（A/B/C）が含まれている
- [x] P0/P1/P2 の改善ロードマップが含まれている
- [x] 横断的問題が抽出されている
- [x] 集約別詳細セクションが含まれている
- [x] 推奨修正順序が含まれている
-->
