# 設計レビューレポート（第2回）

> **実行日**: 2026-02-09
> **対象**: Phase 3 設計書（全8集約）+ Phase 3.5 連携設計
> **合格ライン**: 45/75（60%）
> **前回レビュー**: design-review-20260209-1238.md（541/600, 90.2%）

---

## 総合結果

| 項目 | 値 | 前回比 |
|------|-----|--------|
| 総合スコア | **553/600（92.2%）** | +12（+2.0pp） |
| 判定 | ✅ 合格 | — |
| レビュー対象集約数 | 8 | — |
| AIブロッカー（P0）数 | **1** | -5 |

---

## 集約別スコア

| 集約 | A.充足度 (/25) | B.整合性 (/25) | C.曖昧さ (/25) | 合計 (/75) | 前回 | 差分 | 判定 |
|------|---------------|---------------|---------------|-----------|------|------|------|
| 勤怠記録 | 24 | 23 | 23 | **70** | 67 | +3 | ✅ |
| 残業申請 | 24 | 25 | 21 | **70** | 70 | ±0 | ✅ |
| 有給残高 | 24 | 24 | 22 | **70** | 70 | ±0 | ✅ |
| シフト | 23 | 25 | 21 | **69** | 67 | +2 | ✅ |
| 打刻修正申請 | 24 | 24 | 21 | **69** | 62 | **+7** | ✅ |
| 通知 | 23 | 24 | 22 | **69** | 70 | -1 | ✅ |
| 休暇申請 | 24 | 24 | 20 | **68** | 68 | ±0 | ✅ |
| 月次締め | 23 | 25 | 20 | **68** | 67 | +1 | ✅ |

---

## P0修正の効果

前回P0だった6件のうち5件が完全に解消、1件は別の観点で新たなP0が発生:

| 前回P0 | 対象 | 修正内容 | 今回スコア |
|--------|------|---------|-----------|
| ✅ 解消 | 打刻修正申請 B-2 | DB Read Model 4カラム分割 | B-2: 5 |
| ✅ 解消 | 打刻修正申請 B-5 | 画面6ファイル命名統一 | B-5: 5 |
| ✅ 解消 | 勤怠記録 C-5 | 計算ロジック詳細セクション追加 | C-5: 5 |
| ✅ 解消 | シフト C-1 | 連携設計にシフト仕様追加 | C-1: 5 |
| ✅ 解消 | 有給残高 A-3 | employeeId追加 + FIFO配列化 | A-3: 4 |
| ✅ 解消 | 月次締め B-3 | GET /dashboard に kpi追加 | B-3: 5 |
| 🆕 新規 | 月次締め C-5 | 集計ロジック・CSV仕様未定義 | C-5: 3 |

---

## カテゴリ別分析

### A. 実装充足度

- 平均: **23.6/25**（94.5%） ← 前回23.4（+0.2）
- 最低項目: A-3 エラーハンドリング（全8集約で4点、5点は打刻修正申請のみ）
- 傾向: 打刻修正申請のA-3が前回4→5に改善。Saga失敗時・一括操作の部分失敗パターンが依然として弱点

### B. ドキュメント間整合性

- 平均: **24.3/25**（97.0%） ← 前回23.5（**+0.8**）
- 最低項目: B-4 状態遷移一致性（勤怠記録・打刻修正申請で4点）
- 傾向: **P0修正の最大効果**。打刻修正申請のB-2/B-5が3→5に跳ね上がり、カテゴリ平均が大幅改善

### C. 実装時曖昧さ

- 平均: **21.3/25**（85.0%） ← 前回20.8（+0.5）
- 最低項目: C-4 パフォーマンス要件（全8集約で3点、5点なし）
- 傾向: C-5（計算ロジック）は勤怠記録が3→5に改善したが、月次締め・残業申請が依然3点。**C-4は全集約で体系的に欠落**しており、個別修正ではなくプロジェクト横断の非機能要件定義が必要

---

## 改善ロードマップ

### P0: ブロッカー（AIが実装不可能） — 1件

| # | 対象集約 | 項目 | 問題 | 改善案 |
|---|---------|------|------|--------|
| 1 | 月次締め | C-5 | 仮締め時のmissingClockCount/pendingApprovalCountの集計SQL・ロジックが未定義。CSVエクスポートの汎用フォーマットのカラム構成が未定義。KPI集計のフィルタ条件（退職者除外等）が未定義 | (1) 仮締め集計条件を定義（例: 当月の clock_in IS NULL 件数）。(2) MVP汎用CSVカラム一覧を定義（employee_id, name, total_working_hours, overtime_hours 等）。(3) KPI集計のフィルタ条件を定義（is_active=true 等） |

### P1: 重要（実装時に判断が必要） — 22件

| # | 対象集約 | 項目 | 問題 | 改善案 |
|---|---------|------|------|--------|
| 1 | 勤怠記録 | A-3 | 楽観的ロック競合時のリカバリ手順が未記載 | 打刻系APIに412エラー+リトライフロー明記 |
| 2 | 勤怠記録 | B-4 | ON_BREAK表示用ステータスがドメインモデルに未定義 | CLOCKED_IN + onBreak=trueの変換ルール明記 |
| 3 | 勤怠記録 | C-4 | パフォーマンス目標値なし | 打刻API p95<200ms、MVリフレッシュ頻度追記 |
| 4 | シフト | A-3 | 楽観的ロック競合時のエラーコード未定義 | PUT系に412エラー+versionフィールド追加 |
| 5 | 残業申請 | A-3 | 36協定超過時のHTTPステータス・エラーtype未定義 | 422 + labor-standards-violationエラー定義 |
| 6 | 残業申請 | C-5 | 36協定計算の対象期間・2-6ヶ月平均計算式未定義 | 累計計算式+境界値テーブル追加 |
| 7 | 休暇申請 | A-3 | 承認・却下レスポンスが省略形で詳細APIと不統一 | 完全スキーマ or 省略スキーマを明示 |
| 8 | 休暇申請 | B-5 | ID形式不一致（LR-xxx vs UUID vs LVR-xxx） | UUID一本化 or 表示用ID別カラム化 |
| 9 | 休暇申請 | C-3 | approverIdをリクエストボディに含める理由不明 | JWT自動取得に統一 or 代理承認用途を明記 |
| 10 | 休暇申請 | C-5 | 有給消化日数の営業日カウント・端数処理が未定義 | 土日祝除外要否・端数ルール追記 |
| 11 | 打刻修正申請 | A-5 | 「仮締め後」の具体的判定条件が未記載 | MonthlyClosingステータス条件を明記 |
| 12 | 打刻修正申請 | B-4 | MGR_APPROVEDが瞬間状態でAPIフィルタの意味が曖昧 | 遷移完了後のステータスを返す旨の注記追加 |
| 13 | 有給残高 | B-5 | leave_grants.type枚挙の概念混在、adjustのemployeeId冗長 | 付与種別と消化単位の分離 |
| 14 | 有給残高 | C-4 | パフォーマンス目標・MVリフレッシュ頻度未定義 | レスポンスタイム目標+MV頻度確定 |
| 15 | 有給残高 | C-5 | HOURLY日数換算端数処理・FIFO跨ぎ詳細・5日義務換算基準 | 換算式+FIFO跨ぎロジック+義務対象種別明記 |
| 16 | 月次締め | A-3 | export-statusがエンドポイント一覧に未掲載、リトライ未定義 | エンドポイント追加+タイムアウト・リトライ明記 |
| 17 | 月次締め | A-5 | フレックス月所定不足の端数処理・欠勤控除ロジック未定義 | 端数処理方式+欠勤控除フロー定義 |
| 18 | 月次締め | C-3 | ロール→パーミッションのマッピング未定義 | マッピング表追加 |
| 19 | 月次締め | C-4 | 仮締め処理時間見積もり・エクスポートタイムアウトなし | 処理時間SLA定義 |
| 20 | 通知 | A-3 | 一括既読APIが未定義、外部配信失敗時のリカバリ未定義 | バルクAPI新設 or 並行呼び出しガイドライン |
| 21 | 通知 | A-5 | ユーザー個人通知設定テーブルが未存在 | MVPスコープ外と明記 |
| 22 | 通知 | C-2 | 連携設計の通知種別14種とEnum定義9種が不一致 | ARTICLE36_ALERT分割 or bodyパラメータ方針明記 |

### P2: 改善推奨（品質向上に寄与） — 10件

| # | 対象集約 | 項目 | 問題 |
|---|---------|------|------|
| 1 | 勤怠記録 | B-5 | minutes→hours変換ルールが暗黙（API:時間単位, DB:分単位） |
| 2 | シフト | A-5 | isOvernight/時刻の組み合わせバリデーション未定義 |
| 3 | シフト | C-4 | パフォーマンス目標値なし |
| 4 | シフト | C-5 | scheduledMinutes計算のコード例・端数処理なし |
| 5 | 残業申請 | C-4 | パフォーマンス目標値なし |
| 6 | 休暇申請 | C-4 | パフォーマンス目標値なし |
| 7 | 打刻修正申請 | C-4 | パフォーマンス目標値なし |
| 8 | 打刻修正申請 | C-5 | 打刻修正後の勤務時間再計算範囲が未定義 |
| 9 | 有給残高 | A-3 | 409/422エラーのJSON例が一部省略、リトライ方針未定義 |
| 10 | 通知 | B-5 | SourceContext表示名不統一、offset/page不一致 |

---

## 横断的問題の抽出

### 1. パフォーマンス要件の体系的欠落（C-4: 全8集約で3点）← 前回から変化なし

全集約でレスポンスタイム目標値・想定データ量・同時接続数が未定義。前回指摘から改善なし。

**推奨**: `docs/10_アーキテクチャ/非機能要件.md` を新規作成し、SLO・想定ユーザー数・想定データ量・データ保持ポリシーを一元定義する。

### 2. Saga/非同期処理のエラーハンドリング（A-3: 6集約で4点）

楽観的ロック競合、一括操作部分失敗、外部配信失敗のリカバリパターンが依然不足。

**推奨**: 連携設計書に「エラーハンドリング方針」セクションを追加。

### 3. 計算ロジックの具体式不足（C-5: 3集約で3点）

勤怠記録は改善したが、月次締め・残業申請が依然3点。36協定計算・月次集計の数式が不足。

**推奨**: `docs/30_設計/ビジネスロジック/計算ルール.md` を新規作成。

### 4. ID体系・Enum定義の不統一（B-5/C-2: 3集約）

休暇申請のID形式（UUID vs プレフィックス付き）、通知のNotificationType Enum、有給残高のleave_grants.typeの概念混在。

**推奨**: `docs/.context/design-decisions.json` にID体系ルールを追加。

---

## 前回比較サマリー

| 指標 | 前回（12:38） | 今回（14:36） | 改善 |
|------|-------------|-------------|------|
| 総合スコア | 541/600（90.2%） | 553/600（92.2%） | **+12** |
| P0件数 | 6 | 1 | **-5** |
| P1件数 | 19 | 22 | +3（精度向上による新規検出） |
| P2件数 | 12 | 10 | -2 |
| 最低スコア集約 | 打刻修正申請（62） | 休暇申請/月次締め（68） | **+6** |
| A平均 | 23.4/25 | 23.6/25 | +0.2 |
| B平均 | 23.5/25 | 24.3/25 | **+0.8** |
| C平均 | 20.8/25 | 21.3/25 | +0.5 |

### 新規ドキュメント作成の推奨（前回から継続）

- `docs/10_アーキテクチャ/非機能要件.md` — パフォーマンスSLO・データ量見積もり一元管理
- `docs/30_設計/ビジネスロジック/計算ルール.md` — 勤務時間・残業・有給消化の計算式一元管理

<!-- 品質チェック
- [x] 全8集約のスコアが記載されている
- [x] カテゴリ別分析（A/B/C）が含まれている
- [x] P0/P1/P2 の改善ロードマップが含まれている
- [x] 横断的問題が抽出されている
- [x] 集約別詳細セクションが含まれている
- [x] 前回比較サマリーが含まれている
- [x] 推奨修正順序が含まれている
-->
