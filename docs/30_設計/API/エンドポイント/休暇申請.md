# 休暇申請 API

## 概要

従業員の休暇申請・承認・却下・取り消し、
および休暇申請状況の照会を提供する。

**ベースパス:** `/api/v1/leave-requests`
**認証:** `Authorization: Bearer {token}`
**エラー形式:** RFC 7807

---

## エンドポイント一覧

### コマンドエンドポイント

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | `/leave-requests` | 休暇を申請する | 必須 |
| POST | `/leave-requests/{id}/actions/approve` | 休暇申請を承認する | 必須 |
| POST | `/leave-requests/{id}/actions/reject` | 休暇申請を却下する | 必須 |
| POST | `/leave-requests/{id}/actions/cancel` | 休暇申請を取り消す | 必須 |

### クエリエンドポイント

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| GET | `/leave-requests` | 休暇申請一覧（従業員別） | 必須 |
| GET | `/leave-requests/{id}` | 休暇申請詳細 | 必須 |
| GET | `/leave-requests/pending-approvals` | 承認待ち休暇申請一覧（管理職用） | 必須 |

---

## コマンドエンドポイント詳細

---

### POST /api/v1/leave-requests

**説明:** 休暇を申請する

**前提条件:**
- 有給種別の場合、取得日数分の有給残高があること
- 同一日に承認済み休暇がないこと

**リクエスト:**

```json
{
  "leaveType": "ANNUAL",
  "leavePeriod": {
    "from": "2024-04-01",
    "to": "2024-04-01"
  },
  "timeSlot": null,
  "reason": null
}
```

時間単位休暇（HOURLY）の場合:

```json
{
  "leaveType": "HOURLY",
  "leavePeriod": {
    "from": "2024-04-01",
    "to": "2024-04-01"
  },
  "timeSlot": {
    "startTime": "09:00",
    "endTime": "14:00"
  },
  "reason": null
}
```

特別休暇（慶弔）の場合:

```json
{
  "leaveType": "SPECIAL_CONDOLENCE",
  "leavePeriod": {
    "from": "2024-04-01",
    "to": "2024-04-03"
  },
  "timeSlot": null,
  "reason": "祖父逝去に伴う忌引休暇を申請いたします"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| leaveType | string (LeaveType) | ✅ | `ANNUAL` / `HALF_DAY_AM` / `HALF_DAY_PM` / `HOURLY` / `SPECIAL_CONDOLENCE` / `SPECIAL_REFRESH` | 休暇種別 |
| leavePeriod | object (LeavePeriod) | ✅ | from ≤ to | 取得期間 |
| leavePeriod.from | string (date) | ✅ | ISO 8601 日付 | 開始日 |
| leavePeriod.to | string (date) | ✅ | ISO 8601 日付 | 終了日 |
| timeSlot | object (TimeSlot) / null | - | HOURLY時のみ必須 | 取得時間帯 |
| timeSlot.startTime | string (HH:mm) | - | 1時間単位 | 開始時刻 |
| timeSlot.endTime | string (HH:mm) | - | 上限5時間 | 終了時刻 |
| reason | string (LeaveReason) / null | - | 特別休暇は必須、10-200文字 | 申請理由 |

**レスポンス: 201 Created**

> 詳細APIと同一スキーマで作成されたリソース全体を返す。

```json
{
  "requestId": "LR-20240401-001",
  "employeeId": "EMP-001",
  "employeeName": "山田太郎",
  "leaveType": "ANNUAL",
  "leavePeriod": {
    "from": "2024-04-01",
    "to": "2024-04-01"
  },
  "timeSlot": null,
  "reason": null,
  "status": "SUBMITTED",
  "submittedAt": "2024-03-28T10:00:00+09:00",
  "approverId": null,
  "approverName": null,
  "approvedAt": null,
  "rejectionReason": null,
  "rejectedAt": null,
  "cancelledAt": null,
  "operationHistory": [
    {
      "action": "SUBMITTED",
      "performedBy": "EMP-001",
      "performedByName": "山田太郎",
      "performedAt": "2024-03-28T10:00:00+09:00",
      "comment": null
    }
  ]
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（from > to、理由文字数不正等） |
| 409 | `/errors/conflict` | 同一日に承認済み休暇が存在する |
| 422 | `/errors/precondition` | 有給残高不足 |

---

### POST /api/v1/leave-requests/{id}/actions/approve

**説明:** 休暇申請を承認する

**前提条件:**
- 申請が SUBMITTED であること
- 承認者が申請者の上長であること

**リクエスト:**

```json
{
  "approverId": "MGR-001"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| approverId | string (ApproverId) | ✅ | 申請者の上長 | 承認者ID |

**レスポンス: 200 OK**

```json
{
  "requestId": "LR-20240401-001",
  "employeeId": "EMP-001",
  "leaveType": "ANNUAL",
  "leavePeriod": {
    "from": "2024-04-01",
    "to": "2024-04-01"
  },
  "status": "APPROVED",
  "approverId": "MGR-001",
  "approvedAt": "2024-03-29T14:00:00+09:00"
}
```

**後処理:** 休暇承認Saga発動
- 有給残高消化（有給種別の場合）
- 勤怠ステータス更新（対象日の勤怠記録を休暇扱いに）
- Googleカレンダー同期（承認済み休暇を登録）

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー |
| 403 | `/errors/forbidden` | 承認者が申請者の上長でない |
| 404 | `/errors/not-found` | 休暇申請が存在しない |
| 409 | `/errors/conflict` | 申請が SUBMITTED でない |

---

### POST /api/v1/leave-requests/{id}/actions/reject

**説明:** 休暇申請を却下する

**前提条件:**
- 申請が SUBMITTED であること

**リクエスト:**

```json
{
  "approverId": "MGR-001",
  "rejectionReason": "繁忙期のため、別日程での取得をお願いします"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| approverId | string (ApproverId) | ✅ | 申請者の上長 | 承認者ID |
| rejectionReason | string (RejectionReason) | ✅ | 10-200文字 | 却下理由 |

**レスポンス: 200 OK**

```json
{
  "requestId": "LR-20240401-001",
  "employeeId": "EMP-001",
  "leaveType": "ANNUAL",
  "leavePeriod": {
    "from": "2024-04-01",
    "to": "2024-04-01"
  },
  "status": "REJECTED",
  "approverId": "MGR-001",
  "rejectionReason": "繁忙期のため、別日程での取得をお願いします",
  "rejectedAt": "2024-03-29T14:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（却下理由文字数不正等） |
| 403 | `/errors/forbidden` | 承認者が申請者の上長でない |
| 404 | `/errors/not-found` | 休暇申請が存在しない |
| 409 | `/errors/conflict` | 申請が SUBMITTED でない |

---

### POST /api/v1/leave-requests/{id}/actions/cancel

**説明:** 休暇申請を取り消す

**前提条件:**
- 申請が SUBMITTED であること（承認前のみ取り消し可能）
- 申請者本人であること

**リクエスト:**

```json
{}
```

> リクエストボディは空。
> 申請者本人であることは認証トークンから判定する。

**レスポンス: 200 OK**

```json
{
  "requestId": "LR-20240401-001",
  "employeeId": "EMP-001",
  "leaveType": "ANNUAL",
  "leavePeriod": {
    "from": "2024-04-01",
    "to": "2024-04-01"
  },
  "status": "CANCELLED",
  "cancelledAt": "2024-03-28T15:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 403 | `/errors/forbidden` | 申請者本人でない |
| 404 | `/errors/not-found` | 休暇申請が存在しない |
| 409 | `/errors/conflict` | 申請が SUBMITTED でない（承認済み・却下済み・取り消し済み） |

---

## クエリエンドポイント詳細

---

### GET /api/v1/leave-requests

**説明:** 休暇申請一覧を取得する（従業員別）

**認可:** 従業員本人

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| status | string (RequestStatus) | - | 全件 | ステータスで絞り込み（`SUBMITTED` / `APPROVED` / `REJECTED` / `CANCELLED`） |
| leaveType | string (LeaveType) | - | 全件 | 休暇種別で絞り込み |
| dateFrom | string (date) | - | 当月1日 | 取得期間の開始日 |
| dateTo | string (date) | - | 当月末日 | 取得期間の終了日 |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数 |
| sort | string | - | `submittedAt,desc` | ソート（`submittedAt`, `leaveType`, `status`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "requestId": "LR-20240401-001",
      "employeeId": "EMP-001",
      "employeeName": "山田太郎",
      "leaveType": "ANNUAL",
      "leavePeriod": {
        "from": "2024-04-01",
        "to": "2024-04-01"
      },
      "timeSlot": null,
      "status": "APPROVED",
      "submittedAt": "2024-03-28T10:00:00+09:00",
      "approverId": "MGR-001",
      "approverName": "鈴木部長"
    },
    {
      "requestId": "LR-20240415-002",
      "employeeId": "EMP-001",
      "employeeName": "山田太郎",
      "leaveType": "HOURLY",
      "leavePeriod": {
        "from": "2024-04-15",
        "to": "2024-04-15"
      },
      "timeSlot": {
        "startTime": "09:00",
        "endTime": "12:00"
      },
      "status": "SUBMITTED",
      "submittedAt": "2024-04-10T09:30:00+09:00",
      "approverId": null,
      "approverName": null
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 5,
    "totalPages": 1
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 401 | `/errors/unauthorized` | 認証エラー |

---

### GET /api/v1/leave-requests/{id}

**説明:** 休暇申請の詳細を取得する

**認可:** 従業員本人 + 上長

**レスポンス: 200 OK**

```json
{
  "requestId": "LR-20240401-001",
  "employeeId": "EMP-001",
  "employeeName": "山田太郎",
  "leaveType": "ANNUAL",
  "leavePeriod": {
    "from": "2024-04-01",
    "to": "2024-04-01"
  },
  "timeSlot": null,
  "reason": null,
  "status": "APPROVED",
  "submittedAt": "2024-03-28T10:00:00+09:00",
  "approverId": "MGR-001",
  "approverName": "鈴木部長",
  "approvedAt": "2024-03-29T14:00:00+09:00",
  "rejectionReason": null,
  "rejectedAt": null,
  "cancelledAt": null,
  "operationHistory": [
    {
      "action": "APPROVED",
      "performedBy": "MGR-001",
      "performedByName": "鈴木部長",
      "performedAt": "2024-03-29T14:00:00+09:00",
      "comment": null
    },
    {
      "action": "SUBMITTED",
      "performedBy": "EMP-001",
      "performedByName": "山田太郎",
      "performedAt": "2024-03-28T10:00:00+09:00",
      "comment": null
    }
  ]
}
```

| フィールド | 型 | 説明 | 備考 |
|-----------|-----|------|------|
| requestId | string (LeaveRequestId) | 休暇申請ID | - |
| employeeId | string (EmployeeId) | 申請者ID | - |
| employeeName | string | 申請者名 | 従業員マスタから導出 |
| leaveType | string (LeaveType) | 休暇種別 | - |
| leavePeriod | object (LeavePeriod) | 取得期間 | - |
| timeSlot | object (TimeSlot) / null | 取得時間帯（HOURLY時のみ） | - |
| reason | string (LeaveReason) / null | 申請理由 | - |
| status | string (RequestStatus) | ステータス | - |
| submittedAt | string (ISO 8601) | 申請日時 | - |
| approverId | string (ApproverId) / null | 承認者ID | - |
| approverName | string / null | 承認者名 | 従業員マスタから導出 |
| approvedAt | string (ISO 8601) / null | 承認日時 | - |
| rejectionReason | string / null | 却下理由 | - |
| rejectedAt | string (ISO 8601) / null | 却下日時 | - |
| cancelledAt | string (ISO 8601) / null | 取り消し日時 | - |
| operationHistory | array (OperationHistoryItem) | 操作履歴 | イベントテーブルから導出、降順 |

#### OperationHistoryItem

| フィールド | 型 | 説明 |
|-----------|-----|------|
| action | string | 操作種別（SUBMITTED / APPROVED / REJECTED / CANCELLED） |
| performedBy | string | 操作者ID |
| performedByName | string | 操作者名（従業員マスタから導出） |
| performedAt | string (ISO 8601) | 操作日時 |
| comment | string / null | コメント（却下理由等） |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 403 | `/errors/forbidden` | 申請者本人でも上長でもない |
| 404 | `/errors/not-found` | 休暇申請が存在しない |

---

### GET /api/v1/leave-requests/pending-approvals

**説明:** 承認待ち休暇申請一覧を取得する（管理職用）

**認可:** 管理職（上長）

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| employeeName | string | - | null | 申請者名で部分一致検索 |
| leaveType | string (LeaveType) | - | 全件 | 休暇種別で絞り込み |
| dateFrom | string (date) | - | 当月1日 | 取得期間の開始日 |
| dateTo | string (date) | - | 当月末日 | 取得期間の終了日 |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数 |
| sort | string | - | `submittedAt,asc` | ソート（`submittedAt`, `employeeName`, `leaveType`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "requestId": "LR-20240401-001",
      "employeeId": "EMP-001",
      "employeeName": "山田太郎",
      "leaveType": "ANNUAL",
      "leavePeriod": {
        "from": "2024-04-01",
        "to": "2024-04-01"
      },
      "reason": null,
      "submittedAt": "2024-03-28T10:00:00+09:00"
    },
    {
      "requestId": "LR-20240415-003",
      "employeeId": "EMP-003",
      "employeeName": "佐藤花子",
      "leaveType": "SPECIAL_CONDOLENCE",
      "leavePeriod": {
        "from": "2024-04-15",
        "to": "2024-04-17"
      },
      "reason": "祖母逝去に伴う忌引休暇を申請いたします",
      "submittedAt": "2024-04-14T18:00:00+09:00"
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 2,
    "totalPages": 1
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 管理職権限なし |

---

## 状態遷移図

```
                  [休暇を申請する]
                        │
                        ↓
(初期状態) ──────→ SUBMITTED
                    │   │   │
     [承認する]─────┘   │   └─────[取り消す]
          │             │              │
          ↓        [却下する]          ↓
      APPROVED          │         CANCELLED
                        ↓
                    REJECTED
```

| 遷移元 | 遷移先 | トリガー | ガード条件 |
|--------|--------|---------|-----------|
| (初期) | SUBMITTED | 休暇を申請する | 休暇種別+取得期間が入力済み、有給残高チェック（有給種別の場合） |
| SUBMITTED | APPROVED | 休暇申請を承認する | 承認者が申請者の上長であること |
| SUBMITTED | REJECTED | 休暇申請を却下する | 承認者が上長であること、却下理由必須 |
| SUBMITTED | CANCELLED | 休暇申請を取り消す | 申請者本人であること |

> **注記:** APPROVED / REJECTED / CANCELLED は
> 終端状態であり、以降の遷移は不可。

---

## 不変条件

| ID | ルール |
|----|--------|
| INV-LR-001 | leavePeriod.from ≤ leavePeriod.to |
| INV-LR-002 | HOURLY の場合、timeSlot 必須かつ上限5時間 |
| INV-LR-003 | 特別休暇（SPECIAL_*）の場合、reason 必須 |
| INV-LR-004 | reason は10-200文字 |
| INV-LR-005 | 同一日に APPROVED 状態の休暇が重複しないこと |
| INV-LR-006 | 有給種別の場合、有給残高 ≥ 申請日数 |
| INV-LR-007 | 承認・却下は SUBMITTED 状態のみ可能 |
| INV-LR-008 | 取り消しは SUBMITTED 状態かつ申請者本人のみ可能 |
| INV-LR-009 | rejectionReason は10-200文字 |

---

## エラーレスポンス形式

RFC 7807 準拠:

```json
{
  "type": "https://api.example.com/errors/validation",
  "title": "Validation Error",
  "status": 400,
  "detail": "timeSlot は HOURLY 休暇の場合に必須です",
  "instance": "/api/v1/leave-requests",
  "errors": [
    {
      "field": "timeSlot",
      "message": "HOURLY 休暇の場合に必須です",
      "rejectedValue": null
    }
  ]
}
```

---

## 認証・認可

### 認証

`Authorization: Bearer {token}` ヘッダー必須。

### 認可マトリクス

| エンドポイント | 従業員本人 | 管理職（上長） |
|--------------|:---------:|:------------:|
| POST /leave-requests | ✅ | - |
| POST /leave-requests/{id}/actions/approve | - | ✅ |
| POST /leave-requests/{id}/actions/reject | - | ✅ |
| POST /leave-requests/{id}/actions/cancel | ✅（申請者本人のみ） | - |
| GET /leave-requests | ✅ | - |
| GET /leave-requests/{id} | ✅ | ✅ |
| GET /leave-requests/pending-approvals | - | ✅ |

### アクセス制御の補足

- 休暇申請は**従業員本人のみ**が可能
- 承認・却下は**申請者の上長のみ**が可能
  - 上長-部下関係の検証あり
- 取り消しは**申請者本人のみ**かつ**SUBMITTED状態**のみ
- 詳細取得は**申請者本人 + その上長**が可能
- 承認待ち一覧は**管理職（上長）のみ**
  - 自分の部下の申請のみ表示

---

## ページネーション

offset 方式を採用:

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| page | number | 0 | ページ番号（0始まり） |
| size | number | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `{field},{direction}` 形式 |

**レスポンスメタデータ:**

```json
{
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
}
```

---

## Saga連携

### 休暇承認Saga

休暇申請が承認（APPROVED）された後、
以下の後処理を休暇承認Sagaが実行する:

| ステップ | 処理 | 補償アクション |
|---------|------|--------------|
| 1 | 有給残高消化（有給種別の場合） | 有給残高を戻す |
| 2 | 勤怠ステータス更新（対象日を休暇扱い） | 勤怠ステータスを元に戻す |
| 3 | Googleカレンダー同期（承認済み休暇を登録） | カレンダーイベントを削除 |

> **注記:** Saga の各ステップが失敗した場合、
> 補償アクションにより一貫性を保つ。
> 承認自体は取り消されず、
> Saga失敗時はリトライまたは手動対応とする。
