# 有給残高 API

## 概要

従業員の有給休暇の付与・消化・時効消滅を管理し、
残日数の照会および手動調整を提供する。

**ベースパス:** `/api/v1/paid-leave-balances`
**認証:** `Authorization: Bearer {token}`
**エラー形式:** RFC 7807

---

## エンドポイント一覧

### 公開エンドポイント（人事・従業員向け）

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | `/paid-leave-balances/{id}/actions/grant-special` | 特別休暇を付与する | 必須 |
| POST | `/paid-leave-balances/{id}/actions/adjust` | 有給残高を手動調整する | 必須 |
| GET | `/paid-leave-balances/remaining` | 有給残日数照会 | 必須 |
| GET | `/paid-leave-balances/dashboard` | 有給取得状況ダッシュボード | 必須 |
| GET | `/paid-leave-balances/special-remaining` | 特別休暇残日数照会 | 必須 |

### 内部エンドポイント（システム間連携用・非公開）

| メソッド | パス | 説明 | 呼び出し元 |
|---------|------|------|-----------|
| POST | `/internal/paid-leave-balances/grant` | 有給を付与する | 付与バッチ（日次） |
| POST | `/internal/paid-leave-balances/consume` | 有給を消化する | 休暇申請集約（承認時） |
| POST | `/internal/paid-leave-balances/consume-special` | 特別休暇を消化する | 休暇申請集約（承認時） |
| POST | `/internal/paid-leave-balances/expire` | 時効消滅させる | 時効バッチ（日次） |

> **注記:** 内部エンドポイントは
> API Gateway で外部公開しない。
> サービス間認証（mTLS 等）で保護する。

---

## 公開エンドポイント詳細

---

### POST /api/v1/paid-leave-balances/{id}/actions/grant-special

**説明:** 特別休暇を付与する

**実行者:** 人事担当者

**リクエスト:**

```json
{
  "type": "SPECIAL_BEREAVEMENT",
  "days": 5.0,
  "expiryDate": "2025-03-31"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| type | string (enum) | ✅ | `SPECIAL_BEREAVEMENT` / `SPECIAL_REFRESH` | 特別休暇種別 |
| days | number (LeaveDays) | ✅ | 種別ごとの上限 | 付与日数 |
| expiryDate | string (date) | ✅ | 付与日以降 | 有効期限 |

**レスポンス: 200 OK**

```json
{
  "leaveBalanceId": "LB-EMP001",
  "employeeId": "EMP-001",
  "grantId": "LG-20240401-001",
  "type": "SPECIAL_BEREAVEMENT",
  "grantedDays": 5.0,
  "expiryDate": "2025-03-31",
  "updatedAt": "2024-04-01T10:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（種別不正、日数不正等） |
| 404 | `/errors/not-found` | 有給残高が存在しない |

---

### POST /api/v1/paid-leave-balances/{id}/actions/adjust

**説明:** 有給残高を手動調整する

**実行者:** 人事担当者

**リクエスト:**

```json
{
  "employeeId": "EMP-001",
  "type": "CORRECTION",
  "days": 2.0,
  "reason": "前年度付与日数の計算誤りによる補正（人事部承認済み）"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| employeeId | string (EmployeeId) | ✅ | 存在する従業員 | 対象従業員 |
| type | string (enum) | ✅ | `TRANSFER_IN` / `CORRECTION` / `MANUAL_GRANT` | 調整種別 |
| days | number (LeaveDays) | ✅ | -20.0 〜 +20.0 | 調整日数（負は減算） |
| reason | string (AdjustmentReason) | ✅ | 10-500文字 | 調整理由 |

**前提条件:**
- 調整後の残日数 ≧ 0

**レスポンス: 200 OK**

```json
{
  "leaveBalanceId": "LB-EMP001",
  "employeeId": "EMP-001",
  "adjustmentType": "CORRECTION",
  "adjustedDays": 2.0,
  "reason": "前年度付与日数の計算誤りによる補正（人事部承認済み）",
  "totalRemainingDays": 15.0,
  "adjustedAt": "2024-04-01T10:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（日数範囲外、理由文字数不足等） |
| 404 | `/errors/not-found` | 有給残高が存在しない |
| 422 | `/errors/precondition` | 調整後の残日数がマイナスになる |

---

## クエリエンドポイント詳細

---

### GET /api/v1/paid-leave-balances/remaining

**説明:** 有給残日数を照会する

**認可:** 本人 + 上長 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| employeeId | string | - | ログインユーザー | 従業員ID |
| fiscalYear | number | - | 当年度 | 対象年度 |

**レスポンス: 200 OK**

```json
{
  "employeeId": "EMP-001",
  "fiscalYear": 2024,
  "totalRemainingDays": 15.0,
  "totalRemainingHours": 16,
  "hourlyUsedThisYear": 24,
  "annualConsumedDays": 8.0,
  "nextExpiryDate": "2025-04-01",
  "nextExpiryDays": 5.0
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| employeeId | string (EmployeeId) | 従業員ID |
| fiscalYear | number | 対象年度 |
| totalRemainingDays | number (LeaveDays) | 残日数合計 |
| totalRemainingHours | number (LeaveHours) | 残時間（時間単位有給） |
| hourlyUsedThisYear | number | 今年度の時間単位消化数 |
| annualConsumedDays | number (LeaveDays) | 年5日義務の進捗 |
| nextExpiryDate | string (date) / null | 次の時効日 |
| nextExpiryDays | number (LeaveDays) / null | 時効予定日数 |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 他人のデータへのアクセス権なし |

---

### GET /api/v1/paid-leave-balances/dashboard

**説明:** 有給取得状況ダッシュボードを取得する

**認可:** 上長 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| departmentId | string | - | 上長の部署 | 部署ID |
| fiscalYear | number | - | 当年度 | 対象年度 |
| obligationMet | boolean | - | 全て | 年5日義務達成で絞り込み |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数 |
| sort | string | - | `employeeName,asc` | ソート（`employeeName`, `consumedDays`, `remainingDays`, `obligationMet`, `nextExpiryDate`） |

**レスポンス: 200 OK**

```json
{
  "kpi": {
    "totalEmployees": 16,
    "avgConsumedDays": 7.5,
    "obligationMetCount": 12,
    "obligationNotMetCount": 4,
    "obligationMetRate": 75.0
  },
  "content": [
    {
      "employeeId": "EMP-001",
      "employeeName": "山田太郎",
      "grantedDays": 20.0,
      "consumedDays": 8.0,
      "remainingDays": 12.0,
      "obligationMet": true,
      "nextExpiryDate": "2025-04-01"
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 16,
    "totalPages": 1
  }
}
```

| フィールド (kpi) | 型 | 説明 |
|-----------------|-----|------|
| totalEmployees | number | 対象従業員数 |
| avgConsumedDays | number | 平均消化日数 |
| obligationMetCount | number | 年5日義務達成者数 |
| obligationNotMetCount | number | 年5日義務未達者数 |
| obligationMetRate | number | 義務達成率（%） |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 部署へのアクセス権なし |

---

### GET /api/v1/paid-leave-balances/special-remaining

**説明:** 特別休暇残日数を照会する

**認可:** 本人 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| employeeId | string | - | ログインユーザー | 従業員ID |
| type | string (enum) | - | 全SPECIAL_*種別 | 特別休暇種別で絞り込み |

**レスポンス: 200 OK**

```json
{
  "employeeId": "EMP-001",
  "specialLeaves": [
    {
      "type": "SPECIAL_BEREAVEMENT",
      "grantedDays": 5.0,
      "consumedDays": 2.0,
      "remainingDays": 3.0,
      "expiryDate": "2025-03-31"
    },
    {
      "type": "SPECIAL_REFRESH",
      "grantedDays": 3.0,
      "consumedDays": 0.0,
      "remainingDays": 3.0,
      "expiryDate": "2025-09-30"
    }
  ]
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| employeeId | string (EmployeeId) | 従業員ID |
| specialLeaves | array | 特別休暇一覧 |
| specialLeaves[].type | string (enum) | 特別休暇種別 |
| specialLeaves[].grantedDays | number (LeaveDays) | 付与日数 |
| specialLeaves[].consumedDays | number (LeaveDays) | 消化日数 |
| specialLeaves[].remainingDays | number (LeaveDays) | 残日数 |
| specialLeaves[].expiryDate | string (date) | 有効期限 |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 他人のデータへのアクセス権なし |

---

## 内部エンドポイント詳細

> ⚠️ 以下のエンドポイントは
> サービス間通信専用。
> 外部には公開しない。

---

### POST /api/v1/internal/paid-leave-balances/grant

**説明:** 有給を付与する

**呼び出し元:** 付与バッチ（日次実行・入社日起算の基準日到達をチェック）

**前提条件:**
- 同一付与基準日で未付与であること

**リクエスト:**

```json
{
  "employeeId": "EMP-001",
  "grantDate": "2024-04-01",
  "days": 20.0
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| employeeId | string (EmployeeId) | ✅ | 存在する従業員 | 対象従業員 |
| grantDate | string (date) | ✅ | 付与基準日 | 付与日 |
| days | number (LeaveDays) | ✅ | 付与テーブルに準拠 | 付与日数 |

**レスポンス: 200 OK**

```json
{
  "leaveBalanceId": "LB-EMP001",
  "employeeId": "EMP-001",
  "grantId": "LG-20240401-001",
  "grantDate": "2024-04-01",
  "grantedDays": 20.0,
  "expiryDate": "2026-04-01",
  "totalRemainingDays": 35.0,
  "grantedAt": "2024-04-01T00:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（日数不正等） |
| 404 | `/errors/not-found` | 従業員が存在しない |
| 409 | `/errors/conflict` | 同一付与基準日で既に付与済み |

---

### POST /api/v1/internal/paid-leave-balances/consume

**説明:** 有給を消化する

**呼び出し元:** 休暇申請集約（承認完了時に自動実行）

**前提条件:**
- 残日数 ≧ 消化日数
- 時間単位有給の場合、年間上限40h未満であること

**消化順序:** FIFO（ExpiryDateが近いLeaveGrantから消化）

**リクエスト:**

```json
{
  "employeeId": "EMP-001",
  "unit": "FULL_DAY",
  "days": 1.0,
  "hours": null,
  "approvalId": "APR-001"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| employeeId | string (EmployeeId) | ✅ | 存在する従業員 | 対象従業員 |
| unit | string (enum) | ✅ | `FULL_DAY` / `HALF_DAY` / `HOURLY` | 消化単位 |
| days | number (LeaveDays) | - | FULL_DAY時: 1.0, HALF_DAY時: 0.5 | 消化日数 |
| hours | number (LeaveHours) | - | HOURLY時: 1-8 | 消化時間 |
| approvalId | string (ApprovalId) | ✅ | 承認済み休暇申請 | 承認ID |

**レスポンス: 200 OK**

> FIFO消化により複数のLeaveGrantにまたがる場合があるため、consumedGrants を配列で返す。

```json
{
  "leaveBalanceId": "LB-EMP001",
  "employeeId": "EMP-001",
  "consumptionId": "LC-20240415-001",
  "unit": "FULL_DAY",
  "approvalId": "APR-001",
  "consumedGrants": [
    { "grantId": "LG-20230401-001", "consumedDays": 0.5 },
    { "grantId": "LG-20240401-001", "consumedDays": 0.5 }
  ],
  "totalConsumedDays": 1.0,
  "totalRemainingDays": 14.0,
  "consumedAt": "2024-04-15T10:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー |
| 404 | `/errors/not-found` | 有給残高が存在しない |
| 422 | `/errors/precondition` | 残日数不足、または時間単位有給の年間上限超過 |

---

### POST /api/v1/internal/paid-leave-balances/consume-special

**説明:** 特別休暇を消化する

**呼び出し元:** 休暇申請集約（承認完了時に自動実行）

**前提条件:**
- 指定種別の残日数 ≧ 消化日数
- 有効期限内であること

**消化順序:** 種別ごとに分離消化（有給FIFOとは混ざらない）

**リクエスト:**

```json
{
  "employeeId": "EMP-001",
  "type": "SPECIAL_BEREAVEMENT",
  "unit": "FULL_DAY",
  "days": 1.0,
  "approvalId": "APR-002"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| employeeId | string (EmployeeId) | ✅ | 存在する従業員 | 対象従業員 |
| type | string (enum) | ✅ | `SPECIAL_BEREAVEMENT` / `SPECIAL_REFRESH` | 消化対象の特別休暇種別 |
| unit | string (enum) | ✅ | `FULL_DAY` / `HALF_DAY`（時間単位不可） | 消化単位 |
| days | number (LeaveDays) | ✅ | 種別の残日数以内 | 消化日数 |
| approvalId | string (ApprovalId) | ✅ | 承認済み休暇申請 | 承認ID |

**レスポンス: 200 OK**

> 同一種別で複数のLeaveGrantが存在する場合に備え、consumedGrants を配列で返す。

```json
{
  "leaveBalanceId": "LB-EMP001",
  "employeeId": "EMP-001",
  "consumptionId": "LC-20240420-001",
  "type": "SPECIAL_BEREAVEMENT",
  "unit": "FULL_DAY",
  "approvalId": "APR-002",
  "consumedGrants": [
    { "grantId": "LG-20240401-S01", "consumedDays": 1.0 }
  ],
  "totalConsumedDays": 1.0,
  "remainingDays": 2.0,
  "consumedAt": "2024-04-20T10:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（時間単位指定等） |
| 404 | `/errors/not-found` | 有給残高が存在しない |
| 422 | `/errors/precondition` | 種別の残日数不足、または有効期限切れ |

---

### POST /api/v1/internal/paid-leave-balances/expire

**説明:** 時効消滅させる

**呼び出し元:** 時効バッチ（日次実行・ExpiryDate到達をチェック）

**前提条件:**
- 付与日から2年が経過していること
- LeaveGrantがACTIVE状態であること

**リクエスト:**

```json
{
  "grantId": "LG-20220401-001"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| grantId | string (LeaveGrantId) | ✅ | ACTIVE状態のGrant | 対象付与 |

**レスポンス: 200 OK**

```json
{
  "leaveBalanceId": "LB-EMP001",
  "employeeId": "EMP-001",
  "grantId": "LG-20220401-001",
  "expiredDays": 5.0,
  "totalRemainingDays": 10.0,
  "expiredAt": "2024-04-01T00:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー |
| 404 | `/errors/not-found` | 対象Grantが存在しない |
| 409 | `/errors/conflict` | ACTIVE状態でない（既にCONSUMEDまたはEXPIRED） |
| 422 | `/errors/precondition` | 2年未経過 |

---

## 不変条件

| ID | ルール |
|----|--------|
| INV-LB-001 | 残日数 ≧ 0（マイナス残高は不可） |
| INV-LB-002 | 時間単位有給 ≦ 40h/年（法定上限） |
| INV-LB-003 | 有給消化はFIFO順（時効が近い付与分から消化） |
| INV-LB-004 | 時効後の消化不可（時効消滅したGrantからは消化できない） |
| INV-LB-005 | 特別休暇は種別内で消化（慶弔は慶弔枠、リフレッシュはリフレッシュ枠からのみ） |
| INV-LB-006 | 手動調整は理由必須（AdjustmentReasonが空の手動調整は不可） |

---

## エラーレスポンス形式

RFC 7807 準拠:

```json
{
  "type": "https://api.example.com/errors/validation",
  "title": "Validation Error",
  "status": 400,
  "detail": "調整日数は -20.0 〜 +20.0 の範囲で指定してください",
  "instance": "/api/v1/paid-leave-balances/LB-EMP001/actions/adjust",
  "errors": [
    {
      "field": "days",
      "message": "調整日数は -20.0 〜 +20.0 の範囲で指定してください",
      "rejectedValue": 25.0
    }
  ]
}
```

---

## 認証・認可

### 認証

`Authorization: Bearer {token}` ヘッダー必須。
内部エンドポイントはサービス間認証（mTLS 等）。

### 認可マトリクス

| エンドポイント | 従業員本人 | 上長 | 人事 | システム |
|--------------|:---------:|:----:|:----:|:-------:|
| POST /{id}/actions/grant-special | - | - | ✅ | - |
| POST /{id}/actions/adjust | - | - | ✅ | - |
| GET /remaining | ✅ | ✅ | ✅ | - |
| GET /dashboard | - | ✅ | ✅ | - |
| GET /special-remaining | ✅ | - | ✅ | - |
| POST /internal/grant | - | - | - | ✅ |
| POST /internal/consume | - | - | - | ✅ |
| POST /internal/consume-special | - | - | - | ✅ |
| POST /internal/expire | - | - | - | ✅ |

### アクセス制御の補足

- 特別休暇付与・手動調整は**人事担当者のみ**
- 有給消化・特別休暇消化は**承認済み休暇申請経由のみ**
  - 公開APIとしては休暇申請側で提供
- 有給付与は**日次バッチ経由のみ**（入社日起算の自動付与）
- 時効消滅は**日次バッチ経由のみ**（手動取消不可）
- 残日数照会は本人・上長・人事の権限に応じてアクセス可能

---

## ページネーション

offset 方式を採用:

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| page | number | 0 | ページ番号（0始まり） |
| size | number | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `{field},{direction}` 形式 |

**レスポンスメタデータ:**

```json
{
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
}
```

> **注記:** ページネーションは
> ダッシュボード（GET /dashboard）にのみ適用。
> 残日数照会・特別休暇照会は単一レコード返却のため不要。
