# 残業申請 API

## 概要

従業員の残業申請の作成・承認・却下・再申請、
および申請状況の照会を提供する。

**ベースパス:** `/api/v1/overtime-requests`
**認証:** `Authorization: Bearer {token}`
**エラー形式:** RFC 7807

---

## エンドポイント一覧

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | `/overtime-requests` | 残業を申請する | 必須 |
| GET | `/overtime-requests` | 残業申請一覧を取得する | 必須 |
| GET | `/overtime-requests/{id}` | 残業申請詳細を取得する | 必須 |
| POST | `/overtime-requests/{id}/actions/approve` | 残業申請を承認する | 必須 |
| POST | `/overtime-requests/{id}/actions/reject` | 残業申請を却下する | 必須 |
| POST | `/overtime-requests/{id}/actions/resubmit` | 残業申請を再申請する | 必須 |
| GET | `/overtime-requests/pending-approval` | 承認待ち残業申請一覧を取得する | 必須 |

---

## コマンドエンドポイント詳細

---

### POST /api/v1/overtime-requests

**説明:** 残業を申請する

**アクター:** 従業員

**前提条件:**
- 同一勤務日に承認済み申請がないこと
- 事後申請の場合、翌営業日中であること

**リクエスト:**

```json
{
  "targetDate": "2024-04-01",
  "plannedOvertime": 60,
  "reason": "月末レポート作成のため残業が必要です"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| targetDate | string (WorkDate) | ✅ | 当日または翌営業日 | 残業対象日 |
| plannedOvertime | number (PlannedOvertime) | ✅ | 15分単位、1-240分 | 予定残業時間（分） |
| reason | string (OvertimeReason) | ✅ | 10-200文字 | 残業理由 |

**レスポンス: 201 Created**

```json
{
  "overtimeRequestId": "OTR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "plannedOvertime": 60,
  "reason": "月末レポート作成のため残業が必要です",
  "status": "SUBMITTED",
  "requestedAt": "2024-04-01T09:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（時間単位不正、文字数違反等） |
| 409 | `/errors/conflict` | 同一勤務日に承認済み申請が存在する |
| 422 | `/errors/precondition` | 事後申請の期限超過 |

---

### POST /api/v1/overtime-requests/{id}/actions/approve

**説明:** 残業申請を承認する

**アクター:** 管理職（上長）

**前提条件:**
- 申請が SUBMITTED であること
- 承認者が申請者の上長であること

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string (OvertimeRequestId) | 残業申請ID |

**リクエスト:**

```json
{
  "approverId": "MGR-001"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| approverId | string (ApproverId) | ✅ | 申請者の上長 | 承認者ID |

**レスポンス: 200 OK**

```json
{
  "overtimeRequestId": "OTR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "plannedOvertime": 60,
  "status": "APPROVED",
  "approverId": "MGR-001",
  "decidedAt": "2024-04-01T10:30:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー |
| 403 | `/errors/forbidden` | 承認者が申請者の上長でない |
| 404 | `/errors/not-found` | 残業申請が存在しない |
| 409 | `/errors/conflict` | 申請が SUBMITTED でない |

**ビジネスルール（36協定チェック）:**

承認時に以下のチェックが実行される。
勤怠記録コンテキストの累計時間を参照する。

| チェック項目 | 閾値 | 超過時のアクション |
|-------------|------|-------------------|
| 月次累計 | 45h | 承認に人事追加承認が必要 |
| 年次累計 | 360h | 承認に人事追加承認が必要 |
| 特別条項月次 | 100h未満 | 承認不可 |
| 特別条項年次 | 720h | 承認不可 |
| 月45h超回数 | 年6回 | 6回到達後は承認不可 |
| 2-6ヶ月平均 | 80h | 超過見込みで承認不可 |

---

### POST /api/v1/overtime-requests/{id}/actions/reject

**説明:** 残業申請を却下する

**アクター:** 管理職（上長）

**前提条件:**
- 申請が SUBMITTED であること
- 承認者が申請者の上長であること

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string (OvertimeRequestId) | 残業申請ID |

**リクエスト:**

```json
{
  "approverId": "MGR-001",
  "rejectionReason": "当該業務は翌日の通常勤務時間内で対応可能と判断します"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| approverId | string (ApproverId) | ✅ | 申請者の上長 | 承認者ID |
| rejectionReason | string (RejectionReason) | ✅ | 10-500文字 | 却下理由 |

**レスポンス: 200 OK**

```json
{
  "overtimeRequestId": "OTR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "status": "REJECTED",
  "approverId": "MGR-001",
  "rejectionReason": "当該業務は翌日の通常勤務時間内で対応可能と判断します",
  "decidedAt": "2024-04-01T10:30:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（却下理由の文字数違反等） |
| 403 | `/errors/forbidden` | 承認者が申請者の上長でない |
| 404 | `/errors/not-found` | 残業申請が存在しない |
| 409 | `/errors/conflict` | 申請が SUBMITTED でない |

---

### POST /api/v1/overtime-requests/{id}/actions/resubmit

**説明:** 残業申請を再申請する

**アクター:** 従業員

**前提条件:**
- 申請が REJECTED であること
- 申請者本人であること

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string (OvertimeRequestId) | 残業申請ID |

**リクエスト:**

```json
{
  "plannedOvertime": 45,
  "reason": "業務範囲を見直し、最小限の残業で対応します"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| plannedOvertime | number (PlannedOvertime) | ✅ | 15分単位、1-240分 | 予定残業時間（分） |
| reason | string (OvertimeReason) | ✅ | 10-200文字 | 残業理由 |

**レスポンス: 200 OK**

```json
{
  "overtimeRequestId": "OTR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "plannedOvertime": 45,
  "reason": "業務範囲を見直し、最小限の残業で対応します",
  "status": "SUBMITTED",
  "resubmittedAt": "2024-04-01T14:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（時間単位不正、文字数違反等） |
| 403 | `/errors/forbidden` | 申請者本人でない |
| 404 | `/errors/not-found` | 残業申請が存在しない |
| 409 | `/errors/conflict` | 申請が REJECTED でない |

---

## クエリエンドポイント詳細

---

### GET /api/v1/overtime-requests

**説明:** 残業申請一覧を取得する

**認可:** 本人 + 上長 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| employeeId | string | - | ログインユーザー | 従業員ID |
| dateFrom | string (date) | - | 当月1日 | 対象期間開始日 |
| dateTo | string (date) | - | 当月末日 | 対象期間終了日 |
| status | string (enum) | - | 全て | ステータスで絞り込み（`SUBMITTED` / `APPROVED` / `REJECTED`） |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `targetDate,desc` | ソート（`targetDate`, `plannedOvertime`, `status`, `requestedAt`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "overtimeRequestId": "OTR-20240401-EMP001",
      "targetDate": "2024-04-01",
      "plannedOvertime": 60,
      "reason": "月末レポート作成のため残業が必要です",
      "status": "APPROVED",
      "requestedAt": "2024-04-01T09:00:00+09:00",
      "decidedAt": "2024-04-01T10:30:00+09:00"
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 12,
    "totalPages": 1
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 他人のデータへのアクセス権なし |

---

### GET /api/v1/overtime-requests/{id}

**説明:** 残業申請詳細を取得する

**認可:** 本人 + 上長 + 人事

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string (OvertimeRequestId) | 残業申請ID |

**レスポンス: 200 OK**

```json
{
  "overtimeRequestId": "OTR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "plannedOvertime": 60,
  "reason": "月末レポート作成のため残業が必要です",
  "status": "APPROVED",
  "approverId": "MGR-001",
  "rejectionReason": null,
  "requestedAt": "2024-04-01T09:00:00+09:00",
  "decidedAt": "2024-04-01T10:30:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 403 | `/errors/forbidden` | アクセス権なし |
| 404 | `/errors/not-found` | 残業申請が存在しない |

---

### GET /api/v1/overtime-requests/pending-approval

**説明:** 承認待ち残業申請一覧を取得する

**認可:** 上長 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| dateFrom | string (date) | - | 当月1日 | 対象期間開始日 |
| dateTo | string (date) | - | 当月末日 | 対象期間終了日 |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `requestedAt,asc` | ソート（`employeeName`, `targetDate`, `plannedOvertime`, `requestedAt`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "overtimeRequestId": "OTR-20240401-EMP002",
      "employeeId": "EMP-002",
      "employeeName": "佐藤花子",
      "targetDate": "2024-04-01",
      "plannedOvertime": 90,
      "reason": "顧客提出資料の最終確認と修正",
      "requestedAt": "2024-04-01T08:30:00+09:00"
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 3,
    "totalPages": 1
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 承認権限なし |

---

## 状態遷移図

```
DRAFT ──[残業を申請する]──→ SUBMITTED
                               │
                    [承認する]──┤──[却下する]
                       │       │       │
                       ↓       │       ↓
                   APPROVED    │   REJECTED
                  （変更不可）  │       │
                               │  [再申請する]
                               │       │
                               └───────┘
```

---

## 不変条件

| ID | ルール | 説明 |
|----|--------|------|
| INV-OT-001 | 承認者 ≠ 申請者 | 自己承認不可 |
| INV-OT-002 | APPROVED後は変更不可 | 承認後の申請は不変 |
| INV-OT-003 | 却下理由は必須 | REJECTED時は理由あり |

---

## ビジネスルール

### 36協定チェック

承認処理時に、勤怠記録コンテキストから
累計残業時間を参照してチェックを行う。

| チェック項目 | 閾値 | 超過時のアクション |
|-------------|------|-------------------|
| 月次累計 | 45h | 承認に人事追加承認が必要 |
| 年次累計 | 360h | 承認に人事追加承認が必要 |
| 特別条項月次 | 100h未満 | 承認不可 |
| 特別条項年次 | 720h | 承認不可 |
| 月45h超回数 | 年6回 | 6回到達後は承認不可 |
| 2-6ヶ月平均 | 80h | 超過見込みで承認不可 |

> **注記:** 36協定チェックは勤怠記録コンテキストの
> 累計時間を参照する。コンテキスト間のクエリが発生する。

### 事後申請ルール

| 条件 | 対応 |
|------|------|
| 当日の退勤後〜翌営業日中 | 通常承認 |
| 翌営業日超過 | 人事確認が追加で必要 |

---

## ドメインイベント

### 残業が申請された

```json
{
  "overtimeRequestId": "OTR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "plannedOvertime": 60,
  "reason": "月末レポート作成のため残業が必要です",
  "requestedAt": "2024-04-01T09:00:00+09:00"
}
```

### 残業申請が承認された

```json
{
  "overtimeRequestId": "OTR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "plannedOvertime": 60,
  "approverId": "MGR-001",
  "decidedAt": "2024-04-01T10:30:00+09:00"
}
```

### 残業申請が却下された

```json
{
  "overtimeRequestId": "OTR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "approverId": "MGR-001",
  "rejectionReason": "当該業務は翌日の通常勤務時間内で対応可能と判断します",
  "decidedAt": "2024-04-01T10:30:00+09:00"
}
```

### 残業申請が再申請された

```json
{
  "overtimeRequestId": "OTR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "plannedOvertime": 45,
  "reason": "業務範囲を見直し、最小限の残業で対応します",
  "resubmittedAt": "2024-04-01T14:00:00+09:00"
}
```

---

## エラーレスポンス形式

RFC 7807 準拠:

```json
{
  "type": "https://api.example.com/errors/validation",
  "title": "Validation Error",
  "status": 400,
  "detail": "plannedOvertime は15分単位で指定してください",
  "instance": "/api/v1/overtime-requests",
  "errors": [
    {
      "field": "plannedOvertime",
      "message": "15分単位で指定してください",
      "rejectedValue": 50
    }
  ]
}
```

---

## 認証・認可

### 認証

`Authorization: Bearer {token}` ヘッダー必須。

### 認可マトリクス

| エンドポイント | 従業員本人 | 上長 | 人事 |
|--------------|:---------:|:----:|:----:|
| POST /overtime-requests | ✅ | - | - |
| GET /overtime-requests | ✅ | ✅ | ✅ |
| GET /overtime-requests/{id} | ✅ | ✅ | ✅ |
| POST /{id}/actions/approve | - | ✅ | - |
| POST /{id}/actions/reject | - | ✅ | - |
| POST /{id}/actions/resubmit | ✅ | - | - |
| GET /pending-approval | - | ✅ | ✅ |

### アクセス制御の補足

- 残業申請の作成・再申請は**従業員本人のみ**
- 承認・却下は**申請者の上長のみ**
  - 自己承認は不可（INV-OT-001）
- 一覧・詳細の参照は**本人・上長・人事**
- **APPROVED 後の変更は一切不可**（INV-OT-002）

---

## ページネーション

offset 方式を採用:

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| page | number | 0 | ページ番号（0始まり） |
| size | number | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `{field},{direction}` 形式 |

**レスポンスメタデータ:**

```json
{
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
}
```

---

## 申し送り事項

- 36協定チェックは勤怠記録コンテキストの
  累計時間を参照するため、
  コンテキスト間のクエリAPIが必要
- 申請系集約は共通パターン
  （DRAFT→SUBMITTED→APPROVED/REJECTED）で統一
- 通知コンテキストの詳細設計は
  Phase 3 で通知チャネル・テンプレートを決定予定
