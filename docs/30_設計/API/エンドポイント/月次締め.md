# 月次締め API

## 概要

月次の勤怠データの仮締め・本締め、
および給与データエクスポートを提供する。

**ベースパス:** `/api/v1/monthly-closings`
**認証:** `Authorization: Bearer {token}`
**エラー形式:** RFC 7807

---

## エンドポイント一覧

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | `/monthly-closings/actions/preliminary-close` | 仮締めする | 必須 |
| POST | `/monthly-closings/actions/finalize` | 本締めする | 必須 |
| POST | `/monthly-closings/actions/export-payroll` | 給与データをエクスポートする | 必須 |
| GET | `/monthly-closings/dashboard` | 月次締め状況ダッシュボード | 必須 |
| GET | `/monthly-closings/{monthlyClosingId}` | 月次締め詳細取得 | 必須 |

---

## コマンドエンドポイント詳細

---

### POST /api/v1/monthly-closings/actions/preliminary-close

**説明:** 仮締めする

**アクター:** 人事担当者

**冪等性:** あり（NOT_STARTEDからもPRELIMINARY_CLOSEDからも再実行可能）

**前提条件:**
- 対象月が終了していること
- FINALIZED でないこと

**リクエスト:**

```json
{
  "month": {
    "year": 2024,
    "month": 4
  }
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| month | object (ClosingMonth) | ✅ | 当月以前 | 対象年月 |
| month.year | number | ✅ | - | 年 |
| month.month | number | ✅ | 1-12 | 月 |

**レスポンス: 200 OK**

```json
{
  "monthlyClosingId": "MC-202404",
  "month": {
    "year": 2024,
    "month": 4
  },
  "status": "PRELIMINARY_CLOSED",
  "preliminaryResult": {
    "totalEmployees": 50,
    "missingClockCount": 3,
    "pendingApprovalCount": 2,
    "flexDeficitCount": 1,
    "hasIssues": true
  },
  "closedBy": "HR-001",
  "closedAt": "2024-05-01T10:00:00+09:00"
}
```

**後処理:**
- 未打刻・未承認がある場合、該当者と上長にリマインド通知
- フレックス勤務者の月所定不足を検知し、PreliminaryClosingResultに記録

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（月の値が不正等） |
| 409 | `/errors/conflict` | FINALIZED 状態で実行不可 |
| 422 | `/errors/precondition` | 対象月がまだ終了していない |

---

### POST /api/v1/monthly-closings/actions/finalize

**説明:** 本締めする

**アクター:** 人事担当者

**冪等性:** あり

**前提条件:**
- PRELIMINARY_CLOSED であること
- 未打刻件数 = 0
- 未承認件数 = 0

**リクエスト:**

```json
{
  "month": {
    "year": 2024,
    "month": 4
  }
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| month | object (ClosingMonth) | ✅ | 仮締め済みの月 | 対象年月 |
| month.year | number | ✅ | - | 年 |
| month.month | number | ✅ | 1-12 | 月 |

**レスポンス: 200 OK**

```json
{
  "monthlyClosingId": "MC-202404",
  "month": {
    "year": 2024,
    "month": 4
  },
  "status": "FINALIZED",
  "totalEmployees": 50,
  "finalClosedAt": "2024-05-02T10:00:00+09:00",
  "closedBy": "HR-001"
}
```

**後処理:**
- 対象月の全勤怠記録を FINALIZED に変更
- 給与データエクスポートを自動実行

> ⚠️ **Saga注意:**
> 本締め→勤怠記録FINALIZE→エクスポートの
> Sagaはトランザクション境界に注意。

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー |
| 409 | `/errors/conflict` | PRELIMINARY_CLOSED でない（状態不正） |
| 422 | `/errors/precondition` | 未打刻件数 > 0 または 未承認件数 > 0 |

---

### POST /api/v1/monthly-closings/actions/export-payroll

**説明:** 給与データをエクスポートする

**アクター:** 人事担当者 / システム（本締め後に自動実行）

**冪等性:** あり（同一月の再実行は上書き）

**前提条件:**
- FINALIZED であること

**リクエスト:**

```json
{
  "month": {
    "year": 2024,
    "month": 4
  }
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| month | object (ClosingMonth) | ✅ | FINALIZED済みの月 | 対象年月 |
| month.year | number | ✅ | - | 年 |
| month.month | number | ✅ | 1-12 | 月 |

**レスポンス: 202 Accepted**

```json
{
  "monthlyClosingId": "MC-202404",
  "month": {
    "year": 2024,
    "month": 4
  },
  "exportStatus": "PROCESSING",
  "statusUrl": "/api/v1/monthly-closings/MC-202404/export-status",
  "acceptedAt": "2024-05-02T10:05:00+09:00"
}
```

> **注記:** 非同期ジョブとして実行される。
> ステータス確認は後述のエンドポイントを使用する。

**エクスポート完了後のレスポンス（ステータス確認時）:**

```json
{
  "monthlyClosingId": "MC-202404",
  "month": {
    "year": 2024,
    "month": 4
  },
  "exportStatus": "COMPLETED",
  "exportResult": {
    "filePath": "s3://payroll-exports/2024/04/payroll-202404.csv",
    "format": "CSV",
    "recordCount": 50,
    "exportedAt": "2024-05-02T10:06:00+09:00",
    "exportedBy": "HR-001"
  },
  "downloadUrl": "https://api.example.com/api/v1/monthly-closings/MC-202404/export-download"
}
```

**後処理:**
- 対象月の全勤怠データをCSV形式で出力
- ファイルはS3に保存し、ダウンロードURLを提供

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー |
| 409 | `/errors/conflict` | FINALIZED でない（エクスポート不可） |

---

### GET /api/v1/monthly-closings/{monthlyClosingId}/export-status

**説明:** 給与データエクスポートのステータスを確認する

**認可:** 人事

**レスポンス: 200 OK**

処理中:

```json
{
  "monthlyClosingId": "MC-202404",
  "exportStatus": "PROCESSING",
  "startedAt": "2024-05-02T10:05:00+09:00"
}
```

完了:

```json
{
  "monthlyClosingId": "MC-202404",
  "exportStatus": "COMPLETED",
  "exportResult": {
    "filePath": "s3://payroll-exports/2024/04/payroll-202404.csv",
    "format": "CSV",
    "recordCount": 50,
    "exportedAt": "2024-05-02T10:06:00+09:00",
    "exportedBy": "HR-001"
  },
  "downloadUrl": "https://api.example.com/api/v1/monthly-closings/MC-202404/export-download"
}
```

失敗:

```json
{
  "monthlyClosingId": "MC-202404",
  "exportStatus": "FAILED",
  "error": {
    "type": "https://api.example.com/errors/export-failed",
    "title": "Export Failed",
    "detail": "S3への書き込みに失敗しました"
  },
  "failedAt": "2024-05-02T10:06:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 404 | `/errors/not-found` | 月次締めIDが存在しない |

---

## クエリエンドポイント詳細

---

### GET /api/v1/monthly-closings/dashboard

**説明:** 月次締め状況ダッシュボードを取得する

**認可:** 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| monthFrom | string (YYYY-MM) | - | 12ヶ月前 | 期間開始年月 |
| monthTo | string (YYYY-MM) | - | 当月 | 期間終了年月 |
| status | string (enum) | - | 全て | 締めステータスで絞り込み（`NOT_STARTED` / `PRELIMINARY_CLOSED` / `FINALIZED`） |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `month,desc` | ソート（`month`, `status`, `missingClockCount`, `pendingApprovalCount`, `finalClosedAt`） |

**レスポンス: 200 OK**

```json
{
  "kpi": {
    "currentMonthStatus": "PRELIMINARY_CLOSED",
    "totalMissingClockCount": 12,
    "totalPendingApprovalCount": 5,
    "flexDeficitEmployeeCount": 3,
    "finalizedMonthCount": 11
  },
  "content": [
    {
      "monthlyClosingId": "MC-202404",
      "month": {
        "year": 2024,
        "month": 4
      },
      "status": "FINALIZED",
      "totalEmployees": 50,
      "missingClockCount": 0,
      "pendingApprovalCount": 0,
      "flexDeficitCount": 0,
      "exportStatus": "COMPLETED",
      "finalClosedAt": "2024-05-02T10:00:00+09:00"
    },
    {
      "monthlyClosingId": "MC-202405",
      "month": {
        "year": 2024,
        "month": 5
      },
      "status": "PRELIMINARY_CLOSED",
      "totalEmployees": 50,
      "missingClockCount": 3,
      "pendingApprovalCount": 2,
      "flexDeficitCount": 1,
      "exportStatus": null,
      "finalClosedAt": null
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 12,
    "totalPages": 1
  }
}
```

#### kpi オブジェクト

| フィールド | 型 | 説明 |
|-----------|-----|------|
| kpi | object | KPIカード表示用の集計値 |
| kpi.currentMonthStatus | string (enum) / null | 当月の締めステータス（`NOT_STARTED` / `PRELIMINARY_CLOSED` / `FINALIZED`）。当月の月次締めが未作成の場合は `null` |
| kpi.totalMissingClockCount | number | 当月の未打刻件数（全従業員合計） |
| kpi.totalPendingApprovalCount | number | 当月の未承認件数（全従業員合計） |
| kpi.flexDeficitEmployeeCount | number | 当月のフレックス月所定不足の従業員数 |
| kpi.finalizedMonthCount | number | 検索期間内で FINALIZED 済みの月数 |

#### content 配列（月別一覧）

| フィールド | 型 | 説明 |
|-----------|-----|------|
| monthlyClosingId | string (MonthlyClosingId) | 月次締めID |
| month | object (ClosingMonth) | 対象年月 |
| status | string (enum) | 締めステータス（`NOT_STARTED` / `PRELIMINARY_CLOSED` / `FINALIZED`） |
| totalEmployees | number | 対象従業員数 |
| missingClockCount | number | 未打刻件数 |
| pendingApprovalCount | number | 未承認件数 |
| flexDeficitCount | number | フレックス月所定不足件数 |
| exportStatus | string / null | エクスポート状態（`PROCESSING` / `COMPLETED` / `FAILED` / null） |
| finalClosedAt | string (ISO 8601) / null | 本締め日時 |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 人事権限なし |

---

### GET /api/v1/monthly-closings/{monthlyClosingId}

**説明:** 月次締めの詳細情報を取得する

**認可:** 人事

**レスポンス: 200 OK**

```json
{
  "monthlyClosingId": "MC-202404",
  "month": {
    "year": 2024,
    "month": 4
  },
  "status": "FINALIZED",
  "totalEmployees": 50,
  "preliminaryResult": {
    "totalEmployees": 50,
    "missingClockCount": 0,
    "pendingApprovalCount": 0,
    "flexDeficitCount": 0,
    "hasIssues": false
  },
  "exportResult": {
    "filePath": "s3://payroll-exports/2024/04/payroll-202404.csv",
    "format": "CSV",
    "recordCount": 50,
    "exportedAt": "2024-05-02T10:06:00+09:00",
    "exportedBy": "HR-001"
  },
  "closedBy": "HR-001",
  "preliminaryClosedAt": "2024-05-01T10:00:00+09:00",
  "finalClosedAt": "2024-05-02T10:00:00+09:00",
  "createdAt": "2024-05-01T10:00:00+09:00",
  "updatedAt": "2024-05-02T10:06:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 404 | `/errors/not-found` | 月次締めIDが存在しない |
| 403 | `/errors/forbidden` | 人事権限なし |

---

## 状態遷移図

```
NOT_STARTED ──[仮締めする]──→ PRELIMINARY_CLOSED
                                     │
                         [仮締めする（再実行）]──→ PRELIMINARY_CLOSED（自己遷移）
                                     │
                             [本締めする]
                          (未打刻=0, 未承認=0)
                                     │
                                     ↓
                                FINALIZED（変更不可）
                                     │
                          [給与データエクスポート]
                                     │
                                     ↓
                               エクスポート完了
```

---

## 不変条件

| ID | ルール | 説明 |
|----|--------|------|
| INV-MC-001 | FINALIZED後は再実行不可 | 本締め後の月次締めは変更不可 |
| INV-MC-002 | 本締めは未打刻/未承認=0 | 全データが揃っていること |
| INV-MC-003 | 月次1回のみFINALIZE | 同月に複数回の本締め不可 |

---

## エラーレスポンス形式

RFC 7807 準拠:

```json
{
  "type": "https://api.example.com/errors/validation",
  "title": "Validation Error",
  "status": 400,
  "detail": "対象月がまだ終了していません",
  "instance": "/api/v1/monthly-closings/actions/preliminary-close",
  "errors": [
    {
      "field": "month",
      "message": "当月以前の月を指定してください",
      "rejectedValue": { "year": 2024, "month": 12 }
    }
  ]
}
```

---

## 認証・認可

### 認証

`Authorization: Bearer {token}` ヘッダー必須。

### 認可マトリクス

| エンドポイント | 人事担当者 | システム |
|--------------|:---------:|:-------:|
| POST /actions/preliminary-close | ✅ | - |
| POST /actions/finalize | ✅ | - |
| POST /actions/export-payroll | ✅ | ✅（本締め後に自動実行） |
| GET /dashboard | ✅ | - |
| GET /{monthlyClosingId} | ✅ | - |
| GET /{monthlyClosingId}/export-status | ✅ | - |

### アクセス制御の補足

- 仮締め・本締めは**人事担当者のみ**実行可能
- 給与データエクスポートは人事担当者が
  手動実行するか、本締め後にシステムが自動実行
- ダッシュボード・詳細取得は**人事権限が必要**
- **FINALIZED 後の再実行は一切不可**
  （給与データエクスポートの再実行は冪等で許可）

---

## ページネーション

offset 方式を採用:

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| page | number | 0 | ページ番号（0始まり） |
| size | number | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `{field},{direction}` 形式 |

**レスポンスメタデータ:**

```json
{
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
}
```

---

## ドメインイベント

本APIのコマンド実行時に発行されるイベント:

### 月次が仮締めされた

| フィールド | 型 | 説明 |
|-----------|-----|------|
| monthlyClosingId | MonthlyClosingId | 月次締めID |
| month | ClosingMonth | 対象年月 |
| closedBy | ClosedBy | 実行者 |
| totalEmployees | int | 対象従業員数 |
| missingClockCount | int | 未打刻件数 |
| pendingApprovalCount | int | 未承認件数 |
| flexDeficitCount | int | フレックス月所定不足件数 |
| hasIssues | boolean | 問題ありフラグ |

### 月次が本締めされた

| フィールド | 型 | 説明 |
|-----------|-----|------|
| monthlyClosingId | MonthlyClosingId | 月次締めID |
| month | ClosingMonth | 対象年月 |
| closedBy | ClosedBy | 実行者 |
| totalEmployees | int | 対象従業員数 |
| finalClosedAt | DateTime | 本締め日時 |

### 給与データがエクスポートされた

| フィールド | 型 | 説明 |
|-----------|-----|------|
| monthlyClosingId | MonthlyClosingId | 月次締めID |
| month | ClosingMonth | 対象年月 |
| filePath | String | ファイルパス |
| format | ExportFormat | 出力形式（CSV） |
| recordCount | int | レコード数 |
| exportedBy | ClosedBy | 実行者 |
| exportedAt | DateTime | エクスポート日時 |

---

## 申し送り事項

### 設計判断
- 月次締め処理に冪等性を要求 → 中断復旧の信頼性確保

### 未決事項
- 既存給与システムのCSVフォーマット仕様（MVPは汎用フォーマットで先行）
- 通知コンテキストの詳細設計（通知チャネル・テンプレート未定）

### 注意事項
- 月次本締め→勤怠記録FINALIZE→CSVエクスポートのSagaはトランザクション境界に注意
