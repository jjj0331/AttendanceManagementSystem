# 打刻修正申請 API

## 概要

従業員の打刻修正申請の作成・上長承認・却下・再申請・人事承認、
および申請状況の照会を提供する。
仮締め後の修正は人事承認エスカレーションが発動する
2段階承認ワークフロー。

**ベースパス:** `/api/v1/clock-corrections`
**認証:** `Authorization: Bearer {token}`
**エラー形式:** RFC 7807

---

## エンドポイント一覧

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | `/clock-corrections` | 打刻修正を申請する | 必須 |
| GET | `/clock-corrections` | 打刻修正申請一覧を取得する | 必須 |
| GET | `/clock-corrections/{id}` | 打刻修正申請詳細を取得する | 必須 |
| POST | `/clock-corrections/{id}/actions/approve` | 打刻修正を承認する（上長） | 必須 |
| POST | `/clock-corrections/{id}/actions/reject` | 打刻修正を却下する | 必須 |
| POST | `/clock-corrections/{id}/actions/resubmit` | 打刻修正を再申請する | 必須 |
| POST | `/clock-corrections/{id}/actions/approve-hr` | 打刻修正を人事承認する | 必須 |
| GET | `/clock-corrections/pending-approval` | 承認待ち打刻修正一覧を取得する（管理職用） | 必須 |
| GET | `/clock-corrections/pending-hr` | 人事承認待ち一覧を取得する（人事用） | 必須 |

---

## コマンドエンドポイント詳細

---

### POST /api/v1/clock-corrections

**説明:** 打刻修正を申請する

**アクター:** 従業員（本人）

**前提条件:**
- 対象日の勤怠記録が存在すること
- 同一日同一種別の未確定申請がないこと
- 修正前打刻時刻はシステムが自動取得

**リクエスト:**

CLOCK_OUT の場合:

```json
{
  "targetDate": "2024-04-01",
  "correctionType": "CLOCK_OUT",
  "correctedClockOut": "18:30",
  "reason": "退勤打刻を忘れたため、実際の退勤時刻に修正をお願いします"
}
```

BOTH の場合:

```json
{
  "targetDate": "2024-04-01",
  "correctionType": "BOTH",
  "correctedClockIn": "09:00",
  "correctedClockOut": "18:00",
  "reason": "ICカード不具合により出退勤両方の打刻を修正します"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| targetDate | string (WorkDate) | ✅ | 過去の勤務日 | 修正対象日 |
| correctionType | string (CorrectionType) | ✅ | `CLOCK_IN` / `CLOCK_OUT` / `BOTH` | 修正種別 |
| correctedClockIn | string (HH:mm) | CLOCK_IN/BOTH時 ✅ | 修正前と異なること | 修正後出勤時刻 |
| correctedClockOut | string (HH:mm) | CLOCK_OUT/BOTH時 ✅ | 修正前と異なること | 修正後退勤時刻 |
| reason | string (CorrectionReason) | ✅ | 10-200文字 | 修正理由 |

**レスポンス: 201 Created**

```json
{
  "clockCorrectionRequestId": "CCR-20240401-EMP001",
  "employeeId": "EMP-001",
  "employeeName": "山田太郎",
  "targetDate": "2024-04-01",
  "correctionType": "CLOCK_OUT",
  "originalClockIn": "09:00",
  "originalClockOut": "17:00",
  "correctedClockIn": null,
  "correctedClockOut": "18:30",
  "reason": "退勤打刻を忘れたため、実際の退勤時刻に修正をお願いします",
  "status": "SUBMITTED",
  "afterProvisionalClose": false,
  "requestedAt": "2024-04-02T09:00:00+09:00"
}
```

> レスポンスの時刻フィールドは HH:mm 形式。
> `original*` はシステムが勤怠記録から自動取得。
> 修正種別に該当しないフィールドは null。

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（文字数違反、Enum値不正等） |
| 404 | `/errors/not-found` | 対象日の勤怠記録が存在しない |
| 409 | `/errors/conflict` | 同一日同一種別の未確定申請が存在する |
| 422 | `/errors/precondition` | 修正後時刻が修正前時刻と同一 |

---

### POST /api/v1/clock-corrections/{id}/actions/approve

**説明:** 打刻修正を承認する（上長）

**アクター:** 管理職（上長）

**前提条件:**
- 申請が SUBMITTED であること
- 承認者が申請者の上長であること

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string (ClockCorrectionRequestId) | 打刻修正申請ID |

**リクエスト:**

```json
{
  "approverId": "MGR-001"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| approverId | string (ApproverId) | ✅ | 申請者の上長 | 承認者ID |

**レスポンス: 200 OK**

```json
{
  "clockCorrectionRequestId": "CCR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "correctionType": "CLOCK_OUT",
  "status": "COMPLETED",
  "afterProvisionalClose": false,
  "approverId": "MGR-001",
  "decidedAt": "2024-04-02T10:30:00+09:00"
}
```

**ビジネスルール（仮締め後分岐）:**

上長承認時に `afterProvisionalClose` フラグにより
遷移先が分岐する:

| フラグ | 遷移先 | レスポンスのstatus | 備考 |
|--------|--------|-------------------|------|
| false | COMPLETED | `COMPLETED` | Saga発動（打刻データ修正） |
| true | PENDING_HR | `PENDING_HR` | 人事承認待ちに遷移 |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー |
| 403 | `/errors/forbidden` | 承認者が申請者の上長でない |
| 404 | `/errors/not-found` | 打刻修正申請が存在しない |
| 409 | `/errors/conflict` | 申請が SUBMITTED でない |

---

### POST /api/v1/clock-corrections/{id}/actions/reject

**説明:** 打刻修正を却下する

**アクター:** 管理職（上長）

**前提条件:**
- 申請が SUBMITTED であること
- 承認者が申請者の上長であること

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string (ClockCorrectionRequestId) | 打刻修正申請ID |

**リクエスト:**

```json
{
  "approverId": "MGR-001",
  "rejectionReason": "勤怠記録を確認したところ、打刻時刻は正しいと判断します"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| approverId | string (ApproverId) | ✅ | 申請者の上長 | 承認者ID |
| rejectionReason | string (RejectionReason) | ✅ | 10-200文字 | 却下理由 |

**レスポンス: 200 OK**

```json
{
  "clockCorrectionRequestId": "CCR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "status": "REJECTED",
  "approverId": "MGR-001",
  "rejectionReason": "勤怠記録を確認したところ、打刻時刻は正しいと判断します",
  "decidedAt": "2024-04-02T10:30:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（却下理由の文字数違反等） |
| 403 | `/errors/forbidden` | 承認者が申請者の上長でない |
| 404 | `/errors/not-found` | 打刻修正申請が存在しない |
| 409 | `/errors/conflict` | 申請が SUBMITTED でない |

---

### POST /api/v1/clock-corrections/{id}/actions/resubmit

**説明:** 打刻修正を再申請する

**アクター:** 従業員（本人）

**前提条件:**
- 申請が REJECTED であること
- 申請者本人であること

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string (ClockCorrectionRequestId) | 打刻修正申請ID |

**リクエスト:**

```json
{
  "correctedClockOut": "18:00",
  "reason": "セキュリティカメラの記録を確認し、退勤時刻を修正しました"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| correctedClockIn | string (HH:mm) | CLOCK_IN/BOTH時 ✅ | 修正前と異なること | 更新した出勤時刻 |
| correctedClockOut | string (HH:mm) | CLOCK_OUT/BOTH時 ✅ | 修正前と異なること | 更新した退勤時刻 |
| reason | string (CorrectionReason) | ✅ | 10-200文字 | 更新した修正理由 |

**レスポンス: 200 OK**

```json
{
  "clockCorrectionRequestId": "CCR-20240401-EMP001",
  "employeeId": "EMP-001",
  "employeeName": "山田太郎",
  "targetDate": "2024-04-01",
  "correctionType": "CLOCK_OUT",
  "originalClockIn": "09:00",
  "originalClockOut": "17:00",
  "correctedClockIn": null,
  "correctedClockOut": "18:00",
  "reason": "セキュリティカメラの記録を確認し、退勤時刻を修正しました",
  "status": "SUBMITTED",
  "resubmittedAt": "2024-04-03T09:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（文字数違反等） |
| 403 | `/errors/forbidden` | 申請者本人でない |
| 404 | `/errors/not-found` | 打刻修正申請が存在しない |
| 409 | `/errors/conflict` | 申請が REJECTED でない |
| 422 | `/errors/precondition` | 修正後時刻が修正前時刻と同一 |

---

### POST /api/v1/clock-corrections/{id}/actions/approve-hr

**説明:** 打刻修正を人事承認する

**アクター:** 人事担当者

**前提条件:**
- 申請が PENDING_HR であること
- 人事担当者権限を持つこと

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string (ClockCorrectionRequestId) | 打刻修正申請ID |

**リクエスト:**

```json
{
  "hrApproverId": "HR-001"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| hrApproverId | string (ApproverId) | ✅ | 人事担当者権限 | 人事承認者ID |

**レスポンス: 200 OK**

```json
{
  "clockCorrectionRequestId": "CCR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "correctionType": "CLOCK_OUT",
  "status": "COMPLETED",
  "afterProvisionalClose": true,
  "approverId": "MGR-001",
  "hrApproverId": "HR-001",
  "decidedAt": "2024-04-02T10:30:00+09:00",
  "hrDecidedAt": "2024-04-03T11:00:00+09:00"
}
```

**Saga連携:**

COMPLETED到達後、打刻修正承認Sagaが発動:

| 修正種別 | Saga処理 |
|---------|---------|
| CLOCK_IN | 勤怠記録の出勤時刻を更新 |
| CLOCK_OUT | 勤怠記録の退勤時刻を更新→勤務時間再計算 |
| BOTH | 出退勤両方を更新→勤務時間再計算 |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー |
| 403 | `/errors/forbidden` | 人事担当者権限なし |
| 404 | `/errors/not-found` | 打刻修正申請が存在しない |
| 409 | `/errors/conflict` | 申請が PENDING_HR でない |

---

## クエリエンドポイント詳細

---

### GET /api/v1/clock-corrections

**説明:** 打刻修正申請一覧を取得する

**認可:** 本人 + 上長 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| employeeId | string | - | ログインユーザー | 従業員ID |
| dateFrom | string (date) | - | 当月1日 | 対象期間開始日 |
| dateTo | string (date) | - | 当月末日 | 対象期間終了日 |
| status | string (enum) | - | 全て | ステータスで絞り込み（`SUBMITTED` / `MGR_APPROVED` / `PENDING_HR` / `COMPLETED` / `REJECTED`） |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `requestedAt,desc` | ソート（`targetDate`, `requestedAt`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "clockCorrectionRequestId": "CCR-20240401-EMP001",
      "employeeId": "EMP-001",
      "employeeName": "山田太郎",
      "targetDate": "2024-04-01",
      "correctionType": "CLOCK_OUT",
      "originalClockIn": "09:00",
      "originalClockOut": "17:00",
      "correctedClockIn": null,
      "correctedClockOut": "18:30",
      "status": "COMPLETED",
      "afterProvisionalClose": false,
      "requestedAt": "2024-04-02T09:00:00+09:00"
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 5,
    "totalPages": 1
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 他人のデータへのアクセス権なし |

---

### GET /api/v1/clock-corrections/{id}

**説明:** 打刻修正申請詳細を取得する

**認可:** 本人 + 上長 + 人事

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| id | string (ClockCorrectionRequestId) | 打刻修正申請ID |

**レスポンス: 200 OK**

```json
{
  "clockCorrectionRequestId": "CCR-20240401-EMP001",
  "employeeId": "EMP-001",
  "employeeName": "山田太郎",
  "targetDate": "2024-04-01",
  "correctionType": "CLOCK_OUT",
  "originalClockIn": "09:00",
  "originalClockOut": "17:00",
  "correctedClockIn": null,
  "correctedClockOut": "18:30",
  "reason": "退勤打刻を忘れたため、実際の退勤時刻に修正をお願いします",
  "status": "COMPLETED",
  "afterProvisionalClose": false,
  "approverId": "MGR-001",
  "approverName": "鈴木部長",
  "hrApproverId": null,
  "hrApproverName": null,
  "rejectionReason": null,
  "requestedAt": "2024-04-02T09:00:00+09:00",
  "decidedAt": "2024-04-02T10:30:00+09:00",
  "hrDecidedAt": null,
  "version": 2,
  "operationHistory": [
    {
      "action": "COMPLETED",
      "performedBy": "MGR-001",
      "performedByName": "鈴木部長",
      "performedAt": "2024-04-02T10:30:00+09:00",
      "comment": null
    },
    {
      "action": "SUBMITTED",
      "performedBy": "EMP-001",
      "performedByName": "山田太郎",
      "performedAt": "2024-04-02T09:00:00+09:00",
      "comment": null
    }
  ]
}
```

> 時刻フィールドは HH:mm 形式。名前系フィールドは従業員マスタから導出。
> operationHistory はイベントテーブルから導出（降順）。

| フィールド | 型 | 説明 | 備考 |
|-----------|-----|------|------|
| employeeName | string | 申請者名 | 従業員マスタから導出 |
| originalClockIn | string (HH:mm) / null | 修正前出勤時刻 | 勤怠記録から取得 |
| originalClockOut | string (HH:mm) / null | 修正前退勤時刻 | 勤怠記録から取得 |
| correctedClockIn | string (HH:mm) / null | 修正後出勤時刻 | CLOCK_IN/BOTH時 |
| correctedClockOut | string (HH:mm) / null | 修正後退勤時刻 | CLOCK_OUT/BOTH時 |
| approverName | string / null | 上長承認者名 | 従業員マスタから導出 |
| hrApproverName | string / null | 人事承認者名 | 従業員マスタから導出 |
| operationHistory | array (OperationHistoryItem) | 操作履歴 | イベントテーブルから導出、降順 |

#### OperationHistoryItem

| フィールド | 型 | 説明 |
|-----------|-----|------|
| action | string | 操作種別（SUBMITTED / MGR_APPROVED / REJECTED / RESUBMITTED / HR_APPROVED / COMPLETED） |
| performedBy | string | 操作者ID |
| performedByName | string | 操作者名（従業員マスタから導出） |
| performedAt | string (ISO 8601) | 操作日時 |
| comment | string / null | コメント（却下理由等） |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 403 | `/errors/forbidden` | アクセス権なし |
| 404 | `/errors/not-found` | 打刻修正申請が存在しない |

---

### GET /api/v1/clock-corrections/pending-approval

**説明:** 承認待ち打刻修正一覧を取得する（管理職用）

**認可:** 上長 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| employeeName | string | - | - | 申請者名で絞り込み（部分一致） |
| dateFrom | string (date) | - | 当月1日 | 対象期間開始日 |
| dateTo | string (date) | - | 当月末日 | 対象期間終了日 |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `targetDate,asc` | ソート（`employeeName`, `targetDate`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "clockCorrectionRequestId": "CCR-20240401-EMP002",
      "employeeId": "EMP-002",
      "employeeName": "佐藤花子",
      "targetDate": "2024-04-01",
      "correctionType": "CLOCK_OUT",
      "originalClockIn": "09:00",
      "originalClockOut": "17:00",
      "correctedClockIn": null,
      "correctedClockOut": "19:00",
      "reason": "会議が延長し退勤打刻が遅れたため修正をお願いします",
      "afterProvisionalClose": false,
      "requestedAt": "2024-04-02T09:15:00+09:00"
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 2,
    "totalPages": 1
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 承認権限なし |

---

### GET /api/v1/clock-corrections/pending-hr

**説明:** 人事承認待ち一覧を取得する（人事用）

**認可:** 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| dateFrom | string (date) | - | 当月1日 | 対象期間開始日 |
| dateTo | string (date) | - | 当月末日 | 対象期間終了日 |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `targetDate,asc` | ソート（`employeeName`, `targetDate`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "clockCorrectionRequestId": "CCR-20240315-EMP003",
      "employeeId": "EMP-003",
      "employeeName": "田中太郎",
      "targetDate": "2024-03-15",
      "correctionType": "BOTH",
      "originalClockIn": "09:00",
      "originalClockOut": "17:00",
      "correctedClockIn": "08:30",
      "correctedClockOut": "18:00",
      "reason": "出退勤両方の打刻を修正します。ICカード不具合のため",
      "afterProvisionalClose": true,
      "approverId": "MGR-002",
      "approverName": "鈴木部長",
      "decidedAt": "2024-04-01T14:00:00+09:00",
      "requestedAt": "2024-04-01T09:00:00+09:00"
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 1,
    "totalPages": 1
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 人事担当者権限なし |

---

## 状態遷移図

```
[*] ──[打刻修正を申請する]──→ SUBMITTED
                                  │
                       [承認する]──┤──[却下する]
                          │       │       │
                          ↓       │       ↓
                    MGR_APPROVED   │   REJECTED
                      │   │       │       │
          [仮締め前]──┤   │       │  [再申請する]
              │       │   │       │       │
              ↓       │   │       └───────┘
          COMPLETED   │   │
         （Saga発動）  │   │
                      │   └──[仮締め後]
                      │           │
                      │           ↓
                      │     PENDING_HR
                      │           │
                      │    [人事承認する]
                      │           │
                      │           ↓
                      │     COMPLETED
                      │    （Saga発動）
```

---

## 不変条件

| ID | ルール | 説明 |
|----|--------|------|
| INV-FX-001 | 承認者 ≠ 申請者 | 自己承認不可 |
| INV-FX-002 | COMPLETED後は変更不可 | 終端状態の保護 |
| INV-FX-003 | 却下理由はREJECTED時必須 | rejectionReason != null |
| INV-FX-004 | 修正後時刻 ≠ 修正前時刻 | 同一時刻への修正は不可 |
| INV-FX-005 | 人事承認はPENDING_HR状態のみ | 仮締め後フローの制御 |
| INV-FX-006 | 同一日同一種別の未確定申請がないこと | 重複防止 |

---

## ビジネスルール

### 仮締め後人事承認エスカレーション

| 条件 | 処理 |
|------|------|
| 申請時に対象月が仮締め前 | afterProvisionalClose = false。上長承認で直接COMPLETED |
| 申請時に対象月が仮締め後 | afterProvisionalClose = true。上長承認後、人事承認が追加で必要 |

> **判定タイミング:** 申請時（submit時に月次締めコンテキストへ問い合わせ）

### 修正種別ごとのSaga処理

| 種別 | 修正対象 | Saga時の処理 |
|------|---------|-------------|
| CLOCK_IN | 出勤打刻時刻 | 勤怠記録の出勤時刻を更新 |
| CLOCK_OUT | 退勤打刻時刻 | 勤怠記録の退勤時刻を更新→勤務時間再計算 |
| BOTH | 出退勤両方 | 両方更新→勤務時間再計算 |

> **注記:** 打刻修正承認Sagaは勤怠記録コンテキストの
> 打刻データを修正する。コンテキスト間のコマンドが発生する。

---

## ドメインイベント

### 打刻修正が申請された

```json
{
  "requestId": "CCR-20240401-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2024-04-01",
  "correctionType": "CLOCK_OUT",
  "afterProvisionalClose": false,
  "requestedAt": "2024-04-02T09:00:00+09:00"
}
```

### 打刻修正が承認された

```json
{
  "requestId": "CCR-20240401-EMP001",
  "employeeId": "EMP-001",
  "approverId": "MGR-001",
  "afterProvisionalClose": false,
  "decidedAt": "2024-04-02T10:30:00+09:00"
}
```

### 打刻修正が却下された

```json
{
  "requestId": "CCR-20240401-EMP001",
  "employeeId": "EMP-001",
  "rejectionReason": "勤怠記録を確認したところ、打刻時刻は正しいと判断します",
  "approverId": "MGR-001",
  "decidedAt": "2024-04-02T10:30:00+09:00"
}
```

### 打刻修正が再申請された

```json
{
  "requestId": "CCR-20240401-EMP001",
  "employeeId": "EMP-001",
  "correctedClockTime": "2024-04-01T18:00:00+09:00",
  "requestedAt": "2024-04-03T09:00:00+09:00"
}
```

### 打刻修正が人事承認された

```json
{
  "requestId": "CCR-20240401-EMP001",
  "employeeId": "EMP-001",
  "hrApproverId": "HR-001",
  "hrDecidedAt": "2024-04-03T11:00:00+09:00"
}
```

---

## エラーレスポンス形式

RFC 7807 準拠:

```json
{
  "type": "https://api.example.com/errors/validation",
  "title": "Validation Error",
  "status": 400,
  "detail": "reason は10文字以上200文字以下で入力してください",
  "instance": "/api/v1/clock-corrections",
  "errors": [
    {
      "field": "reason",
      "message": "10文字以上200文字以下で入力してください",
      "rejectedValue": "短い"
    }
  ]
}
```

---

## 認証・認可

### 認証

`Authorization: Bearer {token}` ヘッダー必須。

### 認可マトリクス

| エンドポイント | 従業員本人 | 上長 | 人事 |
|--------------|:---------:|:----:|:----:|
| POST /clock-corrections | ✅ | - | - |
| GET /clock-corrections | ✅ | ✅ | ✅ |
| GET /clock-corrections/{id} | ✅ | ✅ | ✅ |
| POST /{id}/actions/approve | - | ✅ | - |
| POST /{id}/actions/reject | - | ✅ | - |
| POST /{id}/actions/resubmit | ✅ | - | - |
| POST /{id}/actions/approve-hr | - | - | ✅ |
| GET /pending-approval | - | ✅ | ✅ |
| GET /pending-hr | - | - | ✅ |

### アクセス制御の補足

- 打刻修正の申請・再申請は**従業員本人のみ**
- 上長承認・却下は**申請者の上長のみ**
  - 自己承認は不可（INV-FX-001）
- 人事承認は**人事担当者のみ**
  - PENDING_HR状態のみ対象（INV-FX-005）
- 一覧・詳細の参照は**本人・上長・人事**
- **COMPLETED 後の変更は一切不可**（INV-FX-002）

---

## ページネーション

offset 方式を採用:

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| page | number | 0 | ページ番号（0始まり） |
| size | number | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `{field},{direction}` 形式 |

**レスポンスメタデータ:**

```json
{
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
}
```

---

## 申し送り事項

- 仮締め状態の確認は月次締めコンテキストへの
  コンテキスト間クエリが発生
- 打刻修正承認Sagaは勤怠記録コンテキストへの
  コンテキスト間コマンドが発生
- 申請系集約は共通パターン
  （SUBMITTED→承認/却下→COMPLETED/REJECTED）で統一
- 打刻修正申請は2段階承認の拡張版
  （上長承認＋条件付き人事承認）
- 通知コンテキストの詳細設計は
  Phase 3 で通知チャネル・テンプレートを決定予定
