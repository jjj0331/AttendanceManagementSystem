# 勤怠記録 API

## 概要

従業員の出退勤打刻・休憩管理、
および勤怠実績の照会を提供する。

**ベースパス:** `/api/v1/attendances`
**認証:** `Authorization: Bearer {token}`
**エラー形式:** RFC 7807

---

## エンドポイント一覧

### 公開エンドポイント（従業員向け）

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | `/attendances/clock-in` | 出勤打刻 | 必須 |
| POST | `/attendances/clock-out` | 退勤打刻 | 必須 |
| POST | `/attendances/break-start` | 休憩開始 | 必須 |
| POST | `/attendances/break-end` | 休憩終了 | 必須 |
| GET | `/attendances/today` | 当日勤怠ステータス取得 | 必須 |
| GET | `/attendances/daily` | 日次勤怠一覧 | 必須 |
| GET | `/attendances/monthly-summary` | 月次勤怠サマリー | 必須 |
| GET | `/attendances/monthly-summary/export` | 月次勤怠サマリーCSV出力 | 必須 |
| GET | `/attendances/department-dashboard` | 部門別勤怠ダッシュボード | 必須 |
| GET | `/attendances/department-dashboard/export` | 部門別ダッシュボードCSV出力 | 必須 |

### 内部エンドポイント（システム間連携用・非公開）

| メソッド | パス | 説明 | 呼び出し元 |
|---------|------|------|-----------|
| POST | `/internal/attendances/correct` | 打刻修正 | 打刻修正申請集約 |
| POST | `/internal/attendances/register` | 勤務実績登録 | 手動登録申請集約 |
| POST | `/internal/attendances/finalize` | 本締め確定 | 月次締めSaga |

> **注記:** 内部エンドポイントは
> API Gateway で外部公開しない。
> サービス間認証（mTLS 等）で保護する。

---

## 公開エンドポイント詳細

---

### POST /api/v1/attendances/clock-in

**説明:** 出勤打刻する

**前提条件:**
- 当日の勤怠記録が NOT_CLOCKED であること
- シフトが割り当てられていること

**リクエスト:**

```json
{
  "employeeId": "EMP-001",
  "clockTime": "2024-04-01T09:00:00+09:00",
  "source": "WEB"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| employeeId | string (EmployeeId) | ✅ | 存在する従業員 | 従業員ID |
| clockTime | string (ISO 8601) | ✅ | 現在時刻±5分 | 打刻時刻 |
| source | string (enum) | ✅ | `WEB` / `MOBILE` | 打刻元 |

**レスポンス: 200 OK**

```json
{
  "attendanceId": "ATT-20240401-EMP001",
  "employeeId": "EMP-001",
  "workDate": "2024-04-01",
  "status": "CLOCKED_IN",
  "clockIn": "2024-04-01T09:00:00+09:00",
  "source": "WEB",
  "updatedAt": "2024-04-01T09:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（時刻範囲外等） |
| 404 | `/errors/not-found` | 従業員が存在しない |
| 409 | `/errors/conflict` | 既に出勤打刻済み（NOT_CLOCKED でない） |
| 422 | `/errors/precondition` | シフト未割り当て |

---

### POST /api/v1/attendances/clock-out

**説明:** 退勤打刻する

**前提条件:**
- 当日の勤怠記録が CLOCKED_IN であること

**リクエスト:**

```json
{
  "employeeId": "EMP-001",
  "clockTime": "2024-04-01T18:00:00+09:00",
  "source": "WEB"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| employeeId | string (EmployeeId) | ✅ | 存在する従業員 | 従業員ID |
| clockTime | string (ISO 8601) | ✅ | 出勤時刻より後 | 打刻時刻 |
| source | string (enum) | ✅ | `WEB` / `MOBILE` | 打刻元 |

**レスポンス: 200 OK**

```json
{
  "attendanceId": "ATT-20240401-EMP001",
  "employeeId": "EMP-001",
  "workDate": "2024-04-01",
  "status": "CLOCKED_OUT",
  "clockIn": "2024-04-01T09:00:00+09:00",
  "clockOut": "2024-04-01T18:00:00+09:00",
  "breakMinutes": 60,
  "netWorkMinutes": 480,
  "overtimeMinutes": 0,
  "source": "WEB",
  "updatedAt": "2024-04-01T18:00:00+09:00"
}
```

**後処理:** 勤務時間を自動計算する

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（出勤時刻以前等） |
| 404 | `/errors/not-found` | 従業員が存在しない |
| 409 | `/errors/conflict` | CLOCKED_IN でない |

---

### POST /api/v1/attendances/break-start

**説明:** 休憩開始する

**前提条件:**
- CLOCKED_IN であること
- 休憩中でないこと

**リクエスト:**

```json
{
  "employeeId": "EMP-001",
  "clockTime": "2024-04-01T12:00:00+09:00",
  "source": "WEB"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| employeeId | string (EmployeeId) | ✅ | 存在する従業員 | 従業員ID |
| clockTime | string (ISO 8601) | ✅ | 出勤時刻より後 | 打刻時刻 |
| source | string (enum) | ✅ | `WEB` / `MOBILE` | 打刻元 |

**レスポンス: 200 OK**

```json
{
  "attendanceId": "ATT-20240401-EMP001",
  "employeeId": "EMP-001",
  "workDate": "2024-04-01",
  "status": "CLOCKED_IN",
  "onBreak": true,
  "currentBreakStart": "2024-04-01T12:00:00+09:00",
  "updatedAt": "2024-04-01T12:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー |
| 404 | `/errors/not-found` | 従業員が存在しない |
| 409 | `/errors/conflict` | CLOCKED_IN でない、または既に休憩中 |

---

### POST /api/v1/attendances/break-end

**説明:** 休憩終了する

**前提条件:**
- CLOCKED_IN であること
- 休憩中であること

**リクエスト:**

```json
{
  "employeeId": "EMP-001",
  "clockTime": "2024-04-01T13:00:00+09:00",
  "source": "WEB"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| employeeId | string (EmployeeId) | ✅ | 存在する従業員 | 従業員ID |
| clockTime | string (ISO 8601) | ✅ | 休憩開始時刻より後 | 打刻時刻 |
| source | string (enum) | ✅ | `WEB` / `MOBILE` | 打刻元 |

**レスポンス: 200 OK**

```json
{
  "attendanceId": "ATT-20240401-EMP001",
  "employeeId": "EMP-001",
  "workDate": "2024-04-01",
  "status": "CLOCKED_IN",
  "onBreak": false,
  "breakMinutes": 60,
  "updatedAt": "2024-04-01T13:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー |
| 404 | `/errors/not-found` | 従業員が存在しない |
| 409 | `/errors/conflict` | CLOCKED_IN でない、または休憩中でない |

---

## クエリエンドポイント詳細

---

### GET /api/v1/attendances/today

**説明:** 当日の勤怠ステータス・サマリーを取得する

**認可:** 従業員本人

**用途:** 勤怠打刻画面の初期ロード時に呼び出す

**クエリパラメータ:** なし
（ログインユーザーの当日分を自動取得）

**レスポンス: 200 OK**

当日の打刻が存在する場合:

```json
{
  "attendanceId": "ATT-20240401-EMP001",
  "employeeId": "EMP-001",
  "workDate": "2024-04-01",
  "status": "CLOCKED_IN",
  "clockIn": "2024-04-01T09:00:00+09:00",
  "clockOut": null,
  "breakMinutes": 0,
  "netWorkMinutes": null,
  "overtimeMinutes": null,
  "source": "WEB"
}
```

当日の打刻が存在しない場合（status が null）:

```json
{}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| attendanceId | string (AttendanceId) | 勤怠記録ID |
| employeeId | string (EmployeeId) | 従業員ID |
| workDate | string (date) | 勤務日 |
| status | string (enum) / null | 勤怠ステータス |
| clockIn | string (ISO 8601) / null | 出勤時刻 |
| clockOut | string (ISO 8601) / null | 退勤時刻 |
| breakMinutes | number | 休憩時間（分） |
| netWorkMinutes | number / null | 実労働時間（分） |
| overtimeMinutes | number / null | 残業時間（分） |
| source | string (enum) / null | 打刻元（`WEB` / `MOBILE`） |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 401 | `/errors/unauthorized` | 認証エラー |

---

### GET /api/v1/attendances/daily

**説明:** 日次勤怠一覧を取得する

**認可:** 本人 + 上長 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| employeeId | string | - | ログインユーザー | 従業員ID |
| dateFrom | string (date) | - | 当月1日 | 期間開始日 |
| dateTo | string (date) | - | 当月末日 | 期間終了日 |
| status | string (enum) | - | 全て | 勤怠ステータスで絞り込み |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数 |
| sort | string | - | `workDate,desc` | ソート（`workDate`, `overtimeMinutes`, `status`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "workDate": "2024-04-01",
      "clockIn": "2024-04-01T09:00:00+09:00",
      "clockOut": "2024-04-01T18:00:00+09:00",
      "breakMinutes": 60,
      "netWorkMinutes": 480,
      "overtimeMinutes": 0,
      "status": "CLOCKED_OUT"
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 22,
    "totalPages": 2
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 他人のデータへのアクセス権なし |

---

### GET /api/v1/attendances/monthly-summary

**説明:** 月次勤怠サマリーを取得する

**認可:** 上長 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| departmentId | string | - | 上長の部署 | 部署ID |
| month | string (YYYY-MM) | - | 当月 | 対象年月 |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数 |
| sort | string | - | `employeeName,asc` | ソート（`employeeName`, `totalWorkHours`, `totalOvertimeHours`） |

**レスポンス: 200 OK**

```json
{
  "kpi": {
    "totalWorkDays": 320,
    "avgWorkDays": 20.0,
    "totalWorkHours": 2560.0,
    "avgWorkHours": 160.0,
    "totalOvertimeHours": 168.0,
    "avgOvertimeHours": 10.5,
    "totalPaidLeaveUsed": 8.0
  },
  "content": [
    {
      "employeeId": "EMP-001",
      "employeeName": "山田太郎",
      "workDays": 20,
      "totalWorkHours": 160.0,
      "totalOvertimeHours": 10.5,
      "lateNightHours": 2.0,
      "paidLeaveUsed": 1.0
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 15,
    "totalPages": 1
  }
}
```

| フィールド (kpi) | 型 | 説明 |
|-----------------|-----|------|
| totalWorkDays | number | 総出勤日数 |
| avgWorkDays | number | 平均出勤日数 |
| totalWorkHours | number | 総労働時間 |
| avgWorkHours | number | 平均労働時間 |
| totalOvertimeHours | number | 総残業時間 |
| avgOvertimeHours | number | 平均残業時間 |
| totalPaidLeaveUsed | number | 有給消化合計 |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 部署へのアクセス権なし |

---

### GET /api/v1/attendances/department-dashboard

**説明:** 部門別勤怠ダッシュボードを取得する

**認可:** 管理職 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| departmentId | string | - | 管理職は自部門、人事は全部門 | 部署ID |
| month | string (YYYY-MM) | - | 当月 | 対象年月 |
| sort | string | - | `departmentName,asc` | ソート（`departmentName`, `avgOvertimeHours`, `maxOvertimeHours`, `overtimeAlertCount`, `missingClockCount`, `attendanceRate`） |

**レスポンス: 200 OK**

```json
{
  "kpi": {
    "avgOvertimeHours": 15.2,
    "totalOvertimeAlertCount": 8,
    "totalMissingClockCount": 3,
    "avgAttendanceRate": 96.5
  },
  "previousMonth": {
    "avgOvertimeHours": 14.8,
    "totalOvertimeAlertCount": 6,
    "totalMissingClockCount": 5,
    "avgAttendanceRate": 97.1
  },
  "content": [
    {
      "departmentId": "DEP-001",
      "departmentName": "開発部",
      "headCount": 25,
      "avgOvertimeHours": 15.2,
      "maxOvertimeHours": 42.0,
      "overtimeAlertCount": 3,
      "missingClockCount": 1,
      "attendanceRate": 96.5
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 5,
    "totalPages": 1
  }
}
```

| フィールド (kpi) | 型 | 説明 |
|-----------------|-----|------|
| avgOvertimeHours | number | 全部門平均残業時間 |
| totalOvertimeAlertCount | number | 残業アラート合計件数 |
| totalMissingClockCount | number | 打刻漏れ合計件数 |
| avgAttendanceRate | number | 全部門平均出勤率 |

| フィールド (previousMonth) | 型 | 説明 |
|---------------------------|-----|------|
| avgOvertimeHours | number | 前月の全部門平均残業時間 |
| totalOvertimeAlertCount | number | 前月の残業アラート合計件数 |
| totalMissingClockCount | number | 前月の打刻漏れ合計件数 |
| avgAttendanceRate | number | 前月の全部門平均出勤率 |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | ダッシュボードへのアクセス権なし |

---

### GET /api/v1/attendances/monthly-summary/export

**説明:** 月次勤怠サマリーをCSV出力する

**認可:** 上長 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| departmentId | string | - | 上長の部署 | 部署ID |
| month | string (YYYY-MM) | - | 当月 | 対象年月 |

**レスポンス: 200 OK**

```
Content-Type: text/csv; charset=UTF-8
Content-Disposition: attachment; filename="monthly-summary_2024-04.csv"
```

```csv
従業員ID,従業員名,出勤日数,総労働時間,総残業時間,深夜時間,有給消化
EMP-001,山田太郎,20,160.0,10.5,2.0,1.0
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 部署へのアクセス権なし |

---

### GET /api/v1/attendances/department-dashboard/export

**説明:** 部門別勤怠ダッシュボードをCSV出力する

**認可:** 管理職 + 人事

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| departmentId | string | - | 管理職は自部門、人事は全部門 | 部署ID |
| month | string (YYYY-MM) | - | 当月 | 対象年月 |

**レスポンス: 200 OK**

```
Content-Type: text/csv; charset=UTF-8
Content-Disposition: attachment; filename="department-dashboard_2024-04.csv"
```

```csv
部署ID,部署名,人数,平均残業時間,最大残業時間,残業アラート件数,打刻漏れ件数,出勤率
DEP-001,開発部,25,15.2,42.0,3,1,96.5
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | ダッシュボードへのアクセス権なし |

---

## 内部エンドポイント詳細

> ⚠️ 以下のエンドポイントは
> サービス間通信専用。
> 外部には公開しない。

---

### POST /api/v1/internal/attendances/correct

**説明:** 承認済みの打刻修正申請に基づき打刻を修正する

**呼び出し元:** 打刻修正申請集約（承認完了時）

**前提条件:**
- 打刻修正申請が承認済みであること
- 勤怠記録が FINALIZED でないこと

**リクエスト:**

```json
{
  "correction": {
    "attendanceId": "ATT-20240401-EMP001",
    "correctionRequestId": "COR-001",
    "correctedClockIn": "2024-04-01T08:50:00+09:00",
    "correctedClockOut": "2024-04-01T18:10:00+09:00",
    "reason": "打刻漏れ修正",
    "approvedBy": "MGR-001",
    "approvedAt": "2024-04-02T10:00:00+09:00"
  }
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| correction | object (ClockCorrection) | ✅ | 承認済みの修正申請 | 修正内容 |

**レスポンス: 200 OK**

```json
{
  "attendanceId": "ATT-20240401-EMP001",
  "status": "CLOCKED_OUT",
  "clockIn": "2024-04-01T08:50:00+09:00",
  "clockOut": "2024-04-01T18:10:00+09:00",
  "netWorkMinutes": 500,
  "overtimeMinutes": 20,
  "correctedAt": "2024-04-02T10:05:00+09:00"
}
```

**後処理:** 勤務時間を再計算する

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | 修正内容が不正 |
| 404 | `/errors/not-found` | 勤怠記録が存在しない |
| 409 | `/errors/conflict` | FINALIZED 状態で修正不可 |
| 422 | `/errors/precondition` | 修正申請が承認済みでない |

---

### POST /api/v1/internal/attendances/register

**説明:** 承認済みの手動登録申請に基づき勤務実績を登録する

**呼び出し元:** 手動登録申請集約（上長承認完了時）

**前提条件:**
- 手動登録申請が上長承認済みであること
- 当日の勤怠記録が NOT_CLOCKED であること

**リクエスト:**

```json
{
  "manualAttendance": {
    "employeeId": "EMP-001",
    "registrationRequestId": "REG-001",
    "workDate": "2024-04-01",
    "clockIn": "2024-04-01T09:00:00+09:00",
    "clockOut": "2024-04-01T18:00:00+09:00",
    "breakMinutes": 60,
    "reason": "在宅勤務（打刻不可）",
    "approvedBy": "MGR-001",
    "approvedAt": "2024-04-02T10:00:00+09:00"
  }
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| manualAttendance | object (ManualAttendance) | ✅ | 承認済みの登録申請 | 登録内容 |

**レスポンス: 200 OK**

```json
{
  "attendanceId": "ATT-20240401-EMP001",
  "employeeId": "EMP-001",
  "workDate": "2024-04-01",
  "status": "CLOCKED_OUT",
  "clockIn": "2024-04-01T09:00:00+09:00",
  "clockOut": "2024-04-01T18:00:00+09:00",
  "breakMinutes": 60,
  "netWorkMinutes": 480,
  "overtimeMinutes": 0,
  "registeredAt": "2024-04-02T10:05:00+09:00"
}
```

**後処理:** 勤務時間を自動計算する

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | 登録内容が不正 |
| 409 | `/errors/conflict` | 当日に既に勤怠記録が存在する |
| 422 | `/errors/precondition` | 登録申請が承認済みでない |

---

### POST /api/v1/internal/attendances/finalize

**説明:** 月次締めSagaに基づき勤怠記録を本締め確定する

**呼び出し元:** 月次締めSaga

**前提条件:**
- 勤怠記録が CLOCKED_OUT であること
- 月次締めが FINALIZED であること

**リクエスト:**

```json
{
  "monthlyClosingId": "MC-202404",
  "targetEmployeeIds": ["EMP-001", "EMP-002"],
  "targetMonth": "2024-04"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| monthlyClosingId | string (MonthlyClosingId) | ✅ | FINALIZED状態の月次締め | 月次締めID |
| targetEmployeeIds | array of string | ✅ | - | 対象従業員ID一覧 |
| targetMonth | string (YYYY-MM) | ✅ | - | 対象年月 |

**レスポンス: 200 OK**

```json
{
  "monthlyClosingId": "MC-202404",
  "finalizedCount": 2,
  "results": [
    {
      "attendanceId": "ATT-20240401-EMP001",
      "status": "FINALIZED"
    },
    {
      "attendanceId": "ATT-20240401-EMP002",
      "status": "FINALIZED"
    }
  ],
  "finalizedAt": "2024-05-01T00:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 409 | `/errors/conflict` | CLOCKED_OUT でない記録が含まれる |
| 422 | `/errors/precondition` | 月次締めが FINALIZED でない |

---

## 状態遷移図

```
NOT_CLOCKED ──[出勤打刻]──→ CLOCKED_IN
                                │
                    [休憩開始/終了]──→ CLOCKED_IN（自己遷移）
                                │
                          [退勤打刻]
                                │
                                ↓
NOT_CLOCKED ──[勤務実績登録]──→ CLOCKED_OUT
                                │
                    [打刻修正]──→ CLOCKED_OUT（自己遷移）
                                │
                          [本締め確定]
                                │
                                ↓
                            FINALIZED（変更不可）
```

---

## 不変条件

| ID | ルール |
|----|--------|
| INV-ATT-001 | 出勤時刻 < 退勤時刻 |
| INV-ATT-002 | 休憩は出勤-退勤の間 |
| INV-ATT-003 | FINALIZED 後は変更不可 |
| INV-ATT-004 | 1勤務日1レコード |
| INV-ATT-005 | 休憩は開始→終了の対 |

---

## 計算ロジック詳細

退勤打刻・打刻修正・勤務実績登録の後処理で
実行される勤務時間計算の具体式を定義する。

ドメインモデルの `WorkDuration` / `OvertimeDuration`
に対応する値の算出ロジック。

> **参照:** `docs/20_ドメイン/勤怠管理/勤怠記録集約.md`
> ビジネスルール > 勤務時間計算

---

### 基本勤務時間（日次）

```
totalBreakMinutes = Σ(breakEnd - breakStart)
                    for all break entries

netWorkMinutes = (clockOutTime - clockInTime)
                 - totalBreakMinutes
```

- clockOutTime, clockInTime は**分精度**
  （秒以下切り捨て）
- 複数回の休憩がある場合は
  全休憩区間の合計を差し引く

---

### 残業時間（固定時間制・シフト制）

```
scheduledMinutes = シフトパターンの所定勤務時間（分）
totalOvertimeMinutes = max(0,
    netWorkMinutes - scheduledMinutes)
```

- 固定時間制:
  scheduledMinutes = 480（8時間）
- シフト制:
  scheduledMinutes = シフトパターン定義値
- 所定時間以下の場合、残業は 0

---

### 残業時間（フレックスタイム制）

```
monthlyScheduledMinutes = floor(
    暦日数 × 8 × 60 / 7)  // 分単位切り捨て

monthlyActualMinutes = Σ netWorkMinutes
                       (当月全営業日)

monthlyOvertimeMinutes = max(0,
    monthlyActualMinutes
    - monthlyScheduledMinutes)
```

- フレックスでは**日次の残業判定は行わない**
- 月次締め時に月単位で清算する
- 月の所定労働時間は暦日数から算出
  （例: 30日の月 → floor(30 × 480 / 7) = 2057分）

---

### 深夜勤務時間

```
lateNightMinutes = 勤務時間のうち
    22:00〜翌05:00 に該当する分数
```

- **日跨ぎの場合:**
  22:00〜24:00 と 00:00〜05:00 の
  2区間に分割して計算
- **深夜かつ残業の場合:**
  lateNightMinutes と totalOvertimeMinutes の
  両方にカウント（重複可）
- 割増率は `×1.50`（時間外 1.25 + 深夜 0.25）

**計算例:**

| ケース | 深夜該当区間 | lateNightMinutes |
|--------|------------|-----------------|
| 9:00-18:00 | 該当なし | 0 |
| 9:00-23:00 | 22:00-23:00 | 60 |
| 22:00-翌07:00 | 22:00-05:00 | 420 |
| 20:00-翌02:00 | 22:00-02:00 | 240 |

---

### 端数処理ルール

| 処理段階 | ルール |
|---------|--------|
| 日次計算 | **1分単位**（端数処理なし） |
| 月次集計 | 残業合計の30分未満切り捨て、30分以上切り上げ（**1時間単位に丸め**） |

- 日次の端数処理を行わないのは
  労基法24条（全額払いの原則）に準拠するため
- 月次での丸めは行政通達
  （昭63.3.14基発150号）に基づく

---

### 36協定閾値

| 定数名 | 値 | 説明 |
|--------|-----|------|
| MONTHLY_STANDARD_LIMIT | 2700分 | 月45時間 |
| YEARLY_STANDARD_LIMIT | 21600分 | 年360時間 |
| MONTHLY_SPECIAL_LIMIT | 6000分 | 月100時間（特別条項） |
| YEARLY_SPECIAL_LIMIT | 43200分 | 年720時間（特別条項） |
| SPECIAL_CLAUSE_MAX_MONTHS | 6 | 特別条項適用は年6回まで |
| AVG_80H_LIMIT | 4800分 | 複数月平均80時間 |

**運用方針:**

- 閾値は `application.yml` で管理し、
  **ハードコードしない**
- 月次サマリー算出時に閾値超過を判定し、
  `overtimeAlertCount` に反映する
- 複数月平均80時間の判定は
  直近2〜6ヶ月の移動平均で算出

```yaml
# application.yml（設定例）
attendance:
  overtime-limits:
    monthly-standard: 2700
    yearly-standard: 21600
    monthly-special: 6000
    yearly-special: 43200
    special-clause-max-months: 6
    avg-80h-limit: 4800
```

---

## エラーレスポンス形式

RFC 7807 準拠:

```json
{
  "type": "https://api.example.com/errors/validation",
  "title": "Validation Error",
  "status": 400,
  "detail": "clockTime は現在時刻±5分以内である必要があります",
  "instance": "/api/v1/attendances/clock-in",
  "errors": [
    {
      "field": "clockTime",
      "message": "現在時刻±5分以内である必要があります",
      "rejectedValue": "2024-04-01T06:00:00+09:00"
    }
  ]
}
```

---

## 認証・認可

### 認証

`Authorization: Bearer {token}` ヘッダー必須。
内部エンドポイントはサービス間認証（mTLS 等）。

### 認可マトリクス

| エンドポイント | 従業員本人 | 上長 | 人事 | 管理職 | システム |
|--------------|:---------:|:----:|:----:|:-----:|:-------:|
| POST /clock-in | ✅ | - | - | - | - |
| POST /clock-out | ✅ | - | - | - | - |
| POST /break-start | ✅ | - | - | - | - |
| POST /break-end | ✅ | - | - | - | - |
| GET /today | ✅ | - | - | - | - |
| GET /daily | ✅ | ✅ | ✅ | - | - |
| GET /monthly-summary | - | ✅ | ✅ | - | - |
| GET /monthly-summary/export | - | ✅ | ✅ | - | - |
| GET /department-dashboard | - | - | ✅ | ✅ | - |
| GET /department-dashboard/export | - | - | ✅ | ✅ | - |
| POST /internal/correct | - | - | - | - | ✅ |
| POST /internal/register | - | - | - | - | ✅ |
| POST /internal/finalize | - | - | - | - | ✅ |

### アクセス制御の補足

- 出勤/退勤/休憩打刻は**従業員本人のみ**
  - 現在時刻±5分以内の制約あり
- 打刻修正は**承認済み打刻修正申請経由のみ**
  - 公開APIとしては打刻修正申請側で提供
- 勤務実績登録は**承認済み手動登録申請経由のみ**
- 本締め確定は**月次締めSaga経由のみ**
- **FINALIZED 後の変更は一切不可**

---

## ページネーション

offset 方式を採用:

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| page | number | 0 | ページ番号（0始まり） |
| size | number | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `{field},{direction}` 形式 |

**レスポンスメタデータ:**

```json
{
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
}
```
