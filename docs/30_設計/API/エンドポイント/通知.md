# 通知 API

## 概要

システムからの通知の送信・外部配信・既読管理、
および通知一覧・履歴の照会を提供する。

**ベースパス:** `/api/v1/notifications`
**認証:** `Authorization: Bearer {token}`
**エラー形式:** RFC 7807

---

## エンドポイント一覧

### コマンドエンドポイント

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | `/notifications` | 通知を送信する | 必須（システム） |
| POST | `/notifications/{id}/actions/deliver-external` | 外部通知を送信する | 必須（システム） |
| POST | `/notifications/{id}/actions/read` | 通知を既読にする | 必須 |

### クエリエンドポイント

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| GET | `/notifications/unread` | 未読通知一覧（ユーザー別） | 必須 |
| GET | `/notifications` | 通知履歴 | 必須 |
| GET | `/notifications/{id}` | 通知詳細 | 必須 |

---

## コマンドエンドポイント詳細

---

### POST /api/v1/notifications

**説明:** 通知を送信する

**認可:** システム呼び出しのみ（各コンテキストのSaga/ポリシーから発行）

**前提条件:**
- 宛先ユーザーが存在すること

**リクエスト:**

```json
{
  "recipientId": "EMP-001",
  "type": "ARTICLE36_ALERT",
  "importance": "HIGH",
  "title": "36協定超過アラート",
  "body": "今月の時間外労働が36協定の上限に近づいています。現在の累計: 42時間（上限: 45時間）",
  "sourceContext": "ATTENDANCE",
  "sourceEventId": "EVT-ATT-20240401-001"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| recipientId | string (UserId) | ✅ | 存在するユーザー | 宛先ユーザーID |
| type | string (NotificationType) | ✅ | Enum値 | 通知種別 |
| importance | string (Importance) | ✅ | `HIGH` / `MEDIUM` / `LOW` | 重要度 |
| title | string (NotificationTitle) | ✅ | 1-100文字 | 通知タイトル |
| body | string (NotificationBody) | ✅ | 1-1000文字 | 通知本文 |
| sourceContext | string (SourceContext) | ✅ | `ATTENDANCE` / `APPROVAL` / `LEAVE` / `MONTHLY` | 発行元コンテキスト |
| sourceEventId | string | - | - | 発行元イベントID |

**レスポンス: 201 Created**

```json
{
  "notificationId": "NTF-20240401-001",
  "recipientId": "EMP-001",
  "type": "ARTICLE36_ALERT",
  "importance": "HIGH",
  "title": "36協定超過アラート",
  "body": "今月の時間外労働が36協定の上限に近づいています。現在の累計: 42時間（上限: 45時間）",
  "sourceContext": "ATTENDANCE",
  "sourceEventId": "EVT-ATT-20240401-001",
  "readStatus": "UNREAD",
  "externalChannel": null,
  "externalDelivered": false,
  "sentAt": "2024-04-01T09:00:00+09:00"
}
```

**後処理:** 重要度HIGHの場合、外部配信ポリシーが発動
- ユーザー個人設定のチャンネルで外部配信
- 個人設定がなければシステムデフォルト（SLACK）
- チャンネルが未設定（NONE）の場合はアプリ内通知のみ

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（title文字数不正、body文字数不正等） |
| 403 | `/errors/forbidden` | システム呼び出しでない |
| 422 | `/errors/precondition` | 宛先ユーザーが存在しない |

---

### POST /api/v1/notifications/{id}/actions/deliver-external

**説明:** 外部通知を送信する

**認可:** システム呼び出しのみ（外部配信ポリシーから発行）

**前提条件:**
- 対象通知が存在すること
- まだ外部配信されていないこと

**リクエスト:**

```json
{
  "channel": "SLACK"
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| channel | string (DeliveryChannel) | ✅ | `SLACK` / `EMAIL` / `TEAMS`（NONE以外） | 配信チャンネル |

**レスポンス: 200 OK**

```json
{
  "notificationId": "NTF-20240401-001",
  "channel": "SLACK",
  "externalDelivered": true,
  "deliveredAt": "2024-04-01T09:00:05+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（channelがNONE等） |
| 403 | `/errors/forbidden` | システム呼び出しでない |
| 404 | `/errors/not-found` | 通知が存在しない |
| 409 | `/errors/conflict` | 既に外部配信済み（INV-NTF-003違反） |

---

### POST /api/v1/notifications/{id}/actions/read

**説明:** 通知を既読にする

**認可:** 宛先ユーザー本人

**前提条件:**
- 通知がUNREADであること
- 宛先ユーザー本人であること

**リクエスト:**

```json
{}
```

> リクエストボディは空。
> 宛先ユーザー本人であることは認証トークンから判定する。

**レスポンス: 200 OK**

```json
{
  "notificationId": "NTF-20240401-001",
  "readStatus": "READ",
  "readAt": "2024-04-01T12:30:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 403 | `/errors/forbidden` | 宛先ユーザー本人でない（INV-NTF-001違反） |
| 404 | `/errors/not-found` | 通知が存在しない |
| 409 | `/errors/conflict` | 通知がUNREADでない（INV-NTF-002: 既読は不可逆） |

---

## クエリエンドポイント詳細

---

### GET /api/v1/notifications/unread

**説明:** 未読通知一覧を取得する（ユーザー別）

**認可:** 本人

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| importance | string (Importance) | - | 全件 | 重要度で絞り込み（`HIGH` / `MEDIUM` / `LOW`） |
| sourceContext | string (SourceContext) | - | 全件 | 発行元コンテキストで絞り込み（`ATTENDANCE` / `APPROVAL` / `LEAVE` / `MONTHLY`） |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `sentAt,desc` | ソート（`importance`, `sentAt`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "notificationId": "NTF-20240401-001",
      "importance": "HIGH",
      "title": "36協定超過アラート",
      "sourceContext": "ATTENDANCE",
      "sentAt": "2024-04-01T09:00:00+09:00"
    },
    {
      "notificationId": "NTF-20240401-002",
      "importance": "MEDIUM",
      "title": "承認リマインダー",
      "sourceContext": "APPROVAL",
      "sentAt": "2024-04-01T08:00:00+09:00"
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 2,
    "totalPages": 1
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 401 | `/errors/unauthorized` | 認証エラー |

---

### GET /api/v1/notifications

**説明:** 通知履歴を取得する

**認可:** 本人

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| importance | string (Importance) | - | 全件 | 重要度で絞り込み（`HIGH` / `MEDIUM` / `LOW`） |
| type | string (NotificationType) | - | 全件 | 通知種別で絞り込み |
| readStatus | string (ReadStatus) | - | 全件 | 既読状態で絞り込み（`UNREAD` / `READ`） |
| dateFrom | string (date-time) | - | 30日前 | 期間の開始日時 |
| dateTo | string (date-time) | - | 現在 | 期間の終了日時 |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `sentAt,desc` | ソート（`importance`, `sentAt`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "notificationId": "NTF-20240401-001",
      "importance": "HIGH",
      "title": "36協定超過アラート",
      "type": "ARTICLE36_ALERT",
      "sourceContext": "ATTENDANCE",
      "sentAt": "2024-04-01T09:00:00+09:00",
      "readStatus": "READ",
      "externalChannel": "SLACK"
    },
    {
      "notificationId": "NTF-20240401-002",
      "importance": "MEDIUM",
      "title": "承認リマインダー",
      "type": "APPROVAL_REMINDER",
      "sourceContext": "APPROVAL",
      "sentAt": "2024-04-01T08:00:00+09:00",
      "readStatus": "UNREAD",
      "externalChannel": null
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 15,
    "totalPages": 1
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 401 | `/errors/unauthorized` | 認証エラー |

---

### GET /api/v1/notifications/{id}

**説明:** 通知の詳細を取得する

**認可:** 宛先ユーザー本人

**レスポンス: 200 OK**

```json
{
  "notificationId": "NTF-20240401-001",
  "recipientId": "EMP-001",
  "type": "ARTICLE36_ALERT",
  "importance": "HIGH",
  "title": "36協定超過アラート",
  "body": "今月の時間外労働が36協定の上限に近づいています。現在の累計: 42時間（上限: 45時間）",
  "sourceContext": "ATTENDANCE",
  "sourceEventId": "EVT-ATT-20240401-001",
  "readStatus": "READ",
  "externalChannel": "SLACK",
  "externalDelivered": true,
  "sentAt": "2024-04-01T09:00:00+09:00",
  "readAt": "2024-04-01T12:30:00+09:00",
  "deliveredAt": "2024-04-01T09:00:05+09:00"
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| notificationId | string (NotificationId) | 通知ID |
| recipientId | string (UserId) | 宛先ユーザーID |
| type | string (NotificationType) | 通知種別 |
| importance | string (Importance) | 重要度 |
| title | string (NotificationTitle) | 通知タイトル |
| body | string (NotificationBody) | 通知本文 |
| sourceContext | string (SourceContext) | 発行元コンテキスト |
| sourceEventId | string / null | 発行元イベントID |
| readStatus | string (ReadStatus) | 既読状態 |
| externalChannel | string (DeliveryChannel) / null | 外部配信チャンネル |
| externalDelivered | boolean | 外部配信済みフラグ |
| sentAt | string (ISO 8601) | 送信日時 |
| readAt | string (ISO 8601) / null | 既読日時 |
| deliveredAt | string (ISO 8601) / null | 外部配信日時 |

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 403 | `/errors/forbidden` | 宛先ユーザー本人でない |
| 404 | `/errors/not-found` | 通知が存在しない |

---

## 状態遷移図

```
        [通知を送信する]
              │
              ↓
(初期状態) ──→ UNREAD
              │
    [通知を既読にする]
              │
              ↓
            READ
```

| 遷移元 | 遷移先 | トリガー | ガード条件 |
|--------|--------|---------|-----------|
| (初期) | UNREAD | 通知を送信する | 宛先ユーザーが存在すること |
| UNREAD | READ | 通知を既読にする | 宛先ユーザー本人であること |

> **注記:** READ は終端状態であり、
> UNREADに戻すことはできない（INV-NTF-002）。

---

## 不変条件

| ID | ルール | 説明 |
|----|--------|------|
| INV-NTF-001 | 既読は本人のみ | 他者の通知を既読にできない |
| INV-NTF-002 | READ後はUNREADに戻せない | 既読は不可逆 |
| INV-NTF-003 | 外部配信は1回のみ | 同一通知への二重配信防止 |

---

## Enum定義

### NotificationType

| 値 | 説明 |
|----|------|
| `ARTICLE36_ALERT` | 36協定超過アラート |
| `UNAPPLIED_OVERTIME_ALERT` | 未申請残業アラート |
| `APPROVAL_REMINDER` | 承認リマインダー |
| `APPROVAL_URGENCY` | 承認緊急催促 |
| `CLOCK_FORGOT` | 打刻忘れ通知 |
| `SHIFT_CHANGE` | シフト変更通知 |
| `SPECIAL_LEAVE_GRANT` | 特別休暇付与通知 |
| `LEAVE_EXPIRY_WARNING` | 有給期限警告 |
| `LEAVE_OBLIGATION_ALERT` | 有給取得義務アラート |

### Importance

| 値 | 説明 | 外部配信 |
|----|------|---------|
| `HIGH` | 高 | 自動配信（ユーザー設定 or システムデフォルト） |
| `MEDIUM` | 中 | 配信しない |
| `LOW` | 低 | 配信しない |

### ReadStatus

| 値 | 説明 |
|----|------|
| `UNREAD` | 未読 |
| `READ` | 既読 |

### SourceContext

| 値 | 説明 |
|----|------|
| `ATTENDANCE` | 勤怠コンテキスト |
| `APPROVAL` | 承認コンテキスト |
| `LEAVE` | 休暇コンテキスト |
| `MONTHLY` | 月次コンテキスト |

### DeliveryChannel

| 値 | 説明 |
|----|------|
| `NONE` | 外部配信なし |
| `SLACK` | Slack通知 |
| `EMAIL` | メール通知 |
| `TEAMS` | Teams通知 |

---

## エラーレスポンス形式

RFC 7807 準拠:

```json
{
  "type": "https://api.example.com/errors/validation",
  "title": "Validation Error",
  "status": 400,
  "detail": "title は1-100文字で入力してください",
  "instance": "/api/v1/notifications",
  "errors": [
    {
      "field": "title",
      "message": "1-100文字で入力してください",
      "rejectedValue": ""
    }
  ]
}
```

---

## 認証・認可

### 認証

`Authorization: Bearer {token}` ヘッダー必須。

### 認可マトリクス

| エンドポイント | 宛先ユーザー本人 | システム（内部） |
|--------------|:--------------:|:--------------:|
| POST /notifications | - | ✅ |
| POST /notifications/{id}/actions/deliver-external | - | ✅ |
| POST /notifications/{id}/actions/read | ✅ | - |
| GET /notifications/unread | ✅ | - |
| GET /notifications | ✅ | - |
| GET /notifications/{id} | ✅ | - |

### アクセス制御の補足

- 通知の送信は**システム（Saga/ポリシー）のみ**が可能
  - サービス間認証トークンによる検証
- 外部通知の送信は**システム（外部配信ポリシー）のみ**が可能
  - サービス間認証トークンによる検証
- 既読は**宛先ユーザー本人のみ**が可能
  - 認証トークンのユーザーIDと通知のrecipientIdを照合
- 未読一覧・通知履歴・通知詳細は**宛先ユーザー本人のみ**
  - 認証トークンのユーザーIDで自動フィルタリング

---

## ページネーション

offset 方式を採用:

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| page | number | 0 | ページ番号（0始まり） |
| size | number | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `{field},{direction}` 形式 |

**レスポンスメタデータ:**

```json
{
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
}
```

---

## 外部配信ポリシー

### 配信ルール

通知送信時、重要度HIGHの通知に対して外部配信ポリシーが自動発動する:

| ステップ | 処理 | 説明 |
|---------|------|------|
| 1 | 重要度チェック | HIGHの場合のみ外部配信を実行 |
| 2 | チャンネル決定 | ユーザー個人設定 → システムデフォルト（SLACK）の優先順位 |
| 3 | 外部通知送信 | 決定されたチャンネルで `deliver-external` を呼び出し |

### チャンネル優先順位

1. ユーザー個人設定があればそれを使用
2. なければシステムデフォルト（初期: SLACK）
3. チャンネルが未設定（NONE）の場合はアプリ内通知のみ

<!-- 品質チェック結果
- [x] 全コマンド（3つ）にエンドポイントが対応している
- [x] 全クエリ（2つ）にGETエンドポイントが対応している
- [x] エラーレスポンスが定義されている（RFC 7807形式）
- [x] 認証/認可が明示されている（認可マトリクス + 補足説明）
- [x] リクエストボディがドメインモデルのコマンド定義と一致
-->
