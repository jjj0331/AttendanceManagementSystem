# シフト API

## 概要

シフトパターンの定義と従業員への
週単位のシフト割当を管理する。

**ベースパス:** `/api/v1/shifts`
**認証:** `Authorization: Bearer {token}`
**エラー形式:** RFC 7807

---

## エンドポイント一覧

### シフトパターン管理（人事担当者向け）

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | `/shifts/patterns` | シフトパターン定義 | 必須 |
| GET | `/shifts/patterns` | シフトパターン一覧 | 必須 |
| GET | `/shifts/patterns/{patternId}` | シフトパターン詳細 | 必須 |
| POST | `/shifts/patterns/{patternId}/actions/deactivate` | パターン無効化 | 必須 |
| POST | `/shifts/patterns/{patternId}/actions/reactivate` | パターン再有効化 | 必須 |

### 週次スケジュール管理（管理職向け）

| メソッド | パス | 説明 | 認証 |
|---------|------|------|------|
| POST | `/shifts/schedules` | シフト割当 | 必須 |
| PUT | `/shifts/schedules/{scheduleId}` | シフト変更 | 必須 |
| POST | `/shifts/schedules/{scheduleId}/actions/publish` | シフト公開 | 必須 |
| GET | `/shifts/schedules` | シフトカレンダー | 必須 |
| GET | `/shifts/schedules/{scheduleId}` | スケジュール詳細 | 必須 |

---

## シフトパターン エンドポイント詳細

---

### POST /api/v1/shifts/patterns

**説明:** シフトパターンを定義する

**実行者:** 人事担当者

**前提条件:**
- 同名のパターンが存在しないこと

**リクエスト:**

```json
{
  "name": "早番",
  "startTime": "06:00",
  "endTime": "15:00",
  "breakMinutes": 60,
  "isOvernight": false
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| name | string (PatternName) | ✅ | 一意、2-20文字 | パターン名（早番、遅番等） |
| startTime | string (HH:mm) | ✅ | - | 勤務開始時刻 |
| endTime | string (HH:mm) | ✅ | - | 勤務終了時刻 |
| breakMinutes | number | ✅ | 0-120 | 休憩時間（分） |
| isOvernight | boolean | ✅ | - | 日跨ぎフラグ（夜勤対応） |

**レスポンス: 201 Created**

```json
{
  "patternId": "PAT-001",
  "name": "早番",
  "startTime": "06:00",
  "endTime": "15:00",
  "breakMinutes": 60,
  "isOvernight": false,
  "isActive": true,
  "createdAt": "2024-04-01T10:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（文字数制約等） |
| 409 | `/errors/conflict` | 同名パターンが既に存在する |

---

### GET /api/v1/shifts/patterns

**説明:** シフトパターン一覧を取得する

**認可:** 人事担当者 + 管理職

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| isActive | boolean | - | 全て | 有効/無効で絞り込み |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数 |
| sort | string | - | `name,asc` | ソート（`name`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "patternId": "PAT-001",
      "name": "早番",
      "startTime": "06:00",
      "endTime": "15:00",
      "breakMinutes": 60,
      "isOvernight": false,
      "isActive": true
    },
    {
      "patternId": "PAT-002",
      "name": "遅番",
      "startTime": "14:00",
      "endTime": "23:00",
      "breakMinutes": 60,
      "isOvernight": false,
      "isActive": true
    },
    {
      "patternId": "PAT-003",
      "name": "夜勤",
      "startTime": "22:00",
      "endTime": "07:00",
      "breakMinutes": 60,
      "isOvernight": true,
      "isActive": true
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 3,
    "totalPages": 1
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |

---

### GET /api/v1/shifts/patterns/{patternId}

**説明:** シフトパターン詳細を取得する

**認可:** 人事担当者 + 管理職

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| patternId | string (ShiftPatternId) | パターンID |

**レスポンス: 200 OK**

```json
{
  "patternId": "PAT-001",
  "name": "早番",
  "startTime": "06:00",
  "endTime": "15:00",
  "breakMinutes": 60,
  "isOvernight": false,
  "isActive": true,
  "createdAt": "2024-04-01T10:00:00+09:00",
  "updatedAt": "2024-04-01T10:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 404 | `/errors/not-found` | パターンが存在しない |

---

### POST /api/v1/shifts/patterns/{patternId}/actions/deactivate

**説明:** シフトパターンを無効化する

**実行者:** 人事担当者

**前提条件:**
- パターンが ACTIVE であること
- 未来の割当で使用されていないこと

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| patternId | string (ShiftPatternId) | パターンID |

**リクエスト:** なし（ボディ不要）

**レスポンス: 200 OK**

```json
{
  "patternId": "PAT-001",
  "name": "早番",
  "isActive": false,
  "updatedAt": "2024-04-15T10:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 404 | `/errors/not-found` | パターンが存在しない |
| 409 | `/errors/conflict` | 既に INACTIVE |
| 422 | `/errors/precondition` | 未来の割当で使用中のため無効化不可 |

---

### POST /api/v1/shifts/patterns/{patternId}/actions/reactivate

**説明:** 無効化されたシフトパターンを再有効化する

**実行者:** 人事担当者

**前提条件:**
- パターンが INACTIVE であること

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| patternId | string (ShiftPatternId) | パターンID |

**リクエスト:** なし（ボディ不要）

**レスポンス: 200 OK**

```json
{
  "patternId": "PAT-001",
  "name": "早番",
  "isActive": true,
  "updatedAt": "2024-04-20T10:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 404 | `/errors/not-found` | パターンが存在しない |
| 409 | `/errors/conflict` | 既に ACTIVE |

---

## 週次スケジュール エンドポイント詳細

---

### POST /api/v1/shifts/schedules

**説明:** シフトを割り当てる

**実行者:** 管理職

**前提条件:**
- 対象週に既存スケジュールがないこと
- 指定パターンがすべて ACTIVE であること

**リクエスト:**

```json
{
  "employeeId": "EMP-001",
  "weekStartDate": "2024-04-01",
  "assignments": {
    "MONDAY": "PAT-001",
    "TUESDAY": "PAT-001",
    "WEDNESDAY": "PAT-001",
    "THURSDAY": "PAT-002",
    "FRIDAY": "PAT-002"
  }
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| employeeId | string (EmployeeId) | ✅ | 存在する従業員 | 対象従業員 |
| weekStartDate | string (date) | ✅ | 月曜日であること | 週の開始日 |
| assignments | object (Map\<DayOfWeek, ShiftPatternId\>) | ✅ | 1日以上、有効パターンのみ | 曜日→パターンID |

**レスポンス: 201 Created**

```json
{
  "scheduleId": "SCH-20240401-EMP001",
  "employeeId": "EMP-001",
  "weekStartDate": "2024-04-01",
  "status": "DRAFT",
  "assignments": {
    "MONDAY": { "patternId": "PAT-001", "patternName": "早番" },
    "TUESDAY": { "patternId": "PAT-001", "patternName": "早番" },
    "WEDNESDAY": { "patternId": "PAT-001", "patternName": "早番" },
    "THURSDAY": { "patternId": "PAT-002", "patternName": "遅番" },
    "FRIDAY": { "patternId": "PAT-002", "patternName": "遅番" }
  },
  "createdAt": "2024-03-25T10:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー（月曜日でない等） |
| 404 | `/errors/not-found` | 従業員またはパターンが存在しない |
| 409 | `/errors/conflict` | 対象週に既存スケジュールが存在する |
| 422 | `/errors/precondition` | INACTIVE パターンが指定されている |

---

### PUT /api/v1/shifts/schedules/{scheduleId}

**説明:** シフトを変更する

**実行者:** 管理職

**前提条件:**
- 指定パターンがすべて ACTIVE であること

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| scheduleId | string (ScheduleId) | スケジュールID |

**リクエスト:**

```json
{
  "assignments": {
    "MONDAY": "PAT-001",
    "TUESDAY": "PAT-003",
    "WEDNESDAY": "PAT-001",
    "THURSDAY": "PAT-002",
    "FRIDAY": "PAT-002"
  }
}
```

| フィールド | 型 | 必須 | 制約 | 説明 |
|-----------|-----|------|------|------|
| assignments | object (Map\<DayOfWeek, ShiftPatternId\>) | ✅ | 有効パターンのみ | 更新する曜日→パターンID |

**レスポンス: 200 OK**

```json
{
  "scheduleId": "SCH-20240401-EMP001",
  "employeeId": "EMP-001",
  "weekStartDate": "2024-04-01",
  "status": "DRAFT",
  "assignments": {
    "MONDAY": { "patternId": "PAT-001", "patternName": "早番" },
    "TUESDAY": { "patternId": "PAT-003", "patternName": "夜勤" },
    "WEDNESDAY": { "patternId": "PAT-001", "patternName": "早番" },
    "THURSDAY": { "patternId": "PAT-002", "patternName": "遅番" },
    "FRIDAY": { "patternId": "PAT-002", "patternName": "遅番" }
  },
  "updatedAt": "2024-03-26T14:00:00+09:00"
}
```

**後処理:** PUBLISHED だった場合は DRAFT に戻る

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | バリデーションエラー |
| 404 | `/errors/not-found` | スケジュールまたはパターンが存在しない |
| 422 | `/errors/precondition` | INACTIVE パターンが指定されている |

---

### POST /api/v1/shifts/schedules/{scheduleId}/actions/publish

**説明:** シフトを公開する

**実行者:** 管理職

**前提条件:**
- スケジュールが DRAFT であること
- 割当済みの日が1日以上あること

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| scheduleId | string (ScheduleId) | スケジュールID |

**リクエスト:** なし（ボディ不要）

**レスポンス: 200 OK**

```json
{
  "scheduleId": "SCH-20240401-EMP001",
  "employeeId": "EMP-001",
  "weekStartDate": "2024-04-01",
  "status": "PUBLISHED",
  "assignments": {
    "MONDAY": { "patternId": "PAT-001", "patternName": "早番" },
    "TUESDAY": { "patternId": "PAT-003", "patternName": "夜勤" },
    "WEDNESDAY": { "patternId": "PAT-001", "patternName": "早番" },
    "THURSDAY": { "patternId": "PAT-002", "patternName": "遅番" },
    "FRIDAY": { "patternId": "PAT-002", "patternName": "遅番" }
  },
  "publishedAt": "2024-03-27T09:00:00+09:00"
}
```

**後処理:** 対象従業員にシフト割当通知を送信

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 404 | `/errors/not-found` | スケジュールが存在しない |
| 409 | `/errors/conflict` | DRAFT でない（既に PUBLISHED） |
| 422 | `/errors/precondition` | 割当済みの日が0日（空スケジュール） |

---

## クエリエンドポイント詳細

---

### GET /api/v1/shifts/schedules

**説明:** シフトカレンダーを取得する

**認可:** 管理職（部下全員） + 従業員本人

**クエリパラメータ:**

| パラメータ | 型 | 必須 | デフォルト | 説明 |
|-----------|-----|------|-----------|------|
| employeeId | string | - | 全員（管理職）/ 本人 | 従業員ID |
| weekFrom | string (date) | - | 今週の月曜日 | 期間開始（月曜日） |
| weekTo | string (date) | - | 4週先の月曜日 | 期間終了（月曜日） |
| status | string (enum) | - | 全て | `DRAFT` / `PUBLISHED` |
| page | number | - | 0 | ページ番号（0始まり） |
| size | number | - | 20 | 1ページあたりの件数 |
| sort | string | - | `weekStartDate,asc` | ソート（`weekStartDate`, `employeeName`） |

**レスポンス: 200 OK**

```json
{
  "content": [
    {
      "scheduleId": "SCH-20240401-EMP001",
      "employeeId": "EMP-001",
      "employeeName": "山田太郎",
      "weekStartDate": "2024-04-01",
      "status": "PUBLISHED",
      "assignments": {
        "MONDAY": { "patternId": "PAT-001", "patternName": "早番", "startTime": "06:00", "endTime": "15:00" },
        "TUESDAY": { "patternId": "PAT-001", "patternName": "早番", "startTime": "06:00", "endTime": "15:00" },
        "WEDNESDAY": { "patternId": "PAT-001", "patternName": "早番", "startTime": "06:00", "endTime": "15:00" },
        "THURSDAY": { "patternId": "PAT-002", "patternName": "遅番", "startTime": "14:00", "endTime": "23:00" },
        "FRIDAY": { "patternId": "PAT-002", "patternName": "遅番", "startTime": "14:00", "endTime": "23:00" }
      }
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 16,
    "totalPages": 1
  }
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 400 | `/errors/validation` | パラメータ不正 |
| 403 | `/errors/forbidden` | 他人のデータへのアクセス権なし |

---

### GET /api/v1/shifts/schedules/{scheduleId}

**説明:** スケジュール詳細を取得する

**認可:** 管理職 + 従業員本人

**パスパラメータ:**

| パラメータ | 型 | 説明 |
|-----------|-----|------|
| scheduleId | string (ScheduleId) | スケジュールID |

**レスポンス: 200 OK**

```json
{
  "scheduleId": "SCH-20240401-EMP001",
  "employeeId": "EMP-001",
  "employeeName": "山田太郎",
  "weekStartDate": "2024-04-01",
  "status": "PUBLISHED",
  "assignments": {
    "MONDAY": { "patternId": "PAT-001", "patternName": "早番", "startTime": "06:00", "endTime": "15:00", "breakMinutes": 60 },
    "TUESDAY": { "patternId": "PAT-001", "patternName": "早番", "startTime": "06:00", "endTime": "15:00", "breakMinutes": 60 },
    "WEDNESDAY": { "patternId": "PAT-001", "patternName": "早番", "startTime": "06:00", "endTime": "15:00", "breakMinutes": 60 },
    "THURSDAY": { "patternId": "PAT-002", "patternName": "遅番", "startTime": "14:00", "endTime": "23:00", "breakMinutes": 60 },
    "FRIDAY": { "patternId": "PAT-002", "patternName": "遅番", "startTime": "14:00", "endTime": "23:00", "breakMinutes": 60 }
  },
  "createdAt": "2024-03-25T10:00:00+09:00",
  "updatedAt": "2024-03-27T09:00:00+09:00",
  "publishedAt": "2024-03-27T09:00:00+09:00"
}
```

**エラー:**

| コード | type | 説明 |
|--------|------|------|
| 404 | `/errors/not-found` | スケジュールが存在しない |
| 403 | `/errors/forbidden` | アクセス権なし |

---

## 状態遷移図

### シフトパターン

```
[新規] ──[パターン定義]──→ ACTIVE
                             │
                    [無効化]──→ INACTIVE
                             │
                    [再有効化]──→ ACTIVE
```

### 週次スケジュール

```
[新規] ──[シフト割当]──→ DRAFT
                          │
                  [シフト変更]──→ DRAFT（自己遷移）
                          │
                  [シフト公開]
                          │
                          ↓
                       PUBLISHED
                          │
                  [シフト変更]──→ DRAFT（再編集）
                          │
                  [シフト公開]──→ PUBLISHED（再公開・再通知）
```

---

## 不変条件

| ID | ルール |
|----|--------|
| INV-SH-001 | パターン名は一意 |
| INV-SH-002 | 割当は有効（ACTIVE）パターンのみ |
| INV-SH-003 | 同一従業員の同一日に複数パターン不可 |

---

## ビジネスルール

### 夜勤（日跨ぎ）パターン

- `isOvernight = true` の場合、`endTime < startTime` を許容
- 勤務時間計算: 24h - startTime + endTime - breakMinutes
- 例: 22:00〜翌7:00（休憩60分）= 8時間勤務

### 通知ポリシー

- スケジュールが PUBLISHED になった時点で対象従業員に通知
- 変更により PUBLISHED → DRAFT に戻った後、再 PUBLISHED で再通知

---

## エラーレスポンス形式

RFC 7807 準拠:

```json
{
  "type": "https://api.example.com/errors/validation",
  "title": "Validation Error",
  "status": 400,
  "detail": "name は2-20文字である必要があります",
  "instance": "/api/v1/shifts/patterns",
  "errors": [
    {
      "field": "name",
      "message": "2-20文字である必要があります",
      "rejectedValue": "A"
    }
  ]
}
```

---

## 認証・認可

### 認証

`Authorization: Bearer {token}` ヘッダー必須。

### 認可マトリクス

| エンドポイント | 従業員本人 | 管理職 | 人事担当者 |
|--------------|:---------:|:-----:|:---------:|
| POST /patterns | - | - | ✅ |
| GET /patterns | - | ✅ | ✅ |
| GET /patterns/{patternId} | - | ✅ | ✅ |
| POST /patterns/{patternId}/actions/deactivate | - | - | ✅ |
| POST /patterns/{patternId}/actions/reactivate | - | - | ✅ |
| POST /schedules | - | ✅ | - |
| PUT /schedules/{scheduleId} | - | ✅ | - |
| POST /schedules/{scheduleId}/actions/publish | - | ✅ | - |
| GET /schedules | ✅ | ✅ | - |
| GET /schedules/{scheduleId} | ✅ | ✅ | - |

### アクセス制御の補足

- シフトパターンの定義・無効化・再有効化は
  **人事担当者のみ**
- スケジュールの割当・変更・公開は
  **管理職のみ**
- シフトカレンダーの閲覧は
  **管理職（部下全員）+ 従業員本人**
- 従業員本人は自分のスケジュールのみ閲覧可能

---

## ページネーション

offset 方式を採用:

| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|-----------|------|
| page | number | 0 | ページ番号（0始まり） |
| size | number | 20 | 1ページあたりの件数（最大100） |
| sort | string | - | `{field},{direction}` 形式 |

**レスポンスメタデータ:**

```json
{
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 100,
    "totalPages": 5
  }
}
```
