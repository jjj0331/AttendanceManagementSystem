# 有給残日数照会

## 概要

| 項目 | 内容 |
|------|------|
| 画面ID | SCR-LB-001 |
| 画面種別 | 詳細（照会） |
| 関連集約 | 有給残高 |
| コンテキスト | 休暇管理 |
| URL | `/leave-balances/remaining` |

---

## ワイヤーフレーム

```
┌───────────────────────────────────────────────────────────┐
│ 勤怠管理システム                            [山田 太郎 ▼] │
├───────────────────────────────────────────────────────────┤
│ パンくず: ホーム > 休暇管理 > 有給残日数照会              │
├───────────────────────────────────────────────────────────┤
│                                                           │
│  有給残日数照会          [年度: 2024年度 ▼]               │
│                                                           │
│  ┌─────────────────────────────────────────────────────┐  │
│  │                                                     │  │
│  │  ┌──────────────────┐  ┌──────────────────┐         │  │
│  │  │ 残日数合計        │  │ 残時間（時間有給）│         │  │
│  │  │                  │  │                  │         │  │
│  │  │   12.5 日        │  │   16 時間        │         │  │
│  │  │                  │  │                  │         │  │
│  │  └──────────────────┘  └──────────────────┘         │  │
│  │                                                     │  │
│  │  ┌──────────────────┐  ┌──────────────────┐         │  │
│  │  │ 今年度の時間消化  │  │ 年5日義務の進捗  │         │  │
│  │  │                  │  │                  │         │  │
│  │  │   8 時間         │  │   3 / 5 日       │         │  │
│  │  │                  │  │  ████████░░ 60%  │         │  │
│  │  └──────────────────┘  └──────────────────┘         │  │
│  │                                                     │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                           │
│  ┌─────────────────────────────────────────────────────┐  │
│  │ ⚠ 時効通知                                         │  │
│  │                                                     │  │
│  │  次の時効日:  2025/03/31                             │  │
│  │  時効予定日数: 3.0 日                                │  │
│  │                                                     │  │
│  │  ※ 時効30日前になると通知が届きます                  │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

---

## コンポーネント構成

```
PaidLeaveRemainingPage
├── PageHeader
│   ├── Breadcrumb
│   ├── PageTitle ("有給残日数照会")
│   └── FiscalYearSelector
│       └── SelectBox (fiscalYear)
├── BalanceCardGrid
│   ├── BalanceCard (totalRemainingDays)
│   │   ├── CardLabel ("残日数合計")
│   │   └── MetricValue (数値 + "日")
│   ├── BalanceCard (totalRemainingHours)
│   │   ├── CardLabel ("残時間（時間単位有給）")
│   │   └── MetricValue (数値 + "時間")
│   ├── BalanceCard (hourlyUsedThisYear)
│   │   ├── CardLabel ("今年度の時間単位消化数")
│   │   └── MetricValue (数値 + "時間")
│   └── BalanceCard (annualConsumedDays)
│       ├── CardLabel ("年5日義務の進捗")
│       ├── MetricValue (数値 + "/ 5 日")
│       └── ProgressBar (消化率%)
├── ExpiryNoticeCard
│   ├── AlertIcon
│   ├── NoticeTitle ("時効通知")
│   ├── ExpiryDate (nextExpiryDate)
│   ├── ExpiryDays (nextExpiryDays)
│   └── NoticeCaption
├── LoadingState
│   └── SkeletonCard (×4 + ×1)
└── ErrorState
    ├── ErrorMessage
    └── RetryButton
```

---

## 表示項目

### 残高カード

| 項目 | 表示名 | 型 | 表示形式 | 備考 |
|------|--------|-----|---------|------|
| totalRemainingDays | 残日数合計 | number | `{n} 日` | メイン指標、大きめ表示 |
| totalRemainingHours | 残時間（時間単位有給） | number | `{n} 時間` | 時間単位有給の残 |
| hourlyUsedThisYear | 今年度の時間単位消化数 | number | `{n} 時間` | 当年度の消化実績 |
| annualConsumedDays | 年5日義務の進捗 | number | `{n} / 5 日` + プログレスバー | 取得義務の進捗率を視覚化 |

### 時効通知カード

| 項目 | 表示名 | 型 | 表示形式 | 備考 |
|------|--------|-----|---------|------|
| nextExpiryDate | 次の時効日 | date | `YYYY/MM/DD` | 30日以内で警告色 |
| nextExpiryDays | 時効予定日数 | number | `{n} 日` | 失効する日数 |

### 条件付き表示

| 条件 | 表示 |
|------|------|
| 時効30日以内 | 時効通知カードを警告色（amber）で強調 |
| 年5日未達（年度末3ヶ月以内） | 義務進捗カードを警告色で強調 |
| 残日数 0 | 残日数カードをグレーアウト |

---

## 検索条件

| 条件 | 入力形式 | 演算子 | デフォルト | 備考 |
|------|---------|--------|-----------|------|
| employeeId | 自動（非表示） | = | ログインユーザー | 上長・人事は従業員選択可 |
| fiscalYear | セレクトボックス | = | 当年度 | 過去年度も選択可 |

### 権限別 UI

| 権限 | employeeId の扱い |
|------|------------------|
| self（本人） | 自動設定、変更不可 |
| manager（上長） | 部下一覧からセレクト表示 |
| hr（人事） | 全従業員からセレクト表示 |

---

## アクション

### 画面アクション

| アクション | トリガー | 処理 | 権限 |
|-----------|---------|------|------|
| 年度切替 | FiscalYearSelector 変更 | 残日数データ再取得 | read |
| 従業員切替 | EmployeeSelector 変更（上長・人事のみ） | 残日数データ再取得 | read (manager, hr) |
| リトライ | RetryButton クリック | データ再取得 | read |

---

## 状態管理

```typescript
interface PaidLeaveRemainingPageState {
  // フィルター条件
  filters: {
    employeeId: string;       // ログインユーザーIDがデフォルト
    fiscalYear: string;       // 当年度がデフォルト（例: "2024"）
  };

  // 残高データ
  balance: {
    totalRemainingDays: number | null;
    totalRemainingHours: number | null;
    hourlyUsedThisYear: number | null;
    annualConsumedDays: number | null;
    nextExpiryDate: string | null;       // ISO 8601
    nextExpiryDays: number | null;
  };

  // UI状態
  ui: {
    isLoading: boolean;
    error: ApiError | null;
    isExpiryWarning: boolean;            // 時効30日以内
    isAnnualObligationWarning: boolean;  // 年5日未達 + 年度末3ヶ月以内
  };

  // 権限
  permissions: {
    canSelectEmployee: boolean;  // manager or hr
    role: 'self' | 'manager' | 'hr';
  };
}

interface ApiError {
  code: string;
  message: string;
  retryable: boolean;
}
```

---

## API連携

| 操作 | エンドポイント | メソッド | 備考 |
|------|--------------|---------|------|
| 残日数取得 | `/api/v1/paid-leave-balances/remaining` | GET | クエリパラメータで絞り込み |

### リクエストパラメータ

| パラメータ | 型 | 必須 | デフォルト |
|-----------|-----|------|-----------|
| employeeId | string | No | ログインユーザー |
| fiscalYear | string | No | 当年度 |

### レスポンス

```json
{
  "employeeId": "EMP001",
  "fiscalYear": "2024",
  "totalRemainingDays": 12.5,
  "totalRemainingHours": 16,
  "hourlyUsedThisYear": 8,
  "annualConsumedDays": 3,
  "nextExpiryDate": "2025-03-31",
  "nextExpiryDays": 3.0
}
```

### 認可

| ロール | アクセス範囲 |
|--------|------------|
| self | 自分のデータのみ |
| manager | 部下のデータ |
| hr | 全従業員のデータ |

### データソース

- `leave_balance_summaries` テーブル（Read Model）
- 残日数計算: `total_granted_days - total_consumed_days - total_expired_days + total_adjusted_days`

---

## エラー処理

| エラー | 表示方法 | アクション |
|--------|---------|----------|
| 通信エラー | ErrorState コンポーネント（カード内） | RetryButton で再取得 |
| 認証エラー（401） | リダイレクト | ログイン画面へ遷移 |
| 認可エラー（403） | ErrorState「閲覧権限がありません」 | ホームへ戻るリンク |
| データなし（404） | EmptyState「該当年度のデータがありません」 | 年度セレクタで切替を促す |
| サーバーエラー（500） | ErrorState + Toast | RetryButton で再取得 |

---

## レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| Desktop (>1024px) | カード2列×2行、時効通知カード横幅100% |
| Tablet (768-1024px) | カード2列×2行、余白縮小 |
| Mobile (<768px) | カード1列×4行、時効通知カード横幅100% |

---

## デザインガイドライン

### カラー＆テーマ（mono-accent）

| 項目 | 値 | 備考 |
|------|-----|------|
| ベースカラー | #FFFFFF | 背景 |
| サーフェス | #F9FAFB | カード背景 |
| ボーダー | #E5E7EB | カード・区切り線 |
| テキスト: Primary | #111827 | 見出し・数値 |
| テキスト: Secondary | #6B7280 | ラベル・補足 |
| アクセントカラー | #3B82F6 | 選択状態・リンク |
| セマンティック: Success | #10B981 | 義務達成 |
| セマンティック: Warning | #F59E0B | 時効30日以内・義務未達 |
| セマンティック: Error | #EF4444 | エラー |
| コントラスト比 | WCAG AA 準拠（4.5:1 以上） | テキスト/背景 |

### タイポグラフィ

| 要素 | フォント | サイズ | ウェイト |
|------|---------|--------|---------|
| ページタイトル（h1） | system-ui | 24px | 700 |
| カードラベル | system-ui | 12px | 500 |
| 数値（メトリクス） | "SF Mono", monospace | 32px | 700 |
| 数値単位 | system-ui | 14px | 400 |
| 補足テキスト | system-ui | 13px | 400 |
| 通知テキスト | system-ui | 14px | 500 |

### レイアウト原則（clean-minimal）

| 項目 | 値 | 備考 |
|------|-----|------|
| 基本余白 | 8px グリッド | 一貫した余白体系 |
| ページ左右パディング | 32px | デスクトップ |
| セクション間 | 24px | カードグリッドと時効通知の間 |
| カード内パディング | 24px | 余白を十分に確保 |
| カード間ギャップ | 16px | グリッドギャップ |
| カード角丸 | 8px | 控えめな角丸 |
| カード影 | 0 1px 3px rgba(0,0,0,0.08) | 最小限の影 |
| 区切り線 | 1px solid #E5E7EB | 必要最小限に使用 |
| ホワイトスペース | 十分に確保 | 要素を詰め込まない |

### インタラクション

| 状態 | スタイル |
|------|---------|
| ホバー（カード） | border-color: #D1D5DB, 背景色微変化 |
| フォーカス（セレクタ） | 2px outline #3B82F6 + 2px offset |
| ローディング | Skeleton UI（カード形状を維持） |
| 画面遷移 | 即時（アニメーションなし） |
| 年度切替 | セレクタ変更後即座にデータ再取得 |
| フィードバック | Toast 通知（右上、3秒自動消去） |
| 時効アラート | 30日以内でカード枠を amber に変化 |

### アンチパターン（避けるべき表現）

- グラデーション背景の多用
- 装飾的なドロップシャドウの重ね掛け
- 無意味なアニメーション・トランジション
- ジェネリックなAI生成風のイラスト
- 過度な角丸（pill 形状の乱用）
- カードへの過剰な装飾（アイコン羅列、色の多用）
- 数値の色分け過多（mono-accent に反する）

---

## 品質チェック結果

- [x] 全クエリカラムに対応する表示要素がある（6項目 → 4カード + 1通知カード）
- [x] コマンドなし（照会専用画面）のため操作UIは年度切替のみで適切
- [x] エラー状態の表示が定義されている（5パターン）
- [x] 状態遷移がUI上で表現されている（年度切替、時効アラート、義務進捗）

<!-- メトリクスサマリー（/estimate 自動集計用）
画面種別: 詳細
コンポーネント数: 16
DataTable: 0
SearchForm: 0
フォーム数: 0
チャート数: 0
カード数: 5
-->
