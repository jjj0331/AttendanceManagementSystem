# 休暇申請作成

## 概要

| 項目 | 内容 |
|------|------|
| 画面ID | SCR-LV-003 |
| 画面種別 | 登録 |
| 関連集約 | 休暇申請（申請承認コンテキスト） |
| URL | `/leave-requests/new` |

---

## ワイヤーフレーム

### 基本レイアウト（年次有給 選択時）

```
┌───────────────────────────────────────────────────────────────────────────┐
│ {システム名}                                                  [user ▼]   │
├───────────────────────────────────────────────────────────────────────────┤
│ パンくず: ホーム > 申請管理 > 休暇申請一覧 > 休暇申請作成               │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ 休暇申請作成                                                            │
│                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │                                                                   │ │
│ │ 休暇種別 *       [年次有給（1日単位）        ▼]                    │ │
│ │                                                                   │ │
│ │ ── 期間指定 ─────────────────────────────────────────────         │ │
│ │                                                                   │ │
│ │ 開始日 *         [2026/02/10      📅]                             │ │
│ │                                                                   │ │
│ │ 終了日 *         [2026/02/12      📅]                             │ │
│ │                  ※複数日指定可（開始日 ≦ 終了日）                  │ │
│ │                                                                   │ │
│ │                                                                   │ │
│ │                              [キャンセル]  [■ 申請する ■]         │ │
│ │                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└───────────────────────────────────────────────────────────────────────────┘
```

### 半休（午前/午後）選択時

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                   │
│ 休暇種別 *       [午前半休                     ▼]                  │
│                                                                   │
│ ── 期間指定 ─────────────────────────────────────────────         │
│                                                                   │
│ 対象日 *         [2026/02/10      📅]                             │
│                  ※半休は1日のみ指定（開始日＝終了日）               │
│                                                                   │
│                                                                   │
│                              [キャンセル]  [■ 申請する ■]         │
│                                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 時間休 選択時

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                   │
│ 休暇種別 *       [時間休（時間帯指定）         ▼]                  │
│                                                                   │
│ ── 期間指定 ─────────────────────────────────────────────         │
│                                                                   │
│ 対象日 *         [2026/02/10      📅]                             │
│                                                                   │
│ ── 時間帯指定 ───────────────────────────────────────────         │
│                                                                   │
│ 開始時刻 *       [09:00 ▼]                                       │
│                  ※1時間単位                                       │
│                                                                   │
│ 終了時刻 *       [12:00 ▼]                                       │
│                  ※最大5時間まで                                    │
│                                                                   │
│                                                                   │
│                              [キャンセル]  [■ 申請する ■]         │
│                                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 特別休暇（慶弔/リフレッシュ）選択時

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                   │
│ 休暇種別 *       [慶弔休暇（理由必須）         ▼]                  │
│                                                                   │
│ ── 期間指定 ─────────────────────────────────────────────         │
│                                                                   │
│ 開始日 *         [2026/02/10      📅]                             │
│                                                                   │
│ 終了日 *         [2026/02/14      📅]                             │
│                  ※複数日指定可（開始日 ≦ 終了日）                  │
│                                                                   │
│ ── 申請理由 ─────────────────────────────────────────────         │
│                                                                   │
│ 理由 *           ┌────────────────────────────────────────────┐   │
│                  │                                            │   │
│                  │                                            │   │
│                  │                                            │   │
│                  └────────────────────────────────────────────┘   │
│                  0/200文字（10文字以上）                           │
│                                                                   │
│                                                                   │
│                              [キャンセル]  [■ 申請する ■]         │
│                                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### バリデーションエラー表示

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                   │
│ 休暇種別 *       [慶弔休暇（理由必須）         ▼]                  │
│                                                                   │
│ ── 期間指定 ─────────────────────────────────────────────         │
│                                                                   │
│ 開始日 *         [2026/02/15      📅]                             │
│                                                                   │
│ 終了日 *         [2026/02/12      📅]                             │
│                  ⚠ 終了日は開始日以降を指定してください              │
│                                                                   │
│ ── 申請理由 ─────────────────────────────────────────────         │
│                                                                   │
│ 理由 *           ┌────────────────────────────────────────────┐   │
│                  │ 慶弔です                                  │   │
│                  └────────────────────────────────────────────┘   │
│                  ⚠ 10文字以上入力してください（現在4文字）         │
│                                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント構成

```
LeaveRequestCreatePage
├── Breadcrumb
│   └── BreadcrumbItem ("ホーム", "申請管理", "休暇申請一覧", "休暇申請作成")
├── PageHeader
│   └── Title ("休暇申請作成")
├── FormSection
│   ├── LeaveTypeSelect (休暇種別)
│   │   ├── SelectBox (ANNUAL, HALF_DAY_AM, HALF_DAY_PM, HOURLY, SPECIAL_CONDOLENCE, SPECIAL_REFRESH)
│   │   └── ErrorMessage
│   ├── LeavePeriodSection (期間指定) ──── 常時表示
│   │   ├── SectionDivider ("期間指定")
│   │   ├── StartDatePicker (開始日)
│   │   │   ├── DateInput
│   │   │   ├── CalendarIcon
│   │   │   └── ErrorMessage
│   │   ├── EndDatePicker (終了日) ──── HALF_DAY_AM/PM 時は非表示（開始日=終了日）
│   │   │   ├── DateInput
│   │   │   ├── CalendarIcon
│   │   │   ├── HelpText ("複数日指定可（開始日 ≦ 終了日）")
│   │   │   └── ErrorMessage
│   │   └── HelpText ──── HALF_DAY時: "半休は1日のみ指定"
│   ├── TimeSlotSection (時間帯指定) ──── HOURLY 時のみ表示
│   │   ├── SectionDivider ("時間帯指定")
│   │   ├── StartTimeSelect (開始時刻)
│   │   │   ├── SelectBox (1時間単位)
│   │   │   ├── HelpText ("1時間単位")
│   │   │   └── ErrorMessage
│   │   └── EndTimeSelect (終了時刻)
│   │       ├── SelectBox (1時間単位)
│   │       ├── HelpText ("最大5時間まで")
│   │       └── ErrorMessage
│   ├── ReasonSection (申請理由) ──── SPECIAL_* 時のみ表示
│   │   ├── SectionDivider ("申請理由")
│   │   ├── ReasonTextarea
│   │   │   ├── Textarea
│   │   │   ├── CharacterCount ("0/200文字（10文字以上）")
│   │   │   └── ErrorMessage
│   │   └── RequiredBadge
│   └── ButtonGroup
│       ├── CancelButton (キャンセル → 一覧へ戻る)
│       └── SubmitButton (申請する)
├── ConfirmDialog (申請確認ダイアログ)
└── ToastNotification (操作結果通知)
```

### 動的フォーム切替ルール

| 休暇種別 | 期間指定 | 終了日フィールド | 時間帯指定 | 申請理由 |
|----------|---------|----------------|-----------|---------|
| ANNUAL（年次有給） | 表示 | 表示（複数日可） | 非表示 | 非表示 |
| HALF_DAY_AM（午前半休） | 表示 | 非表示（from=to固定） | 非表示 | 非表示 |
| HALF_DAY_PM（午後半休） | 表示 | 非表示（from=to固定） | 非表示 | 非表示 |
| HOURLY（時間休） | 表示 | 非表示（from=to固定） | 表示 | 非表示 |
| SPECIAL_CONDOLENCE（慶弔） | 表示 | 表示（複数日可） | 非表示 | 表示（必須） |
| SPECIAL_REFRESH（リフレッシュ） | 表示 | 表示（複数日可） | 非表示 | 表示（必須） |

---

## 表示項目

### フォームフィールド

| フィールド | 表示名 | 型 | 必須 | 制約 | デフォルト |
|-----------|--------|-----|------|------|-----------|
| leaveType | 休暇種別 | select | ✅ | 6種別から選択 | ANNUAL |
| leavePeriod.from | 開始日 | date | ✅ | from ≦ to | 当日 |
| leavePeriod.to | 終了日 | date | ✅ | from ≦ to（HALF_DAY/HOURLY時はfrom固定） | 当日 |
| timeSlot.startTime | 開始時刻 | select(time) | HOURLY時 ✅ | 1時間単位 | 09:00 |
| timeSlot.endTime | 終了時刻 | select(time) | HOURLY時 ✅ | 1時間単位、上限5時間 | 10:00 |
| reason | 申請理由 | textarea | SPECIAL_*時 ✅ | 10-200文字 | 空 |

### 休暇種別の選択肢

| 値 | 表示名 | 補足 |
|----|--------|------|
| ANNUAL | 年次有給（1日単位） | 複数日可 |
| HALF_DAY_AM | 午前半休 | 単日固定 |
| HALF_DAY_PM | 午後半休 | 単日固定 |
| HOURLY | 時間休（時間帯指定） | 単日＋時刻指定 |
| SPECIAL_CONDOLENCE | 慶弔休暇（理由必須） | 複数日可＋理由必須 |
| SPECIAL_REFRESH | リフレッシュ休暇（理由必須） | 複数日可＋理由必須 |

### 開始時刻の選択肢（HOURLY時）

| 値 | 表示 |
|----|------|
| 09:00 | 09:00 |
| 10:00 | 10:00 |
| 11:00 | 11:00 |
| 12:00 | 12:00 |
| 13:00 | 13:00 |
| 14:00 | 14:00 |
| 15:00 | 15:00 |
| 16:00 | 16:00 |
| 17:00 | 17:00 |

### 終了時刻の選択肢（HOURLY時）

開始時刻に応じて動的生成。開始時刻 + 1時間〜開始時刻 + 5時間の範囲で1時間刻み。

---

## アクション

### フォームアクション

| アクション | トリガー | 処理 | 権限 |
|-----------|---------|------|------|
| 申請する | 申請ボタン | 確認ダイアログ → POST API 実行 → 一覧へ遷移 | write (従業員本人) |
| キャンセル | キャンセルボタン | 休暇申請一覧 (SCR-LV-001) へ遷移 | - |

### バリデーション

| フィールド | タイミング | ルール | エラーメッセージ |
|-----------|----------|--------|----------------|
| leaveType | onChange | 6種別のいずれか | 「休暇種別を選択してください」 |
| leavePeriod.from | onChange | 有効な日付 | 「開始日を選択してください」 |
| leavePeriod.to | onChange | from ≦ to | 「終了日は開始日以降を指定してください」 |
| timeSlot.startTime | onChange | 1時間単位、HOURLY時必須 | 「開始時刻を選択してください」 |
| timeSlot.endTime | onChange | startTime < endTime、上限5時間 | 「終了時刻は開始時刻より後で、最大5時間以内を指定してください」 |
| reason | onChange | SPECIAL_*時10-200文字 | 「10文字以上入力してください」/「200文字以内で入力してください」 |
| reason | onBlur | SPECIAL_*時10文字以上 | 「10文字以上入力してください（現在{N}文字）」 |
| (API) | onSubmit | 有給残高チェック | 「有給残日数が不足しています」(※APIエラー 422 で検出) |
| (API) | onSubmit | 同一日重複チェック | 「この日には既に休暇申請があります」(※APIエラー 409 で検出) |

### 確認ダイアログ

| 項目 | 内容 |
|------|------|
| メッセージ | 「以下の内容で休暇を申請しますか？」 |
| 表示内容 | 休暇種別、期間（from〜to）、時間帯（HOURLY時）、理由（SPECIAL_*時） |
| ボタン | [キャンセル] [申請する] |

---

## 状態管理

```typescript
/** 休暇種別 */
type LeaveType =
  | 'ANNUAL'
  | 'HALF_DAY_AM'
  | 'HALF_DAY_PM'
  | 'HOURLY'
  | 'SPECIAL_CONDOLENCE'
  | 'SPECIAL_REFRESH';

/** フォーム値 */
interface LeaveRequestForm {
  leaveType: LeaveType;
  leavePeriod: {
    from: string;              // ISO 8601 date
    to: string;                // ISO 8601 date
  };
  timeSlot: {
    startTime: string | null;  // "HH:mm" 形式（HOURLY時のみ）
    endTime: string | null;    // "HH:mm" 形式（HOURLY時のみ）
  };
  reason: string;              // SPECIAL_*時のみ使用、10-200文字
}

/** バリデーションエラー */
interface ValidationErrors {
  leaveType: string | null;
  'leavePeriod.from': string | null;
  'leavePeriod.to': string | null;
  'timeSlot.startTime': string | null;
  'timeSlot.endTime': string | null;
  reason: string | null;
}

/** 画面全体の状態 */
interface LeaveRequestCreateState {
  /** フォーム値 */
  form: LeaveRequestForm;

  /** バリデーションエラー */
  validationErrors: ValidationErrors;

  /** フォーム送信状態 */
  isSubmitting: boolean;

  /** 確認ダイアログ */
  confirmDialog: {
    isOpen: boolean;
  };

  /** APIエラー */
  error: {
    message: string;
    retryAction: (() => void) | null;
  } | null;

  /** フォーム変更フラグ（離脱確認用） */
  isDirty: boolean;

  /** 動的フォーム表示制御（leaveTypeから派生） */
  visibleSections: {
    endDateField: boolean;       // HALF_DAY/HOURLY時はfalse
    timeSlotSection: boolean;    // HOURLY時のみtrue
    reasonSection: boolean;      // SPECIAL_*時のみtrue
    multiDayHint: boolean;       // ANNUAL/SPECIAL_*時にtrue
  };
}
```

### 動的フォーム制御ロジック

```typescript
/** leaveType変更時のフォーム状態リセット＆表示制御 */
function deriveVisibleSections(leaveType: LeaveType): VisibleSections {
  const isHalfDay = leaveType === 'HALF_DAY_AM'
    || leaveType === 'HALF_DAY_PM';
  const isHourly = leaveType === 'HOURLY';
  const isSpecial = leaveType === 'SPECIAL_CONDOLENCE'
    || leaveType === 'SPECIAL_REFRESH';

  return {
    endDateField: !isHalfDay && !isHourly,
    timeSlotSection: isHourly,
    reasonSection: isSpecial,
    multiDayHint: !isHalfDay && !isHourly,
  };
}

/** leaveType変更時のフォーム値リセット */
function resetFormOnTypeChange(
  form: LeaveRequestForm,
  newType: LeaveType
): LeaveRequestForm {
  const isHalfDay = newType === 'HALF_DAY_AM'
    || newType === 'HALF_DAY_PM';
  const isHourly = newType === 'HOURLY';

  return {
    ...form,
    leaveType: newType,
    leavePeriod: {
      from: form.leavePeriod.from,
      to: (isHalfDay || isHourly)
        ? form.leavePeriod.from  // 単日固定
        : form.leavePeriod.to,
    },
    timeSlot: isHourly
      ? form.timeSlot
      : { startTime: null, endTime: null },
    reason: newType.startsWith('SPECIAL_')
      ? form.reason
      : '',
  };
}
```

---

## API連携

| 操作 | エンドポイント | メソッド | リクエスト |
|------|--------------|---------|-----------|
| 休暇申請作成 | `/api/v1/leave-requests` | POST | leaveType, leavePeriod, timeSlot?, reason? |

### リクエスト例（年次有給）

```json
{
  "leaveType": "ANNUAL",
  "leavePeriod": {
    "from": "2026-02-10",
    "to": "2026-02-12"
  }
}
```

### リクエスト例（時間休）

```json
{
  "leaveType": "HOURLY",
  "leavePeriod": {
    "from": "2026-02-10",
    "to": "2026-02-10"
  },
  "timeSlot": {
    "startTime": "09:00",
    "endTime": "12:00"
  }
}
```

### リクエスト例（特別休暇）

```json
{
  "leaveType": "SPECIAL_CONDOLENCE",
  "leavePeriod": {
    "from": "2026-02-10",
    "to": "2026-02-14"
  },
  "reason": "祖母の葬儀のため慶弔休暇を申請いたします"
}
```

### レスポンス例 (201 Created)

> 詳細APIと同一スキーマで作成されたリソース全体を返す。

```json
{
  "requestId": "LVR-20260210-EMP001",
  "employeeId": "EMP-001",
  "employeeName": "山田太郎",
  "leaveType": "ANNUAL",
  "leavePeriod": {
    "from": "2026-02-10",
    "to": "2026-02-12"
  },
  "timeSlot": null,
  "reason": null,
  "status": "SUBMITTED",
  "submittedAt": "2026-02-09T09:00:00+09:00",
  "approverId": null,
  "approverName": null,
  "approvedAt": null,
  "rejectionReason": null,
  "rejectedAt": null,
  "cancelledAt": null,
  "operationHistory": [
    {
      "action": "SUBMITTED",
      "performedBy": "EMP-001",
      "performedByName": "山田太郎",
      "performedAt": "2026-02-09T09:00:00+09:00",
      "comment": null
    }
  ]
}
```

---

## エラー処理

| エラー | HTTPステータス | 表示方法 | アクション |
|--------|--------------|---------|----------|
| 通信エラー | - | Toast (error) | 再試行ボタン |
| 認証エラー | 401 | リダイレクト | ログイン画面へ |
| バリデーションエラー | 400 | フォーム内エラー表示 | 各フィールド下にエラーメッセージ |
| 同一日重複 | 409 | Toast (warning) | 「この日には既に休暇申請があります」 |
| 有給残高不足 | 422 | Toast (warning) | 「有給残日数が不足しています」 |
| サーバーエラー | 500 | Toast (error) | 再試行ボタン |

### 離脱確認

フォームが変更済み（isDirty=true）の状態で画面遷移しようとした場合:
- ブラウザの `beforeunload` イベントで確認ダイアログ表示
- 「変更内容が破棄されます。よろしいですか？」

---

## レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| Desktop (>1024px) | フォーム幅 600px（中央寄せ） |
| Tablet (768-1024px) | フォーム幅 100%（パディング 24px） |
| Mobile (<768px) | フォーム幅 100%（パディング 16px）、ボタン幅 100% |

---

## デザインガイドライン

> aesthetic: `clean-minimal` / colorScheme: `mono-accent`

### カラー＆テーマ

| 項目 | 値 | 備考 |
|------|-----|------|
| ベースカラー | #FFFFFF | ページ背景 |
| サーフェスカラー | #F9FAFB (gray-50) | フォーム背景 |
| テキスト: Primary | #111827 (gray-900) | 見出し・入力値 |
| テキスト: Secondary | #6B7280 (gray-500) | ラベル・ヘルプテキスト |
| ボーダー | #E5E7EB (gray-200) | 入力フィールド枠 |
| ボーダー: フォーカス | #2563EB (blue-600) | フォーカス時の枠色 |
| アクセントカラー | #2563EB (blue-600) | Primary ボタン |
| セクション区切り | #E5E7EB (gray-200) | 動的セクション見出しの下線 |
| エラーカラー | #DC2626 (red-600) | エラーメッセージ・エラー枠 |
| コントラスト比 | WCAG AA 準拠（4.5:1 以上） | テキスト/背景 |

### タイポグラフィ

| 要素 | フォント | サイズ | ウェイト | 備考 |
|------|---------|--------|---------|------|
| ページタイトル | system-ui | 24px | 700 | パンくず下 |
| セクション見出し | system-ui | 13px | 600 | 「期間指定」「時間帯指定」「申請理由」 |
| フォームラベル | system-ui | 14px | 500 | フィールドラベル |
| 入力テキスト | system-ui | 14px | 400 | 入力値 |
| ヘルプテキスト | system-ui | 12px | 400 | 補足説明 |
| エラーメッセージ | system-ui | 12px | 500 | バリデーションエラー |
| 文字カウント | system-ui | 12px | 400 | 「0/200文字」 |
| ボタンラベル | system-ui | 14px | 500 | キャンセル・申請する |

### レイアウト原則

| 項目 | 値 |
|------|-----|
| 基本余白 | 8px グリッド |
| フォーム最大幅 | 600px |
| フォーム: パディング | 24px |
| フォーム: 角丸 | 8px |
| フォーム: ボーダー | 1px solid #E5E7EB |
| フィールド間余白 | 20px |
| セクション間余白 | 24px |
| セクション区切り線 | 1px solid #E5E7EB + テキスト |
| ラベルとフィールドの間 | 6px |
| 入力フィールド高さ | 40px |
| テキストエリア高さ | 120px |
| ボタン角丸 | 6px |
| ボタン高さ | 40px |
| ボタン間余白 | 12px |

### インタラクション

| 状態 | スタイル |
|------|---------|
| 入力フィールド: フォーカス | ボーダー blue-600 + リング |
| 入力フィールド: エラー | ボーダー red-600 |
| ボタン: ホバー | 背景色 5% 暗く |
| ボタン: disabled | opacity: 0.4（バリデーション未通過時） |
| ボタン: 送信中 | スピナー表示、全ボタン disabled |
| フォーカス | 2px outline (blue-600) + 2px offset |
| 文字カウント: 範囲超過 | テキスト色 red-600 |
| セクション表示/非表示 | 即時切替（アニメーションなし） |
| 画面遷移 | 即時（アニメーションなし） |
| フィードバック | Toast 通知（右上、3秒自動消去） |

### アンチパターン（避けるべき表現）

- グラデーション背景の多用
- 装飾的なドロップシャドウの重ね掛け
- 無意味なアニメーション・トランジション
- ジェネリックなAI生成風のイラスト
- 過度な角丸（pill 形状の乱用）
- フォームフィールドの過度な装飾（シンプルな枠線で十分）
- 必須マーク（*）以外の装飾的なインジケーター
- 動的セクション切替にスライド/フェードアニメーション（即時表示/非表示で十分）

---

## 品質チェック結果

- [x] 全クエリに対応する表示要素がある（フォームフィールド6項目 = APIリクエストフィールド対応）
- [x] 全コマンドに対応する操作UIがある（申請ボタン + 確認ダイアログ）
- [x] エラー状態の表示が定義されている（フォーム内バリデーション + APIエラー409/422のToast通知）
- [x] 状態遷移がUI上で表現されている（申請後は一覧画面へ遷移、SUBMITTED状態で表示）
- [x] 動的フォーム切替の全パターンが網羅されている（6種別 × 表示/非表示の組み合わせテーブル）
- [x] 条件付き必須フィールドの必須条件が明示されている（HOURLY→timeSlot、SPECIAL_*→reason）
- [x] 動的フォーム切替時のリセットロジックが定義されている（resetFormOnTypeChange）
- [x] 離脱確認（isDirty + beforeunload）が定義されている

<!-- メトリクスサマリー（/estimate 自動集計用）
画面種別: 登録
コンポーネント数: 22
DataTable: 0
SearchForm: 0
フォーム数: 1
チャート数: 0
-->
