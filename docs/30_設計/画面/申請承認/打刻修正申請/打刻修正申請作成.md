# 打刻修正申請作成

## 概要

| 項目 | 内容 |
|------|------|
| 画面ID | SCR-CC-003 |
| 画面種別 | 登録 |
| 関連集約 | 打刻修正申請（申請承認コンテキスト） |
| URL | `/clock-corrections/new` |

---

## ワイヤーフレーム

```
┌───────────────────────────────────────────────────────────────────────────┐
│ {システム名}                                                  [user ▼]   │
├───────────────────────────────────────────────────────────────────────────┤
│ パンくず: ホーム > 申請管理 > 打刻修正申請一覧 > 打刻修正申請作成       │
├───────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│ 打刻修正申請作成                                                        │
│                                                                         │
│ ┌─────────────────────────────────────────────────────────────────────┐ │
│ │                                                                   │ │
│ │ 修正対象日 *     [          📅]                                   │ │
│ │                  ※過去の勤務日を選択                               │ │
│ │                                                                   │ │
│ │ 修正種別 *       [選択してください           ▼]                    │ │
│ │                                                                   │ │
│ │ ┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐  │ │
│ │   ※修正種別を選択すると時刻入力欄が表示されます                   │ │
│ │ └ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┘  │ │
│ │                                                                   │ │
│ │ 修正理由 *       ┌────────────────────────────────────────────┐   │ │
│ │                  │                                            │   │ │
│ │                  │                                            │   │ │
│ │                  │                                            │   │ │
│ │                  └────────────────────────────────────────────┘   │ │
│ │                  0/200文字（10文字以上）                           │ │
│ │                                                                   │ │
│ │                                                                   │ │
│ │                              [キャンセル]  [■ 申請する ■]         │ │
│ │                                                                   │ │
│ └─────────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└───────────────────────────────────────────────────────────────────────────┘
```

### 修正種別「出勤」選択時

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                   │
│ 修正対象日 *     [2026/02/07      📅]                             │
│                  ※過去の勤務日を選択                               │
│                                                                   │
│ 修正種別 *       [出勤                         ▼]                  │
│                                                                   │
│ 修正後出勤時刻 * [ 09:00 ]                                        │
│                  ※HH:mm 形式（1分単位）                            │
│                                                                   │
│ 修正理由 *       ┌────────────────────────────────────────────┐   │
│                  │ ICカードの読み取り不良で打刻時刻がずれた   │   │
│                  │ ため、実際の出勤時刻に修正をお願いします   │   │
│                  │                                            │   │
│                  └────────────────────────────────────────────┘   │
│                  38/200文字（10文字以上）                           │
│                                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 修正種別「退勤」選択時

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                   │
│ 修正対象日 *     [2026/02/07      📅]                             │
│                  ※過去の勤務日を選択                               │
│                                                                   │
│ 修正種別 *       [退勤                         ▼]                  │
│                                                                   │
│ 修正後退勤時刻 * [ 18:30 ]                                        │
│                  ※HH:mm 形式（1分単位）                            │
│                                                                   │
│ 修正理由 *       ┌────────────────────────────────────────────┐   │
│                  │                                            │   │
│                  └────────────────────────────────────────────┘   │
│                  0/200文字（10文字以上）                            │
│                                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 修正種別「出勤・退勤の両方」選択時

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                   │
│ 修正対象日 *     [2026/02/07      📅]                             │
│                  ※過去の勤務日を選択                               │
│                                                                   │
│ 修正種別 *       [出勤・退勤の両方             ▼]                  │
│                                                                   │
│ 修正後出勤時刻 * [ 09:00 ]                                        │
│                  ※HH:mm 形式（1分単位）                            │
│ 修正後退勤時刻 * [ 18:00 ]                                        │
│                  ※HH:mm 形式（1分単位）                            │
│                                                                   │
│ 修正理由 *       ┌────────────────────────────────────────────┐   │
│                  │                                            │   │
│                  └────────────────────────────────────────────┘   │
│                  0/200文字（10文字以上）                            │
│                                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### バリデーションエラー表示

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                   │
│ 修正対象日 *     [2026/02/10      📅]                             │
│                  ⚠ 過去の勤務日を選択してください                   │
│                                                                   │
│ 修正種別 *       [選択してください           ▼]                    │
│                  ⚠ 修正種別を選択してください                       │
│                                                                   │
│ 修正後出勤時刻 * [ 09:00 ]                                        │
│                  ⚠ 修正前と同じ時刻は指定できません                 │
│                                                                   │
│ 修正理由 *       ┌────────────────────────────────────────────┐   │
│                  │ 修正します                                │   │
│                  └────────────────────────────────────────────┘   │
│                  ⚠ 10文字以上入力してください（現在5文字）         │
│                                                                   │
└─────────────────────────────────────────────────────────────────────┘
```

### 確認ダイアログ

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│   以下の内容で打刻修正を申請しますか？                          │
│                                                                 │
│   修正対象日:     2026/02/07 (金)                               │
│   修正種別:       退勤                                          │
│   修正後時刻:     18:30                                         │
│   修正理由:       退勤打刻を忘れたため、実際の退勤時刻...       │
│                                                                 │
│                          [キャンセル]  [■ 申請する ■]           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント構成

```
ClockCorrectionCreatePage
├── Breadcrumb
│   └── BreadcrumbItem ("ホーム", "申請管理", "打刻修正申請一覧", "打刻修正申請作成")
├── PageHeader
│   └── Title ("打刻修正申請作成")
├── FormSection
│   ├── TargetDatePicker (修正対象日)
│   │   ├── DateInput
│   │   ├── CalendarIcon
│   │   ├── HelpText ("過去の勤務日を選択")
│   │   └── ErrorMessage
│   ├── CorrectionTypeSelect (修正種別)
│   │   ├── SelectBox (CLOCK_IN / CLOCK_OUT / BOTH)
│   │   └── ErrorMessage
│   ├── DynamicClockTimeFields (修正種別に応じて動的表示)
│   │   ├── CorrectedClockInInput (修正後出勤時刻 — CLOCK_IN/BOTH時表示)
│   │   │   ├── TimeInput (HH:mm)
│   │   │   ├── HelpText ("HH:mm 形式（1分単位）")
│   │   │   └── ErrorMessage
│   │   ├── CorrectedClockOutInput (修正後退勤時刻 — CLOCK_OUT/BOTH時表示)
│   │   │   ├── TimeInput (HH:mm)
│   │   │   ├── HelpText ("HH:mm 形式（1分単位）")
│   │   │   └── ErrorMessage
│   │   └── Placeholder (修正種別未選択時: "修正種別を選択すると時刻入力欄が表示されます")
│   ├── ReasonTextarea (修正理由)
│   │   ├── Textarea
│   │   ├── CharacterCount ("0/200文字（10文字以上）")
│   │   └── ErrorMessage
│   └── ButtonGroup
│       ├── CancelButton (キャンセル → 一覧へ戻る)
│       └── SubmitButton (申請する)
├── ConfirmDialog (申請確認ダイアログ)
└── ToastNotification (操作結果通知)
```

---

## 表示項目

### フォームフィールド

| フィールド | 表示名 | 型 | 必須 | 制約 | デフォルト |
|-----------|--------|-----|------|------|-----------|
| targetDate | 修正対象日 | date | ✅ | 過去の勤務日 | 空 |
| correctionType | 修正種別 | select | ✅ | CLOCK_IN / CLOCK_OUT / BOTH | 空 |
| correctedClockIn | 修正後出勤時刻 | time | ✅ (CLOCK_IN/BOTH時) | HH:mm、修正前と異なること | 空 |
| correctedClockOut | 修正後退勤時刻 | time | ✅ (CLOCK_OUT/BOTH時) | HH:mm、修正前と異なること | 空 |
| reason | 修正理由 | textarea | ✅ | 10-200文字 | 空 |

### 修正種別の選択肢

| 値 | 表示 |
|----|------|
| CLOCK_IN | 出勤 |
| CLOCK_OUT | 退勤 |
| BOTH | 出勤・退勤の両方 |

### 修正種別による動的フィールド表示

| 修正種別 | correctedClockIn | correctedClockOut | 説明 |
|---------|:----------------:|:-----------------:|------|
| 未選択 | 非表示 | 非表示 | プレースホルダーテキスト表示 |
| CLOCK_IN | 表示 | 非表示 | 出勤時刻のみ入力 |
| CLOCK_OUT | 非表示 | 表示 | 退勤時刻のみ入力 |
| BOTH | 表示 | 表示 | 出勤・退勤の両方を入力 |

---

## アクション

### フォームアクション

| アクション | トリガー | 処理 | 権限 |
|-----------|---------|------|------|
| 申請する | 申請ボタン | 確認ダイアログ → POST API 実行 → 一覧へ遷移 | write (従業員本人) |
| キャンセル | キャンセルボタン | 打刻修正申請一覧 (SCR-CC-001) へ遷移 | - |

### バリデーション

| フィールド | タイミング | ルール | エラーメッセージ |
|-----------|----------|--------|----------------|
| targetDate | onChange | 過去の勤務日であること | 「過去の勤務日を選択してください」 |
| correctionType | onChange | 必須 | 「修正種別を選択してください」 |
| correctedClockIn | onSubmit | 修正前と異なること（CLOCK_IN/BOTH時） | 「修正前と同じ時刻は指定できません」 |
| correctedClockOut | onSubmit | 修正前と異なること（CLOCK_OUT/BOTH時） | 「修正前と同じ時刻は指定できません」 |
| correctedClockTime | onSubmit | 同一日同一種別の未確定申請がない | 「この日には既に未確定の打刻修正申請があります」(APIエラー409) |
| reason | onChange | 10-200文字 | 「10文字以上入力してください」/「200文字以内で入力してください」 |
| reason | onBlur | 10文字以上 | 「10文字以上入力してください（現在{N}文字）」 |

### 確認ダイアログ

| 項目 | 内容 |
|------|------|
| メッセージ | 「以下の内容で打刻修正を申請しますか？」 |
| 表示内容 | 対象日、修正種別、修正後時刻（種別に応じて1〜2つ）、理由（要約） |
| ボタン | [キャンセル] [申請する] |

---

## 状態管理

```typescript
/** 修正種別 */
type CorrectionType =
  | 'CLOCK_IN'
  | 'CLOCK_OUT'
  | 'BOTH';

/** フォーム値 */
interface ClockCorrectionForm {
  targetDate: string;                  // ISO 8601 date
  correctionType: CorrectionType | ''; // 未選択は空文字
  correctedClockIn: string;            // HH:mm（CLOCK_IN/BOTH時に使用）
  correctedClockOut: string;           // HH:mm（CLOCK_OUT/BOTH時に使用）
  reason: string;                      // 10-200文字
}

/** バリデーションエラー */
interface ValidationErrors {
  targetDate: string | null;
  correctionType: string | null;
  correctedClockIn: string | null;
  correctedClockOut: string | null;
  reason: string | null;
}

/** 画面全体の状態 */
interface ClockCorrectionCreateState {
  /** フォーム値 */
  form: ClockCorrectionForm;

  /** バリデーションエラー */
  validationErrors: ValidationErrors;

  /** フォーム送信状態 */
  isSubmitting: boolean;

  /** 確認ダイアログ */
  confirmDialog: {
    isOpen: boolean;
  };

  /** APIエラー */
  error: {
    message: string;
    retryAction: (() => void) | null;
  } | null;

  /** フォーム変更フラグ（離脱確認用） */
  isDirty: boolean;
}
```

### 修正種別変更時の状態リセット

修正種別が変更された場合、以下のリセット処理を行う:

| 変更パターン | リセット対象 |
|-------------|-------------|
| 任意 → CLOCK_IN | correctedClockOut を空にする |
| 任意 → CLOCK_OUT | correctedClockIn を空にする |
| 任意 → BOTH | リセットなし（両方入力可能） |
| 任意 → 未選択 | correctedClockIn / correctedClockOut 両方を空にする |

---

## API連携

| 操作 | エンドポイント | メソッド | リクエスト |
|------|--------------|---------|-----------|
| 打刻修正申請作成 | `/api/v1/clock-corrections` | POST | targetDate, correctionType, correctedClockIn, correctedClockOut, reason |

### リクエスト例（CLOCK_OUT の場合）

```json
{
  "targetDate": "2026-02-07",
  "correctionType": "CLOCK_OUT",
  "correctedClockOut": "18:30",
  "reason": "退勤打刻を忘れたため、実際の退勤時刻に修正をお願いします"
}
```

### リクエスト例（BOTH の場合）

```json
{
  "targetDate": "2026-02-07",
  "correctionType": "BOTH",
  "correctedClockIn": "09:00",
  "correctedClockOut": "18:00",
  "reason": "ICカード不具合により出退勤両方の打刻を修正します"
}
```

### レスポンス例 (201 Created)

```json
{
  "clockCorrectionRequestId": "CCR-20260207-EMP001",
  "employeeId": "EMP-001",
  "targetDate": "2026-02-07",
  "correctionType": "CLOCK_OUT",
  "originalClockIn": "09:00",
  "originalClockOut": "17:00",
  "correctedClockIn": null,
  "correctedClockOut": "18:30",
  "reason": "退勤打刻を忘れたため、実際の退勤時刻に修正をお願いします",
  "status": "SUBMITTED",
  "afterProvisionalClose": false,
  "requestedAt": "2026-02-08T09:00:00+09:00"
}
```

### 成功時の遷移

201 Created → 打刻修正申請一覧画面 (SCR-CC-001) へ遷移 + Toast「打刻修正申請を提出しました」

---

## エラー処理

| エラー | HTTPステータス | 表示方法 | アクション |
|--------|--------------|---------|----------|
| 通信エラー | - | Toast (error) | 再試行ボタン |
| 認証エラー | 401 | リダイレクト | ログイン画面へ |
| バリデーションエラー | 400 | フォーム内エラー表示 | 各フィールド下にエラーメッセージ |
| 勤怠記録なし | 404 | Toast (warning) | 「対象日の勤怠記録が存在しません」 |
| 同一日重複 | 409 | Toast (warning) | 「この日には既に未確定の打刻修正申請があります」 |
| 同一時刻修正 | 422 | Toast (warning) | 「修正前と同じ時刻は指定できません」 |
| サーバーエラー | 500 | Toast (error) | 再試行ボタン |

### 離脱確認

フォームが変更済み（isDirty=true）の状態で画面遷移しようとした場合:
- ブラウザの `beforeunload` イベントで確認ダイアログ表示
- 「変更内容が破棄されます。よろしいですか？」

---

## レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| Desktop (>1024px) | フォーム幅 600px（中央寄せ） |
| Tablet (768-1024px) | フォーム幅 100%（パディング 24px） |
| Mobile (<768px) | フォーム幅 100%（パディング 16px）、ボタン幅 100% |

---

## デザインガイドライン

> aesthetic: `clean-minimal` / colorScheme: `mono-accent`

### カラー＆テーマ

| 項目 | 値 | 備考 |
|------|-----|------|
| ベースカラー | #FFFFFF | ページ背景 |
| サーフェスカラー | #F9FAFB (gray-50) | フォーム背景 |
| テキスト: Primary | #111827 (gray-900) | 見出し・入力値 |
| テキスト: Secondary | #6B7280 (gray-500) | ラベル・ヘルプテキスト |
| ボーダー | #E5E7EB (gray-200) | 入力フィールド枠 |
| ボーダー: フォーカス | #2563EB (blue-600) | フォーカス時の枠色 |
| アクセントカラー | #2563EB (blue-600) | Primary ボタン |
| エラーカラー | #DC2626 (red-600) | エラーメッセージ・エラー枠 |
| コントラスト比 | WCAG AA 準拠（4.5:1 以上） | テキスト/背景 |

### タイポグラフィ

| 要素 | フォント | サイズ | ウェイト | 備考 |
|------|---------|--------|---------|------|
| ページタイトル | system-ui | 24px | 700 | パンくず下 |
| フォームラベル | system-ui | 14px | 500 | フィールドラベル |
| 入力テキスト | system-ui | 14px | 400 | 入力値 |
| 時刻入力 | monospace | 14px | 400 | HH:mm 形式を等幅で |
| ヘルプテキスト | system-ui | 12px | 400 | 補足説明 |
| エラーメッセージ | system-ui | 12px | 500 | バリデーションエラー |
| 文字カウント | system-ui | 12px | 400 | 「0/200文字」 |
| ボタンラベル | system-ui | 14px | 500 | キャンセル・申請する |

### レイアウト原則

| 項目 | 値 |
|------|-----|
| 基本余白 | 8px グリッド |
| フォーム最大幅 | 600px |
| フォーム: パディング | 24px |
| フォーム: 角丸 | 8px |
| フォーム: ボーダー | 1px solid #E5E7EB |
| フィールド間余白 | 20px |
| ラベルとフィールドの間 | 6px |
| 入力フィールド高さ | 40px |
| テキストエリア高さ | 120px |
| ボタン角丸 | 6px |
| ボタン高さ | 40px |
| ボタン間余白 | 12px |

### インタラクション

| 状態 | スタイル |
|------|---------|
| 入力フィールド: フォーカス | ボーダー blue-600 + リング |
| 入力フィールド: エラー | ボーダー red-600 |
| ボタン: ホバー | 背景色 5% 暗く |
| ボタン: disabled | opacity: 0.4（バリデーション未通過時） |
| ボタン: 送信中 | スピナー表示、全ボタン disabled |
| フォーカス | 2px outline (blue-600) + 2px offset |
| 文字カウント: 範囲超過 | テキスト色 red-600 |
| 修正種別変更時 | 時刻フィールドのアニメーションなし即時切替 |
| 画面遷移 | 即時（アニメーションなし） |
| フィードバック | Toast 通知（右上、3秒自動消去） |

### アンチパターン（避けるべき表現）

- グラデーション背景の多用
- 装飾的なドロップシャドウの重ね掛け
- 無意味なアニメーション・トランジション
- ジェネリックなAI生成風のイラスト
- 過度な角丸（pill 形状の乱用）
- フォームフィールドの過度な装飾（シンプルな枠線で十分）
- 必須マーク（*）以外の装飾的なインジケーター
- 修正種別切替時のスライドアニメーション（即時切替で十分）

---

## 品質チェック結果

- [x] 全クエリに対応する表示要素がある（フォームフィールド4項目 = APIリクエストフィールド4項目、修正種別に応じた動的表示対応）
- [x] 全コマンドに対応する操作UIがある（申請ボタン + 確認ダイアログ）
- [x] エラー状態の表示が定義されている（フォーム内バリデーション + APIエラー 400/404/409/422 のToast通知）
- [x] 状態遷移がUI上で表現されている（申請後は一覧画面へ遷移、SUBMITTED状態で表示）

<!-- メトリクスサマリー（/estimate 自動集計用）
画面種別: 登録
コンポーネント数: 16
DataTable: 0
SearchForm: 0
フォーム数: 1
チャート数: 0
-->
