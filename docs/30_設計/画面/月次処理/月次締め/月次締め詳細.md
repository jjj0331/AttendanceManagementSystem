# 月次締め詳細

## 概要

| 項目 | 内容 |
|------|------|
| 画面ID | SCR-MC-002 |
| 画面種別 | 詳細 |
| 関連集約 | 月次締め |
| URL | `/monthly-closings/{monthlyClosingId}` |

---

## ワイヤーフレーム

```
┌─────────────────────────────────────────────────────────────┐
│ 勤怠管理システム                            [ユーザー名 ▼] │
├─────────────────────────────────────────────────────────────┤
│ パンくず: ホーム > 月次処理 > 月次締め                       │
├─────────────────────────────────────────────────────────────┤
│ ┌─── 基本情報 ──────────────────────────────────────────┐   │
│ │ 月次締めID: MC-2025-01                                 │   │
│ │ 対象年月: 2025年 1月                                   │   │
│ │ 締めステータス: [確定]                                 │   │
│ │ 対象従業員数: 120名                                    │   │
│ │                                                        │   │
│ │ 締め実行者: 山田太郎                                   │   │
│ │ 仮締め日時: 2025-02-05 15:30:00                       │   │
│ │ 本締め日時: 2025-02-07 18:00:00                       │   │
│ │                                                        │   │
│ │ 作成日時: 2025-02-05 10:00:00                         │   │
│ │ 更新日時: 2025-02-07 18:00:00                         │   │
│ └────────────────────────────────────────────────────────┘   │
│                                                               │
│ ┌─── 仮締め結果 ────────────────────────────────────────┐   │
│ │ 対象従業員数: 120名                                    │   │
│ │ 未打刻件数: 0件                                        │   │
│ │ 未承認件数: 0件                                        │   │
│ │ フレックス月所定不足件数: 2件                          │   │
│ │ 問題あり: いいえ                                       │   │
│ └────────────────────────────────────────────────────────┘   │
│                                                               │
│ ┌─── エクスポート結果 ──────────────────────────────────┐   │
│ │ ファイルパス: /exports/payroll/2025-01.csv            │   │
│ │ 出力形式: CSV                                          │   │
│ │ レコード数: 120件                                      │   │
│ │                                                        │   │
│ │ エクスポート日時: 2025-02-08 09:15:00                 │   │
│ │ エクスポート実行者: 鈴木花子                           │   │
│ └────────────────────────────────────────────────────────┘   │
│                                                               │
│ ┌─── 操作ログ一覧 ──────────────────────────────────────┐   │
│ │ ┌──────────┬──────────┬─────────────────┬────────┐  │   │
│ │ │ 操作種別 │ 実行者   │ 実行日時        │ 結果   │  │   │
│ │ ├──────────┼──────────┼─────────────────┼────────┤  │   │
│ │ │エクスポート完了│鈴木花子│2025-02-08 09:15│ 成功 │  │   │
│ │ │本締め    │山田太郎  │2025-02-07 18:00 │ 成功   │  │   │
│ │ │仮締め再実行│山田太郎│2025-02-06 10:00 │ 成功   │  │   │
│ │ │仮締め    │山田太郎  │2025-02-05 15:30 │ 成功   │  │   │
│ │ └──────────┴──────────┴─────────────────┴────────┘  │   │
│ └────────────────────────────────────────────────────────┘   │
│                                                               │
│ ┌─ アクションボタン ─────────────────────────────────────┐  │
│ │ [仮締めする] [本締めする] [エクスポート] [ダウンロード] │  │
│ │                                          [一覧に戻る]   │  │
│ └────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## コンポーネント構成

```
MonthlyClosingDetailPage
├── Header
│   ├── Breadcrumb
│   └── UserMenu
├── PageTitle
│   └── MonthlyClosingId
├── BasicInfoSection
│   ├── SectionHeader ("基本情報")
│   ├── InfoGrid
│   │   ├── InfoField (monthlyClosingId)
│   │   ├── InfoField (year, month)
│   │   ├── StatusBadge (status)
│   │   ├── InfoField (totalEmployees)
│   │   ├── InfoField (closedBy)
│   │   ├── InfoField (preliminaryClosedAt, nullable)
│   │   ├── InfoField (finalClosedAt, nullable)
│   │   ├── InfoField (createdAt)
│   │   └── InfoField (updatedAt)
├── PreliminaryResultSection (条件付き表示)
│   ├── SectionHeader ("仮締め結果")
│   ├── InfoGrid
│   │   ├── InfoField (totalEmployees)
│   │   ├── InfoField (missingClockCount)
│   │   ├── InfoField (pendingApprovalCount)
│   │   ├── InfoField (flexDeficitCount)
│   │   └── BooleanField (hasIssues)
├── ExportResultSection (条件付き表示)
│   ├── SectionHeader ("エクスポート結果")
│   ├── InfoGrid
│   │   ├── InfoField (filePath)
│   │   ├── InfoField (format)
│   │   ├── InfoField (recordCount)
│   │   ├── InfoField (exportedAt)
│   │   └── InfoField (exportedBy)
├── OperationLogsSection
│   ├── SectionHeader ("操作ログ一覧")
│   ├── DataTable
│   │   ├── TableHeader (操作種別, 実行者, 実行日時, 結果)
│   │   ├── TableRow (複数)
│   │   │   ├── OperationTypeBadge
│   │   │   ├── ExecutorName
│   │   │   ├── ExecutedAt
│   │   │   └── ResultBadge
│   │   └── EmptyState
├── ActionBar
│   ├── PreliminaryCloseButton (条件付き活性)
│   ├── FinalizeButton (条件付き活性)
│   ├── ExportButton (条件付き活性)
│   ├── DownloadButton (条件付き活性)
│   └── BackToListLink
├── ConfirmationModal
│   ├── ModalTitle
│   ├── ConfirmationMessage
│   └── ButtonGroup (確認, キャンセル)
└── ExportStatusPoller (非同期処理中)
    ├── ProgressIndicator
    └── StatusMessage
```

---

## 表示項目

### 基本情報セクション

| フィールド | 表示名 | 型 | 備考 |
|-----------|--------|-----|------|
| monthlyClosingId | 月次締めID | string | - |
| year | 対象年 | number | "YYYY年" 形式 |
| month | 対象月 | number | "M月" 形式 |
| status | 締めステータス | badge | ステータスバッジ（後述） |
| totalEmployees | 対象従業員数 | number | "N名" 形式 |
| closedBy | 締め実行者 | string | - |
| preliminaryClosedAt | 仮締め日時 | datetime | nullable、未実施時は表示なし |
| finalClosedAt | 本締め日時 | datetime | nullable、未実施時は表示なし |
| createdAt | 作成日時 | datetime | - |
| updatedAt | 更新日時 | datetime | - |

### 仮締め結果セクション（条件付き表示）

**表示条件**: `status in ['PRELIMINARY_CLOSED', 'FINALIZED']`

| フィールド | 表示名 | 型 | 備考 |
|-----------|--------|-----|------|
| totalEmployees | 対象従業員数 | number | "N名" 形式 |
| missingClockCount | 未打刻件数 | number | "N件" 形式 |
| pendingApprovalCount | 未承認件数 | number | "N件" 形式 |
| flexDeficitCount | フレックス月所定不足件数 | number | "N件" 形式 |
| hasIssues | 問題あり | boolean | "はい" / "いいえ" |

### エクスポート結果セクション（条件付き表示）

**表示条件**: `exportResult != null`

| フィールド | 表示名 | 型 | 備考 |
|-----------|--------|-----|------|
| filePath | ファイルパス | string | - |
| format | 出力形式 | enum | "CSV" |
| recordCount | レコード数 | number | "N件" 形式 |
| exportedAt | エクスポート日時 | datetime | - |
| exportedBy | エクスポート実行者 | string | - |

### 操作ログ一覧テーブル

| カラム | 表示名 | 型 | ソート | 備考 |
|--------|--------|-----|--------|------|
| operationType | 操作種別 | badge | - | 操作種別バッジ（後述） |
| executedBy | 実行者 | text | - | - |
| executedAt | 実行日時 | datetime | - | 降順表示 |
| result | 結果 | badge | - | 成功/失敗 |

### ステータスバッジ

| 値 | 表示 | 色 |
|----|------|-----|
| NOT_STARTED | 未着手 | gray |
| PRELIMINARY_CLOSED | 仮締め済 | yellow |
| FINALIZED | 確定 | green |

### エクスポートステータスバッジ

| 値 | 表示 | 色 |
|----|------|-----|
| PROCESSING | 処理中 | blue |
| COMPLETED | 完了 | green |
| FAILED | 失敗 | red |

### 操作種別バッジ

| 値 | 表示 |
|----|------|
| PRELIMINARY_CLOSE | 仮締め |
| PRELIMINARY_RECLOSE | 仮締め再実行 |
| FINALIZE | 本締め |
| EXPORT_STARTED | エクスポート開始 |
| EXPORT_COMPLETED | エクスポート完了 |
| EXPORT_FAILED | エクスポート失敗 |

---

## アクション

### 画面アクション

| アクション | ラベル | 処理 | 活性条件 | 確認 | 権限 |
|-----------|--------|------|---------|------|------|
| 仮締め | 仮締めする | POST `/api/v1/monthly-closings/actions/preliminary-close` | `status in ['NOT_STARTED', 'PRELIMINARY_CLOSED']` AND `status != 'FINALIZED'` AND `month <= currentMonth` | ダイアログ表示: "仮締めを実行してよろしいですか？未打刻・未承認がある場合はリマインド通知が送信されます。" | hr:monthly-closing:write |
| 本締め | 本締めする | POST `/api/v1/monthly-closings/actions/finalize` | `status == 'PRELIMINARY_CLOSED'` AND `preliminaryResult.missingClockCount == 0` AND `preliminaryResult.pendingApprovalCount == 0` | ダイアログ表示: "本締めを実行してよろしいですか？本締め後はデータの変更ができなくなります。" | hr:monthly-closing:write |
| エクスポート | 給与データをエクスポート | POST `/api/v1/monthly-closings/actions/export-payroll` | `status == 'FINALIZED'` | ダイアログ表示: "給与データのエクスポートを実行してよろしいですか？" | hr:monthly-closing:export |
| ダウンロード | エクスポートファイルをダウンロード | ブラウザダウンロード | `exportResult != null` AND `exportStatus == 'COMPLETED'` | なし | hr:monthly-closing:export |

---

## 状態管理

```typescript
interface MonthlyClosingDetailState {
  data: {
    monthlyClosingId: string;
    month: {
      year: number;
      month: number;
    };
    status: 'NOT_STARTED' | 'PRELIMINARY_CLOSED' | 'FINALIZED';
    totalEmployees: number;
    closedBy: string;
    preliminaryClosedAt?: string;
    finalClosedAt?: string;
    createdAt: string;
    updatedAt: string;
    preliminaryResult?: {
      totalEmployees: number;
      missingClockCount: number;
      pendingApprovalCount: number;
      flexDeficitCount: number;
      hasIssues: boolean;
    };
    exportResult?: {
      filePath: string;
      format: 'CSV';
      recordCount: number;
      exportedAt: string;
      exportedBy: string;
    };
    operationLogs: Array<{
      operationType: 'PRELIMINARY_CLOSE' | 'PRELIMINARY_RECLOSE' | 'FINALIZE' | 'EXPORT_STARTED' | 'EXPORT_COMPLETED' | 'EXPORT_FAILED';
      executedBy: string;
      executedAt: string;
      result: 'SUCCESS' | 'FAILURE';
      resultDetail?: string;
    }>;
  };
  loading: {
    isLoading: boolean;
    isActionProcessing: boolean;
    exportPolling: boolean;
  };
  exportStatus: 'PROCESSING' | 'COMPLETED' | 'FAILED' | null;
  modal: {
    isOpen: boolean;
    actionType: 'preliminary-close' | 'finalize' | 'export-payroll' | null;
    message: string;
  };
  error: Error | null;
}
```

---

## API連携

| 操作 | エンドポイント | メソッド | 備考 |
|------|--------------|---------|------|
| 詳細取得 | `/api/v1/monthly-closings/{monthlyClosingId}` | GET | - |
| 仮締め実行 | `/api/v1/monthly-closings/actions/preliminary-close` | POST | - |
| 本締め実行 | `/api/v1/monthly-closings/actions/finalize` | POST | - |
| エクスポート実行 | `/api/v1/monthly-closings/actions/export-payroll` | POST | 非同期処理 |
| エクスポートステータス確認 | `/api/v1/monthly-closings/{monthlyClosingId}/export-status` | GET | ポーリング（2秒間隔） |

### 非同期処理フロー（エクスポート）

1. ユーザーが「エクスポート」ボタンをクリック
2. 確認ダイアログ表示
3. 確認後、POST `/actions/export-payroll` 実行
4. レスポンス受信後、`exportStatus = 'PROCESSING'` に変更
5. ポーリング開始: GET `/export-status` を2秒ごとに実行
6. `exportStatus == 'COMPLETED'` になったらポーリング停止
7. 詳細データを再取得して `exportResult` セクションを表示
8. ダウンロードボタンが活性化

---

## エラー処理

| エラー | 表示方法 | アクション |
|--------|---------|----------|
| 通信エラー | トースト通知（右上、3秒） | 再試行ボタン |
| 認証エラー | リダイレクト | ログイン画面へ |
| 活性条件違反 | ボタン非活性 | ツールチップで理由表示 |
| エクスポート失敗 | トースト通知 + エラー詳細モーダル | 再試行可能 |

---

## レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| Desktop (>1024px) | フル表示、セクション横並び（2カラム） |
| Tablet (768-1024px) | セクション1カラム、ラベル/値は横並び維持 |
| Mobile (<768px) | セクション1カラム、ラベル/値も縦並びスタック |

---

## デザインガイドライン

### カラー＆テーマ

| 項目 | 値 | 備考 |
|------|-----|------|
| ベースカラー | #FFFFFF | ライトモード |
| アクセントカラー | #3B82F6 | プライマリアクション（仮締め、本締め） |
| セマンティック: Success | #10B981 | 本締め完了・エクスポート成功 |
| セマンティック: Warning | #F59E0B | 仮締め済み・処理中 |
| セマンティック: Error | #EF4444 | エクスポート失敗 |
| セマンティック: Info | #6B7280 | 未着手 |
| コントラスト比 | WCAG AA 準拠（4.5:1 以上） | テキスト/背景 |

### タイポグラフィ

| 要素 | フォント | サイズ | ウェイト |
|------|---------|--------|---------|
| ページタイトル（h1） | system-ui | 24px | 700 |
| セクション見出し（h2） | system-ui | 18px | 600 |
| フィールドラベル | system-ui | 12px | 500 |
| フィールド値 | system-ui | 14px | 400 |
| 数値強調 | monospace | 16px | 700 |

### レイアウト原則

| 項目 | 値 |
|------|-----|
| 基本余白 | 8px グリッド |
| セクション間 | 24px |
| セクション内パディング | 16px |
| カード角丸 | 8px |
| ボタン角丸 | 6px |
| カード影 | 0 1px 3px rgba(0,0,0,0.1) |
| 区切り線 | 1px solid #E5E7EB |

### インタラクション

| 状態 | スタイル |
|------|---------|
| ホバー | 背景色変化（opacity: 0.08） |
| フォーカス | 2px outline (#3B82F6) + 2px offset |
| ローディング | Skeleton UI（セクション読み込み中） |
| 処理中 | Spinner表示 + ボタン非活性 |
| 画面遷移 | 即時（アニメーションなし） |
| フィードバック | Toast 通知（右上、3秒自動消去） |

### アンチパターン（避けるべき表現）

- グラデーション背景の多用
- 装飾的なドロップシャドウの重ね掛け
- 無意味なアニメーション・トランジション
- ジェネリックなAI生成風のイラスト
- 過度な角丸（pill 形状の乱用）

---

## ドメイン不変条件

| ID | ルール | UI反映 |
|----|--------|--------|
| INV-MC-001 | FINALIZED後は再実行不可 | `status == 'FINALIZED'` の場合、仮締め・本締めボタンを非活性 |
| INV-MC-002 | 本締めは未打刻/未承認=0 | 本締めボタン活性条件に `missingClockCount == 0 AND pendingApprovalCount == 0` を含める |
| INV-MC-003 | 月次1回のみFINALIZE | 本締めボタンは `status == 'PRELIMINARY_CLOSED'` のみ活性 |

---

<!-- メトリクスサマリー（/estimate 自動集計用）
画面種別: 詳細
コンポーネント数: 28
DataTable: 1
SearchForm: 0
フォーム数: 0
チャート数: 0
-->
