# 月次勤怠サマリー

## 概要

| 項目 | 内容 |
|------|------|
| 画面ID | SCR-ATT-003 |
| 画面種別 | ダッシュボード |
| 関連集約 | 勤怠記録（勤怠管理コンテキスト） |
| URL | `/attendances/monthly-summary` |

---

## ワイヤーフレーム

```
┌───────────────────────────────────────────────────────────────────────────┐
│ {システム名}                                                  [user ▼]   │
├───────────────────────────────────────────────────────────────────────────┤
│ パンくず: ホーム > 勤怠管理 > 月次勤怠サマリー                           │
├───────────────────────────────────────────────────────────────────────────┤
│ ┌───────────────────────────────────────────────────────────────────────┐ │
│ │ フィルター                                                         │ │
│ │                                                                     │ │
│ │ 部署     [上長の部署          ▼]   対象年月  [2025-01     ]         │ │
│ │                                                                     │ │
│ └───────────────────────────────────────────────────────────────────────┘ │
├───────────────────────────────────────────────────────────────────────────┤
│                                                        [■ CSV出力 ■]    │
├───────────────────────────────────────────────────────────────────────────┤
│ ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ ┌──────  │
│ │ 出勤日数         │ │ 総労働時間       │ │ 総残業時間       │ │ 有給  │
│ │ 合計/平均        │ │ 合計/平均        │ │ 合計/平均        │ │ 使用  │
│ │                  │ │                  │ │                  │ │ 合計  │
│ │  合計: 440日     │ │  合計: 3,520h    │ │  合計: 320h      │ │       │
│ │  平均:  22日     │ │  平均: 176.0h    │ │  平均:  16.0h    │ │  32日 │
│ └──────────────────┘ └──────────────────┘ └──────────────────┘ └──────  │
├───────────────────────────────────────────────────────────────────────────┤
│ 従業員別サマリー                                                         │
├───────────────────────────────────────────────────────────────────────────┤
│ ┌──────────┬──────┬──────────┬──────────┬──────────┬──────────┬──────┐  │
│ │ 従業員名▼│出勤  │総労働時間▼│総残業時間▼│深夜勤務  │有給使用  │従業員│  │
│ │          │日数  │          │          │時間      │日数      │ID    │  │
│ ├──────────┼──────┼──────────┼──────────┼──────────┼──────────┼──────┤  │
│ │ 青木 太郎│  22  │   176.0h │    12.5h │     2.0h │    1.0   │E-001 │  │
│ │ 伊藤 花子│  21  │   172.5h │    18.0h │     4.5h │    2.0   │E-002 │  │
│ │ 上田 次郎│  20  │   160.0h │     0.0h │     0.0h │    3.0   │E-003 │  │
│ │ 江藤 三郎│  22  │   184.0h │    24.0h │     8.0h │    0.0   │E-004 │  │
│ │ 大野 四郎│  18  │   144.0h │     0.0h │     0.0h │    5.0   │E-005 │  │
│ └──────────┴──────┴──────────┴──────────┴──────────┴──────────┴──────┘  │
├───────────────────────────────────────────────────────────────────────────┤
│ < 1 2 3 4 5 >                                          20件/ページ ▼   │
└───────────────────────────────────────────────────────────────────────────┘
```

---

## コンポーネント構成

```
MonthlySummaryPage
├── Breadcrumb
│   └── BreadcrumbItem ("ホーム", "勤怠管理", "月次勤怠サマリー")
├── FilterBar (上部固定)
│   ├── DepartmentSelect (部署セレクト)
│   └── MonthPicker (対象年月、YYYY-MM 形式)
├── ActionBar
│   └── CsvExportButton ("CSV出力")
├── KpiCardGrid (4カラムグリッド)
│   ├── KpiCard (出勤日数: 合計/平均)
│   │   ├── MetricLabel ("出勤日数")
│   │   ├── MetricValue (合計値)
│   │   └── MetricSubValue (平均値)
│   ├── KpiCard (総労働時間: 合計/平均)
│   │   ├── MetricLabel ("総労働時間")
│   │   ├── MetricValue (合計値)
│   │   └── MetricSubValue (平均値)
│   ├── KpiCard (総残業時間: 合計/平均)
│   │   ├── MetricLabel ("総残業時間")
│   │   ├── MetricValue (合計値)
│   │   └── MetricSubValue (平均値)
│   └── KpiCard (有給使用日数: 合計)
│       ├── MetricLabel ("有給使用日数")
│       └── MetricValue (合計値)
├── DataTable (従業員別サマリー)
│   ├── TableHeader (ソート可: 従業員名, 総労働時間, 総残業時間)
│   ├── TableRow
│   │   ├── TextCell (従業員名)
│   │   ├── NumberCell (出勤日数)
│   │   ├── NumberCell (総労働時間)
│   │   ├── NumberCell (総残業時間)
│   │   ├── NumberCell (深夜勤務時間)
│   │   ├── NumberCell (有給使用日数)
│   │   └── TextCell (従業員ID)
│   └── EmptyState ("該当する勤怠サマリーがありません")
└── Pagination
    ├── PageNumbers
    └── PageSizeSelector (20件/ページ)
```

---

## 表示項目

### KPIカード

| 指標 | データソース | 表示形式 | 備考 |
|------|------------|---------|------|
| 出勤日数 | workDays の全従業員合計/平均 | 合計: N日 / 平均: N.N日 | - |
| 総労働時間 | totalWorkHours の全従業員合計/平均 | 合計: N,NNNh / 平均: NNN.Nh | 小数第1位 |
| 総残業時間 | totalOvertimeHours の全従業員合計/平均 | 合計: NNNh / 平均: NN.Nh | 小数第1位 |
| 有給使用日数 | paidLeaveUsed の全従業員合計 | 合計: N日 | 平均なし |

### 一覧カラム（従業員別サマリーテーブル）

| カラム | 表示名 | 型 | ソート | 幅 | 備考 |
|--------|--------|-----|--------|------|------|
| employeeName | 従業員名 | text | ✅ (デフォルト昇順) | 140px | - |
| workDays | 出勤日数 | number | - | 80px | 日 |
| totalWorkHours | 総労働時間 | number | ✅ | 120px | 小数第1位 + "h" |
| totalOvertimeHours | 総残業時間 | number | ✅ | 120px | 小数第1位 + "h" |
| lateNightHours | 深夜勤務時間 | number | - | 120px | 小数第1位 + "h" |
| paidLeaveUsed | 有給使用日数 | number | - | 100px | 小数第1位 |
| employeeId | 従業員ID | text | - | 80px | 参照用 |

---

## 検索条件（フィルター）

| 条件 | フィールド名 | 入力形式 | 演算子 | デフォルト | 備考 |
|------|-------------|---------|--------|-----------|------|
| 部署 | departmentId | セレクト (DepartmentId) | = | 上長の部署 | 人事は全部署選択可 |
| 対象年月 | month | 月ピッカー (YYYY-MM) | = | 当月 | カレンダーピッカー |

### 部署セレクトの権限制御

| 権限 | 挙動 |
|------|------|
| 上長 | 自部署のみ（セレクト非表示、固定） |
| 人事 | 全部署から選択可 |

---

## アクション

### 画面アクション

| アクション | トリガー | 処理 | 権限 |
|-----------|---------|------|------|
| フィルター適用 | 部署/年月変更 | KPI再計算 + テーブル再取得 | read (上長+人事) |
| CSV出力 | CSV出力ボタン | 現在のフィルター条件でCSVダウンロード | read (上長+人事) |
| ソート変更 | カラムヘッダークリック | ソート条件変更 + テーブル再取得 | read |
| ページ切替 | ページネーション操作 | ページ変更 + テーブル再取得 | read |

### 行アクション

| アクション | 処理 | 備考 |
|-----------|------|------|
| 行クリック | なし | 将来対応（従業員別の日次勤怠一覧への遷移） |

---

## 状態管理

```typescript
/** ソート方向 */
type SortOrder = 'asc' | 'desc';

/** ソート可能カラム */
type SortableColumn =
  | 'employeeName'
  | 'totalWorkHours'
  | 'totalOvertimeHours';

/** KPI指標 */
interface KpiMetric {
  label: string;
  total: number;
  average: number | null;  // 有給使用日数は平均なし
  unit: string;            // "日", "h"
}

/** 従業員別サマリーアイテム */
interface MonthlySummaryItem {
  employeeId: string;
  employeeName: string;
  workDays: number;
  totalWorkHours: number;
  totalOvertimeHours: number;
  lateNightHours: number;
  paidLeaveUsed: number;
}

/** フィルターパラメータ */
interface FilterParams {
  departmentId: string;       // デフォルト: 上長の部署
  month: string;              // YYYY-MM 形式、デフォルト: 当月
}

/** ページネーション */
interface PaginationState {
  page: number;               // 現在ページ (0-based)
  size: number;               // 1ページあたり件数 (デフォルト: 20)
  sort: SortableColumn;       // ソートカラム (デフォルト: employeeName)
  order: SortOrder;           // ソート方向 (デフォルト: asc)
}

/** 画面全体の状態 */
interface MonthlySummaryState {
  /** フィルター条件 */
  filterParams: FilterParams;

  /** ページネーション */
  pagination: PaginationState;

  /** KPIカード */
  kpiCards: {
    metrics: KpiMetric[];
    isLoading: boolean;
  };

  /** テーブルデータ */
  data: {
    content: MonthlySummaryItem[];
    page: {
      number: number;
      size: number;
      totalElements: number;
      totalPages: number;
    };
    isLoading: boolean;
    error: {
      message: string;
      retryAction: (() => void) | null;
    } | null;
  };

  /** CSV出力 */
  csvExport: {
    isExporting: boolean;
  };
}
```

---

## API連携

| 操作 | エンドポイント | メソッド | パラメータ |
|------|--------------|---------|-----------|
| サマリー取得 | `/api/v1/attendances/monthly-summary` | GET | departmentId, month, page, size, sort, order |
| CSV出力 | `/api/v1/attendances/monthly-summary/export` | GET | departmentId, month |

### リクエスト例

```
GET /api/v1/attendances/monthly-summary
  ?departmentId=DEPT-001
  &month=2025-01
  &page=0
  &size=20
  &sort=employeeName
  &order=asc
```

### レスポンス例

```json
{
  "kpi": {
    "totalWorkDays": 440,
    "avgWorkDays": 22.0,
    "totalWorkHours": 3520.0,
    "avgWorkHours": 176.0,
    "totalOvertimeHours": 320.0,
    "avgOvertimeHours": 16.0,
    "totalPaidLeaveUsed": 32.0
  },
  "content": [
    {
      "employeeId": "E-001",
      "employeeName": "青木 太郎",
      "workDays": 22,
      "totalWorkHours": 176.0,
      "totalOvertimeHours": 12.5,
      "lateNightHours": 2.0,
      "paidLeaveUsed": 1.0
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 20,
    "totalPages": 1
  }
}
```

---

## エラー処理

| エラー | HTTPステータス | 表示方法 | アクション |
|--------|--------------|---------|----------|
| 通信エラー | - | Toast (error) | 再試行ボタン |
| 認証エラー | 401 | リダイレクト | ログイン画面へ |
| 権限エラー | 403 | Toast (error) | 「この画面を閲覧する権限がありません」 |
| バリデーションエラー | 422 | Toast (warning) | フィルター条件の修正を促す |
| サーバーエラー | 500 | Toast (error) | 再試行ボタン |
| CSV出力エラー | 500 | Toast (error) | 「CSV出力に失敗しました。再試行してください」 |

---

## レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| Desktop (>1024px) | KPIカード4列横並び、フルテーブル表示 |
| Tablet (768-1024px) | KPIカード2列、深夜勤務・従業員IDカラム非表示 |
| Mobile (<768px) | KPIカード1列、テーブルは横スクロール |

### Tablet 時の非表示カラム

| カラム | 理由 |
|--------|------|
| lateNightHours | 詳細情報。必要時はDesktopで確認 |
| employeeId | 従業員名で識別可能 |

### Mobile カード形式

```
┌──────────────────────────────────┐
│ [出勤日数]        [総労働時間]    │
│  合計: 440日       合計: 3,520h  │
├──────────────────────────────────┤
│ [総残業時間]      [有給使用日数]  │
│  合計: 320h        合計: 32日    │
├──────────────────────────────────┤
│ 従業員別サマリー → 横スクロール   │
└──────────────────────────────────┘
```

---

## デザインガイドライン

> aesthetic: `clean-minimal` / colorScheme: `mono-accent`

### カラー＆テーマ

| 項目 | 値 | 備考 |
|------|-----|------|
| ベースカラー | #FFFFFF | ページ背景 |
| サーフェスカラー | #F9FAFB (gray-50) | フィルターバー背景 |
| テキスト: Primary | #111827 (gray-900) | 見出し・KPI数値・テーブルデータ |
| テキスト: Secondary | #6B7280 (gray-500) | ラベル・補足テキスト |
| ボーダー | #E5E7EB (gray-200) | テーブル罫線・KPIカード区切り |
| アクセントカラー | #2563EB (blue-600) | Primary ボタン・ソートアイコン・KPI数値強調 |
| KPIカード背景 | #FFFFFF | 白背景 + 薄いボーダー |
| コントラスト比 | WCAG AA 準拠（4.5:1 以上） | テキスト/背景 |

### タイポグラフィ

| 要素 | フォント | サイズ | ウェイト | 備考 |
|------|---------|--------|---------|------|
| ページタイトル | system-ui | 24px | 700 | パンくず下 |
| KPIラベル | system-ui | 12px | 500 | 指標名 |
| KPI数値（合計） | monospace | 28px | 700 | メイン数値、アクセントカラー |
| KPI数値（平均） | monospace | 14px | 400 | サブ数値、Secondary テキスト |
| フィルターラベル | system-ui | 12px | 500 | 部署・対象年月 |
| テーブルヘッダー | system-ui | 12px | 600 | カラム名 |
| テーブルデータ | system-ui | 14px | 400 | セルデータ |
| 数値データ | monospace | 14px | 400 | 時間・日数を等幅で |
| ボタンラベル | system-ui | 14px | 500 | CSV出力 |

### レイアウト原則

| 項目 | 値 |
|------|-----|
| 基本余白 | 8px グリッド |
| ページ左右パディング | 24px |
| フィルターバー: パディング | 16px |
| フィルターバー: 角丸 | 8px |
| KPIカード: パディング | 20px |
| KPIカード: 角丸 | 8px |
| KPIカード: ボーダー | 1px solid #E5E7EB |
| KPIカード間余白 | 16px |
| セクション間余白 | 24px |
| テーブル行高 | 48px |
| ボタン角丸 | 6px |
| ボタン高さ | 36px |
| カード影 | なし（clean-minimal） |
| 区切り線 | 1px solid #E5E7EB |

### インタラクション

| 状態 | スタイル |
|------|---------|
| KPIカード: ホバー | なし（静的表示） |
| テーブル行: ホバー | 背景色 gray-50 |
| ソートヘッダー: ホバー | テキスト色 blue-600 + カーソル pointer |
| ソートヘッダー: アクティブ | ▲/▼ アイコン表示 + テキスト色 blue-600 |
| CSV出力ボタン: ホバー | 背景色 5% 暗く |
| CSV出力ボタン: エクスポート中 | spinner + "出力中..." + disabled |
| フォーカス | 2px outline (blue-600) + 2px offset |
| ローディング（KPI） | KPIカード内に Skeleton UI（数値部分） |
| ローディング（テーブル） | テーブル部分に Skeleton UI（5行分） |
| 画面遷移 | 即時（アニメーションなし） |
| フィードバック | Toast 通知（右上、3秒自動消去） |
| ページネーション: ホバー | 背景色 gray-100 |
| ページネーション: 現在ページ | 背景色 blue-600 + テキスト白 |

### アンチパターン（避けるべき表現）

- グラデーション背景の多用
- 装飾的なドロップシャドウの重ね掛け
- 無意味なアニメーション・トランジション
- ジェネリックなAI生成風のイラスト
- 過度な角丸（pill 形状の乱用）
- KPIカードに不必要なアイコン装飾
- テーブルのゼブラストライプ（clean-minimalでは罫線のみ）
- KPI数値への過度な色彩（mono-accentではアクセント1色のみ）

---

## 品質チェック結果

- [x] 全クエリに対応する表示要素がある（7カラムのDataTable、4枚のKPIカード、2条件のフィルター、ページネーション）
- [x] 全コマンドに対応する操作UIがある（CSV出力ボタン）
- [x] エラー状態の表示が定義されている（Toast通知 + 再試行ボタン、権限エラー・CSV出力エラー対応）
- [x] 状態遷移がUI上で表現されている（KPIカード/テーブルのローディングSkeleton、CSV出力中spinner）

<!-- メトリクスサマリー（/estimate 自動集計用）
画面種別: ダッシュボード
コンポーネント数: 22
DataTable: 1
SearchForm: 0
フォーム数: 0
チャート数: 0
-->
