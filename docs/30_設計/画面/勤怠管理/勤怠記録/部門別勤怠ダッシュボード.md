# 部門別勤怠ダッシュボード

## 概要

| 項目 | 内容 |
|------|------|
| 画面ID | SCR-ATT-004 |
| 画面種別 | ダッシュボード |
| 関連集約 | 勤怠記録（勤怠管理コンテキスト） |
| URL | `/attendances/department-dashboard` |

---

## ワイヤーフレーム

```
┌───────────────────────────────────────────────────────────────────────────────┐
│ {システム名}                                                      [user ▼]   │
├───────────────────────────────────────────────────────────────────────────────┤
│ パンくず: ホーム > 勤怠管理 > 部門別勤怠ダッシュボード                        │
├───────────────────────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────────────────────┐   │
│ │ フィルター                                                             │   │
│ │ 部署 [全部門          ▼]   対象年月 [2025-01 ▼]       [■ CSV出力 ■]   │   │
│ └─────────────────────────────────────────────────────────────────────────┘   │
├───────────────────────────────────────────────────────────────────────────────┤
│                                                                               │
│ ┌──────────────────┐ ┌──────────────────┐ ┌──────────────────┐ ┌──────────┐ │
│ │ 全社平均残業時間  │ │ 36協定超過       │ │ 未打刻           │ │ 全社     │ │
│ │                  │ │ アラート総件数    │ │ 総件数           │ │ 出勤率   │ │
│ │    18.5 h        │ │    (!) 3 件      │ │    (!) 12 件     │ │  96.2 %  │ │
│ │    ──────        │ │    ──────        │ │    ──────        │ │  ──────  │ │
│ │  前月比 +2.1h    │ │  前月比 +1件     │ │  前月比 -3件     │ │ 前月比   │ │
│ │                  │ │                  │ │                  │ │ +0.5%    │ │
│ └──────────────────┘ └──────────────────┘ └──────────────────┘ └──────────┘ │
│                                                                               │
├───────────────────────────────────────────────────────────────────────────────┤
│ 部門別データ                                                                  │
│ ┌──────────┬──────┬──────────┬──────────┬──────────────┬────────┬──────────┐ │
│ │ 部署名 ▼ │ 人数 │ 平均残業 │ 最大残業 │ 36協定超過   │ 未打刻 │ 出勤率   │ │
│ │          │      │  (h) ▼   │  (h) ▼   │ アラート ▼   │   ▼    │  (%) ▼   │ │
│ ├──────────┼──────┼──────────┼──────────┼──────────────┼────────┼──────────┤ │
│ │ 営業部   │  25  │   22.3   │   45.0   │  (!) 2       │ (!) 5  │   95.0   │ │
│ │ 開発部   │  40  │   25.8   │   52.0   │  (!) 1       │ (!) 3  │   94.5   │ │
│ │ 人事部   │  10  │    8.2   │   15.0   │      0       │     1  │   98.0   │ │
│ │ 経理部   │  15  │   12.0   │   28.0   │      0       │     2  │   97.2   │ │
│ │ 総務部   │  12  │   10.5   │   20.0   │      0       │ (!) 1  │   96.8   │ │
│ └──────────┴──────┴──────────┴──────────┴──────────────┴────────┴──────────┘ │
├───────────────────────────────────────────────────────────────────────────────┤
│ < 1 2 3 >                                                 20件/ページ ▼     │
└───────────────────────────────────────────────────────────────────────────────┘
```

### アラートバッジ凡例

```
 (!) = アラートバッジ

 36協定超過アラート:  1件以上 → 赤バッジ (!) で強調
 未打刻件数:          1件以上 → オレンジバッジ (!) で強調
 0件の場合はバッジなし、数値のみ表示
```

### KPIカード詳細

```
┌──────────────────┐
│ {指標名}         │  ← ラベル (12px, gray-500)
│                  │
│   {値} {単位}    │  ← メトリクス値 (28px, bold, gray-900)
│   ──────         │  ← 区切り線
│  前月比 {差分}   │  ← トレンド (12px, green=改善/red=悪化)
│                  │
└──────────────────┘

※ 36協定超過・未打刻のKPIカードは値が1以上の場合、
   カード左ボーダーにアクセントカラー（赤/オレンジ）を付与
```

---

## コンポーネント構成

```
DepartmentDashboardPage
├── Breadcrumb
│   └── BreadcrumbItem ("ホーム", "勤怠管理", "部門別勤怠ダッシュボード")
├── FilterBar (上部固定)
│   ├── DepartmentSelect (部署選択)
│   ├── MonthPicker (対象年月)
│   └── CsvExportButton ("CSV出力")
├── KpiCardGrid (4カラムグリッド)
│   ├── KpiCard (全社平均残業時間)
│   │   ├── MetricLabel
│   │   ├── MetricValue
│   │   └── TrendIndicator (前月比)
│   ├── KpiCard (36協定超過アラート総件数)
│   │   ├── MetricLabel
│   │   ├── MetricValue
│   │   ├── AlertBadge (赤、1件以上で表示)
│   │   └── TrendIndicator (前月比)
│   ├── KpiCard (未打刻総件数)
│   │   ├── MetricLabel
│   │   ├── MetricValue
│   │   ├── AlertBadge (オレンジ、1件以上で表示)
│   │   └── TrendIndicator (前月比)
│   └── KpiCard (全社出勤率)
│       ├── MetricLabel
│       ├── MetricValue
│       └── TrendIndicator (前月比)
├── DepartmentTable
│   ├── TableHeader (ソート可: 部署名, 平均残業, 最大残業, 36協定超過, 未打刻, 出勤率)
│   ├── TableRow
│   │   ├── DepartmentNameCell (部署名)
│   │   ├── NumberCell (所属人数)
│   │   ├── NumberCell (平均残業時間)
│   │   ├── NumberCell (最大残業時間)
│   │   ├── AlertBadgeCell (36協定超過アラート件数)
│   │   ├── AlertBadgeCell (未打刻件数)
│   │   └── PercentCell (出勤率)
│   └── EmptyState ("該当する部門データがありません")
├── Pagination
│   ├── PageNumbers
│   └── PageSizeSelector (20件/ページ)
└── RefreshControl
    └── LastUpdated (最終更新日時)
```

---

## 表示項目

### KPIカード

| 指標 | データソース | 更新頻度 | 閾値 |
|------|------------|---------|------|
| 全社平均残業時間 | avgOvertimeHours（全部門平均） | フィルター変更時 | - |
| 36協定超過アラート総件数 | overtimeAlertCount（全部門合計） | フィルター変更時 | 1件以上で赤バッジ |
| 未打刻総件数 | missingClockCount（全部門合計） | フィルター変更時 | 1件以上でオレンジバッジ |
| 全社出勤率 | attendanceRate（全部門加重平均） | フィルター変更時 | - |

### 部門別テーブルカラム

| カラム | 表示名 | 型 | ソート | 幅 | 備考 |
|--------|--------|-----|--------|------|------|
| departmentName | 部署名 | text | ✅ (デフォルト昇順) | 140px | - |
| headCount | 所属人数 | number | - | 80px | 右寄せ |
| avgOvertimeHours | 平均残業 (h) | number | ✅ | 100px | 小数点1桁、右寄せ |
| maxOvertimeHours | 最大残業 (h) | number | ✅ | 100px | 小数点1桁、右寄せ |
| overtimeAlertCount | 36協定超過アラート | number | ✅ | 130px | 1以上で赤バッジ、右寄せ |
| missingClockCount | 未打刻 | number | ✅ | 80px | 1以上でオレンジバッジ、右寄せ |
| attendanceRate | 出勤率 (%) | number | ✅ | 100px | 小数点1桁、右寄せ |

### アラートバッジ

| 条件 | 表示 | 色 | 背景色 |
|------|------|-----|--------|
| overtimeAlertCount >= 1 | (!) {件数} | red-700 | red-100 |
| missingClockCount >= 1 | (!) {件数} | orange-700 | orange-100 |
| 値が0 | 0（バッジなし） | gray-500 | - |

---

## フィルター条件

| 条件 | フィールド名 | 入力形式 | デフォルト | 備考 |
|------|-------------|---------|-----------|------|
| 部署 | departmentId | セレクト | 管理職: 自部門 / 人事: 全部門 | 権限により選択肢が異なる |
| 対象年月 | month | 月選択 (YYYY-MM) | 当月 | カレンダーピッカー |

### 部署セレクトの権限制御

| 権限 | 挙動 |
|------|------|
| 管理職 | 自部門のみ表示（セレクト非表示、固定） |
| 人事 | 全部門から選択可（「全部門」選択肢あり） |

---

## アクション

### 画面アクション

| アクション | トリガー | 処理 | 権限 |
|-----------|---------|------|------|
| フィルター適用 | 部署/年月変更 | KPI再計算 + テーブル再取得 | read (管理職+人事) |
| ソート変更 | カラムヘッダークリック | ソート条件変更 + テーブル再取得 | read |
| ページ切替 | ページネーション操作 | ページ変更 + テーブル再取得 | read |
| CSV出力 | CSV出力ボタン | 現在のフィルター条件でCSVダウンロード | read (管理職+人事) |

### 行アクション

| アクション | 処理 | 備考 |
|-----------|------|------|
| 行クリック | なし | 将来対応（部署別詳細画面への遷移） |

---

## 状態管理

```typescript
/** ソート方向 */
type SortOrder = 'asc' | 'desc';

/** ソート可能カラム */
type SortableColumn =
  | 'departmentName'
  | 'avgOvertimeHours'
  | 'maxOvertimeHours'
  | 'overtimeAlertCount'
  | 'missingClockCount'
  | 'attendanceRate';

/** KPIメトリクス */
interface KpiMetric {
  label: string;
  value: number;
  unit: string;                     // "h", "件", "%"
  trend: {
    diff: number;                   // 前月比差分
    direction: 'up' | 'down' | 'flat';
    isPositive: boolean;            // 改善方向かどうか
  };
  alert: {
    isActive: boolean;              // アラートバッジ表示有無
    severity: 'error' | 'warning' | null;  // 赤 or オレンジ
  };
}

/** 部門別データアイテム */
interface DepartmentItem {
  departmentId: string;
  departmentName: string;
  headCount: number;
  avgOvertimeHours: number;
  maxOvertimeHours: number;
  overtimeAlertCount: number;
  missingClockCount: number;
  attendanceRate: number;
}

/** フィルターパラメータ */
interface FilterParams {
  departmentId: string | null;      // null = 全部門
  month: string;                    // YYYY-MM 形式、デフォルト: 当月
}

/** ページネーション */
interface PaginationState {
  page: number;                     // 現在ページ (0-based)
  size: number;                     // 1ページあたり件数 (デフォルト: 20)
  sort: SortableColumn;             // ソートカラム (デフォルト: departmentName)
  order: SortOrder;                 // ソート方向 (デフォルト: asc)
}

/** 画面全体の状態 */
interface DepartmentDashboardState {
  /** フィルター条件 */
  filterParams: FilterParams;

  /** ページネーション */
  pagination: PaginationState;

  /** KPIカード */
  kpiCards: {
    metrics: KpiMetric[];           // 4枚分
    isLoading: boolean;
  };

  /** 部門別テーブルデータ */
  tableData: {
    content: DepartmentItem[];
    page: {
      number: number;
      size: number;
      totalElements: number;
      totalPages: number;
    };
    isLoading: boolean;
    error: {
      message: string;
      retryAction: (() => void) | null;
    } | null;
  };

  /** CSV出力 */
  csvExport: {
    isExporting: boolean;
  };

  /** 更新情報 */
  refresh: {
    lastUpdated: Date;
  };
}
```

---

## 派生メトリクス定義

| メトリクス | 算出ロジック |
|-----------|-------------|
| avgOvertimeHours | 部署内全従業員の OvertimeDuration.totalOvertime を集計し平均化 |
| maxOvertimeHours | 部署内全従業員の OvertimeDuration.totalOvertime の最大値 |
| overtimeAlertCount | 36協定上限超過の従業員数をカウント |
| missingClockCount | AttendanceStatus = NOT_CLOCKED かつ勤務日を過ぎたレコード数 |
| attendanceRate | (出勤日数 / 所定出勤日数) x 100 |

---

## API連携

| 操作 | エンドポイント | メソッド | パラメータ |
|------|--------------|---------|-----------|
| ダッシュボード取得 | `/api/v1/attendances/department-dashboard` | GET | departmentId, month, page, size, sort, order |
| CSV出力 | `/api/v1/attendances/department-dashboard/export` | GET | departmentId, month |

### リクエスト例

```
GET /api/v1/attendances/department-dashboard
  ?departmentId=
  &month=2025-01
  &page=0
  &size=20
  &sort=departmentName
  &order=asc
```

### レスポンス例

```json
{
  "kpi": {
    "avgOvertimeHours": 18.5,
    "totalOvertimeAlertCount": 3,
    "totalMissingClockCount": 12,
    "avgAttendanceRate": 96.2,
    "previousMonth": {
      "avgOvertimeHours": 16.4,
      "totalOvertimeAlertCount": 2,
      "totalMissingClockCount": 15,
      "avgAttendanceRate": 95.7
    }
  },
  "content": [
    {
      "departmentId": "DEPT-001",
      "departmentName": "営業部",
      "headCount": 25,
      "avgOvertimeHours": 22.3,
      "maxOvertimeHours": 45.0,
      "overtimeAlertCount": 2,
      "missingClockCount": 5,
      "attendanceRate": 95.0
    }
  ],
  "page": {
    "number": 0,
    "size": 20,
    "totalElements": 5,
    "totalPages": 1
  }
}
```

---

## エラー処理

| エラー | HTTPステータス | 表示方法 | アクション |
|--------|--------------|---------|----------|
| 通信エラー | - | Toast (error) | 再試行ボタン |
| 認証エラー | 401 | リダイレクト | ログイン画面へ |
| 権限エラー | 403 | Toast (error) | 「このダッシュボードを閲覧する権限がありません」 |
| サーバーエラー | 500 | Toast (error) | 再試行ボタン |
| データなし | 200 (空) | EmptyState | 「該当する部門データがありません」 |

---

## レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| Desktop (>1024px) | KPIカード4列横並び、テーブルフル表示 |
| Tablet (768-1024px) | KPIカード2列、テーブルは最大残業カラム非表示 |
| Mobile (<768px) | KPIカード1列、テーブルは横スクロール |

### Tablet 時の非表示カラム

| カラム | 理由 |
|--------|------|
| maxOvertimeHours | 詳細情報。平均残業で傾向は把握可能 |

### Mobile 時の対応

```
┌──────────────────────────────────┐
│ 全社平均残業時間     18.5 h      │
│ 前月比 +2.1h                     │
├──────────────────────────────────┤
│ 36協定超過 (!) 3 件              │
│ 前月比 +1件                      │
├──────────────────────────────────┤
│ 未打刻 (!) 12 件                 │
│ 前月比 -3件                      │
├──────────────────────────────────┤
│ 全社出勤率           96.2 %      │
│ 前月比 +0.5%                     │
└──────────────────────────────────┘

テーブル: 横スクロール対応
```

---

## デザインガイドライン

> aesthetic: `clean-minimal` / colorScheme: `mono-accent`

### カラー＆テーマ

| 項目 | 値 | 備考 |
|------|-----|------|
| ベースカラー | #FFFFFF | ページ背景 |
| サーフェスカラー | #F9FAFB (gray-50) | フィルターバー背景・KPIカード背景 |
| テキスト: Primary | #111827 (gray-900) | 見出し・メトリクス値 |
| テキスト: Secondary | #6B7280 (gray-500) | ラベル・補足・トレンド |
| ボーダー | #E5E7EB (gray-200) | テーブル罫線・カード区切り |
| アクセントカラー | #2563EB (blue-600) | Primary ボタン・ソートアイコン |
| アラート: Error | #DC2626 (red-600) | 36協定超過バッジ・カード左ボーダー |
| アラート: Error 背景 | #FEF2F2 (red-50) | 36協定超過バッジ背景 |
| アラート: Warning | #EA580C (orange-600) | 未打刻バッジ・カード左ボーダー |
| アラート: Warning 背景 | #FFF7ED (orange-50) | 未打刻バッジ背景 |
| トレンド: 改善 | #059669 (green-600) | 前月比（改善方向） |
| トレンド: 悪化 | #DC2626 (red-600) | 前月比（悪化方向） |
| コントラスト比 | WCAG AA 準拠（4.5:1 以上） | テキスト/背景 |

### タイポグラフィ

| 要素 | フォント | サイズ | ウェイト | 備考 |
|------|---------|--------|---------|------|
| ページタイトル | system-ui | 24px | 700 | パンくず下 |
| KPIラベル | system-ui | 12px | 500 | カード内ラベル |
| KPI値 | monospace | 28px | 700 | メトリクス数値 |
| KPI単位 | system-ui | 14px | 400 | h, 件, % |
| トレンド表示 | system-ui | 12px | 400 | 前月比 |
| フィルターラベル | system-ui | 12px | 500 | 部署・対象年月 |
| テーブルヘッダー | system-ui | 12px | 600 | カラム名 |
| テーブルデータ | monospace | 14px | 400 | 数値データ |
| 部署名 | system-ui | 14px | 400 | テーブル内テキスト |
| バッジテキスト | system-ui | 12px | 600 | アラート件数 |
| ボタンラベル | system-ui | 14px | 500 | CSV出力 |

### レイアウト原則

| 項目 | 値 |
|------|-----|
| 基本余白 | 8px グリッド |
| ページ左右パディング | 24px |
| フィルターバー: パディング | 16px |
| フィルターバー: 角丸 | 8px |
| セクション間余白 | 24px |
| KPIカードグリッド | 4列、gap: 16px |
| KPIカード: パディング | 20px |
| KPIカード: 角丸 | 8px |
| KPIカード: 影 | 0 1px 2px rgba(0,0,0,0.05) |
| KPIカード: アラート時左ボーダー | 3px solid (red/orange) |
| テーブル行高 | 48px |
| ボタン角丸 | 6px |
| ボタン高さ | 36px |
| バッジ角丸 | 12px (pill) |
| バッジパディング | 2px 10px |
| 区切り線 | 1px solid #E5E7EB |

### インタラクション

| 状態 | スタイル |
|------|---------|
| KPIカード: ホバー | 背景色 gray-100 + subtle transition |
| テーブル行: ホバー | 背景色 gray-50 |
| ソートヘッダー: ホバー | テキスト色 blue-600 + カーソル pointer |
| ソートヘッダー: アクティブ | ▲/▼ アイコン表示 + テキスト色 blue-600 |
| CSV出力ボタン: ホバー | 背景色 5% 暗く |
| CSV出力ボタン: エクスポート中 | Spinner + disabled |
| フォーカス | 2px outline (blue-600) + 2px offset |
| ローディング | KPIカード: Skeleton (4枚分) / テーブル: Skeleton (5行分) |
| 画面遷移 | 即時（アニメーションなし） |
| フィードバック | Toast 通知（右上、3秒自動消去） |
| ページネーション: ホバー | 背景色 gray-100 |
| ページネーション: 現在ページ | 背景色 blue-600 + テキスト白 |
| フィルター変更 | 即時反映（debounce 300ms） |

### アンチパターン（避けるべき表現）

- グラデーション背景の多用
- 装飾的なドロップシャドウの重ね掛け
- 無意味なアニメーション・トランジション
- ジェネリックなAI生成風のイラスト
- 過度な角丸（pill 形状の乱用）
- テーブルのゼブラストライプ（clean-minimalでは罫線のみ）
- KPIカードへの過度な装飾（アイコン多用、グラデーション背景）
- アラートバッジの点滅アニメーション

---

## 品質チェック結果

- [x] 全クエリに対応する表示要素がある（KPI 4枚 + 7カラムの DataTable + 2条件のフィルター + ページネーション）
- [x] 全コマンドに対応する操作UIがある（CSV出力ボタン、フィルター操作、ソート切替、ページ切替）
- [x] エラー状態の表示が定義されている（Toast通知 + 再試行ボタン、権限エラー対応、EmptyState）
- [x] 状態遷移がUI上で表現されている（アラートバッジ赤/オレンジで異常値強調、トレンド表示で前月比可視化）

<!-- メトリクスサマリー（/estimate 自動集計用）
画面種別: ダッシュボード
コンポーネント数: 22
DataTable: 1
SearchForm: 0
フォーム数: 0
チャート数: 0
-->
