# 勤怠打刻

## 概要

| 項目 | 内容 |
|------|------|
| 画面ID | SCR-ATT-001 |
| 画面種別 | モーダル |
| 関連集約 | 勤怠記録（勤怠管理コンテキスト） |
| URL | - （モーダル。親画面から呼出） |

---

## ワイヤーフレーム

```
         ┌──────────────────────────────────────────┐
         │  勤怠打刻                           [×]  │
         ├──────────────────────────────────────────┤
         │                                          │
         │          ● CLOCKED_IN（出勤中）          │
         │                                          │
         │              09:47:23                     │
         │            2025-01-15 (水)                │
         │                                          │
         ├──────────────────────────────────────────┤
         │                                          │
         │   ┌──────────────────────────────────┐   │
         │   │  [  出勤  ]     [  退勤  ]       │   │
         │   │  (disabled)     (enabled)        │   │
         │   │                                  │   │
         │   │  [休憩開始]     [休憩終了]       │   │
         │   │  (enabled)      (disabled)       │   │
         │   └──────────────────────────────────┘   │
         │                                          │
         ├──────────────────────────────────────────┤
         │  本日の実績                              │
         │  ┌──────────────────────────────────┐   │
         │  │ 出勤時刻    09:02               │   │
         │  │ 休憩時間    --:--               │   │
         │  │ 勤務時間    00:45 (経過)        │   │
         │  └──────────────────────────────────┘   │
         │                                          │
         └──────────────────────────────────────────┘
```

### 状態別バリエーション

**NOT_CLOCKED（未出勤）:**
```
         ┌──────────────────────────────────────────┐
         │  勤怠打刻                           [×]  │
         ├──────────────────────────────────────────┤
         │          ○ NOT_CLOCKED（未出勤）         │
         │              09:47:23                     │
         │            2025-01-15 (水)                │
         ├──────────────────────────────────────────┤
         │   ┌──────────────────────────────────┐   │
         │   │  [■ 出勤 ■]     [  退勤  ]      │   │
         │   │  (PRIMARY)      (disabled)       │   │
         │   │                                  │   │
         │   │  [休憩開始]     [休憩終了]       │   │
         │   │  (disabled)     (disabled)       │   │
         │   └──────────────────────────────────┘   │
         ├──────────────────────────────────────────┤
         │  本日の実績                              │
         │  ┌──────────────────────────────────┐   │
         │  │ 出勤時刻    --:--               │   │
         │  │ 休憩時間    --:--               │   │
         │  │ 勤務時間    --:--               │   │
         │  └──────────────────────────────────┘   │
         └──────────────────────────────────────────┘
```

**CLOCKED_IN + ON_BREAK（休憩中）:**
```
         ┌──────────────────────────────────────────┐
         │  勤怠打刻                           [×]  │
         ├──────────────────────────────────────────┤
         │          ◐ ON_BREAK（休憩中）            │
         │              12:15:03                     │
         │            2025-01-15 (水)                │
         ├──────────────────────────────────────────┤
         │   ┌──────────────────────────────────┐   │
         │   │  [  出勤  ]     [  退勤  ]       │   │
         │   │  (disabled)     (disabled)       │   │
         │   │                                  │   │
         │   │  [休憩開始]     [■休憩終了■]     │   │
         │   │  (disabled)     (PRIMARY)        │   │
         │   └──────────────────────────────────┘   │
         ├──────────────────────────────────────────┤
         │  本日の実績                              │
         │  ┌──────────────────────────────────┐   │
         │  │ 出勤時刻    09:02               │   │
         │  │ 休憩時間    00:15 (経過)        │   │
         │  │ 勤務時間    03:13               │   │
         │  └──────────────────────────────────┘   │
         └──────────────────────────────────────────┘
```

**CLOCKED_OUT / FINALIZED（退勤済・確定済）:**
```
         ┌──────────────────────────────────────────┐
         │  勤怠打刻                           [×]  │
         ├──────────────────────────────────────────┤
         │          ◉ CLOCKED_OUT（退勤済）         │
         │              18:05:30                     │
         │            2025-01-15 (水)                │
         ├──────────────────────────────────────────┤
         │   ┌──────────────────────────────────┐   │
         │   │  [  出勤  ]     [  退勤  ]       │   │
         │   │  (disabled)     (disabled)       │   │
         │   │                                  │   │
         │   │  [休憩開始]     [休憩終了]       │   │
         │   │  (disabled)     (disabled)       │   │
         │   └──────────────────────────────────┘   │
         ├──────────────────────────────────────────┤
         │  本日の実績                              │
         │  ┌──────────────────────────────────┐   │
         │  │ 出勤時刻    09:02               │   │
         │  │ 退勤時刻    18:03               │   │
         │  │ 休憩時間    01:00               │   │
         │  │ 勤務時間    07:58 (実働)        │   │
         │  └──────────────────────────────────┘   │
         └──────────────────────────────────────────┘
```

---

## コンポーネント構成

```
ClockInModal
├── ModalHeader
│   ├── Title ("勤怠打刻")
│   └── CloseButton
├── StatusSection
│   ├── StatusBadge (現在のステータス)
│   ├── CurrentTime (リアルタイム時計表示)
│   └── CurrentDate (日付・曜日)
├── ActionSection
│   └── ButtonGrid (2×2)
│       ├── ClockInButton (出勤打刻)
│       ├── ClockOutButton (退勤打刻)
│       ├── BreakStartButton (休憩開始)
│       └── BreakEndButton (休憩終了)
├── DailySummary
│   ├── SummaryLabel ("本日の実績")
│   └── SummaryTable
│       ├── ClockInTime (出勤時刻)
│       ├── ClockOutTime (退勤時刻 ※退勤後のみ)
│       ├── BreakDuration (休憩時間)
│       └── WorkDuration (勤務時間)
└── ToastNotification (打刻結果通知)
```

---

## 表示項目

### ステータスバッジ

| 値 | 表示 | 色 | アイコン |
|----|------|-----|---------|
| NOT_CLOCKED | 未出勤 | gray-500 | ○ |
| CLOCKED_IN | 出勤中 | green-600 | ● |
| ON_BREAK | 休憩中 | amber-500 | ◐ |
| CLOCKED_OUT | 退勤済 | blue-600 | ◉ |
| FINALIZED | 確定済 | slate-400 | ◉ |

### 当日実績サマリー

| 項目 | 表示条件 | フォーマット | 備考 |
|------|---------|-------------|------|
| 出勤時刻 | CLOCKED_IN以降 | HH:mm | 未出勤時は `--:--` |
| 退勤時刻 | CLOCKED_OUT以降 | HH:mm | 退勤前は非表示 |
| 休憩時間 | 休憩実績あり | HH:mm | 休憩中は `(経過)` 付き |
| 勤務時間 | CLOCKED_IN以降 | HH:mm | 勤務中は `(経過)` 付き、退勤後は `(実働)` 付き |

---

## アクション

### ボタンアクション

| アクション | エンドポイント | メソッド | パラメータ | 備考 |
|-----------|--------------|---------|-----------|------|
| 出勤打刻 | `/api/v1/attendances/clock-in` | POST | employeeId, clockTime, source | clockTime: 現在時刻±5分 |
| 退勤打刻 | `/api/v1/attendances/clock-out` | POST | employeeId, clockTime, source | clockTime: 出勤時刻より後 |
| 休憩開始 | `/api/v1/attendances/break-start` | POST | employeeId, clockTime, source | clockTime: 出勤時刻より後 |
| 休憩終了 | `/api/v1/attendances/break-end` | POST | employeeId, clockTime, source | clockTime: 休憩開始より後 |

### パラメータ取得方法

| パラメータ | 取得方法 | ユーザー入力 |
|-----------|---------|-------------|
| employeeId | JWT トークンから抽出 | 不要 |
| clockTime | クライアント現在時刻を自動設定 | 不要（表示のみ） |
| source | クライアント種別を自動判定（WEB / MOBILE） | 不要 |

### 状態別ボタン有効/無効マトリクス

| ステータス | 出勤 | 退勤 | 休憩開始 | 休憩終了 |
|-----------|------|------|---------|---------|
| NOT_CLOCKED | **有効 (Primary)** | 無効 | 無効 | 無効 |
| CLOCKED_IN | 無効 | 有効 | 有効 | 無効 |
| CLOCKED_IN (休憩中) | 無効 | 無効 | 無効 | **有効 (Primary)** |
| CLOCKED_OUT | 無効 | 無効 | 無効 | 無効 |
| FINALIZED | 無効 | 無効 | 無効 | 無効 |

> Primary: アクセントカラーで強調表示。
> その状態で最も期待される操作を示す。

---

## 状態管理

```typescript
/** 勤怠ステータス */
type AttendanceStatus =
  | 'NOT_CLOCKED'
  | 'CLOCKED_IN'
  | 'ON_BREAK'
  | 'CLOCKED_OUT'
  | 'FINALIZED';

/** 打刻ソース */
type ClockSource = 'WEB' | 'MOBILE';

/** 当日実績 */
interface DailySummary {
  clockInTime: string | null;   // ISO 8601
  clockOutTime: string | null;  // ISO 8601
  breakDuration: number | null; // 分
  workDuration: number | null;  // 分
  isOnBreak: boolean;
}

/** モーダル状態 */
interface ClockInModalState {
  /** モーダル表示状態 */
  isOpen: boolean;

  /** 現在の勤怠ステータス */
  status: AttendanceStatus;

  /** 現在時刻（1秒ごと更新） */
  currentTime: Date;

  /** 当日の実績サマリー */
  dailySummary: DailySummary;

  /** 打刻処理中フラグ（二重送信防止） */
  isSubmitting: boolean;

  /** エラー情報 */
  error: {
    message: string;
    retryAction: (() => void) | null;
  } | null;
}
```

### 状態遷移図

```
  NOT_CLOCKED ──[出勤打刻]──→ CLOCKED_IN
                                  │
                     ┌────────────┴────────────┐
                     │                         │
              [休憩開始]                  [退勤打刻]
                     │                         │
                     ▼                         ▼
                  ON_BREAK              CLOCKED_OUT
                     │                         │
              [休憩終了]                  (管理者確定)
                     │                         │
                     ▼                         ▼
                CLOCKED_IN                FINALIZED
```

---

## API連携

| 操作 | エンドポイント | メソッド | レスポンス |
|------|--------------|---------|-----------|
| 当日ステータス取得 | `/api/v1/attendances/today` | GET | status, dailySummary |
| 出勤打刻 | `/api/v1/attendances/clock-in` | POST | 更新後の status, dailySummary |
| 退勤打刻 | `/api/v1/attendances/clock-out` | POST | 更新後の status, dailySummary |
| 休憩開始 | `/api/v1/attendances/break-start` | POST | 更新後の status, dailySummary |
| 休憩終了 | `/api/v1/attendances/break-end` | POST | 更新後の status, dailySummary |

---

## エラー処理

| エラー | 表示方法 | アクション |
|--------|---------|----------|
| 通信エラー | Toast (error) | 再試行ボタン |
| 認証エラー (401) | Toast (error) + モーダル閉じ | ログイン画面へリダイレクト |
| バリデーションエラー (422) | Toast (warning) | メッセージ表示（例: 出勤時刻の範囲外） |
| 競合エラー (409) | Toast (warning) | ステータス再取得 + メッセージ表示 |
| サーバーエラー (500) | Toast (error) | 再試行ボタン |

---

## レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| Desktop (>768px) | 幅 450px モーダル（中央配置） |
| Mobile (<768px) | フルスクリーンモーダル（下からスライドアップ） |

---

## デザインガイドライン

### カラー＆テーマ

> aesthetic: `clean-minimal` / colorScheme: `mono-accent`

| 項目 | 値 | 備考 |
|------|-----|------|
| ベースカラー | #FFFFFF | モーダル背景 |
| サーフェスカラー | #F9FAFB (gray-50) | 実績サマリー背景 |
| テキスト: Primary | #111827 (gray-900) | 見出し・時刻 |
| テキスト: Secondary | #6B7280 (gray-500) | ラベル・補足 |
| ボーダー | #E5E7EB (gray-200) | セクション区切り |
| アクセントカラー | #2563EB (blue-600) | Primary ボタン |
| セマンティック: Success | #059669 (emerald-600) | 打刻成功 Toast |
| セマンティック: Warning | #D97706 (amber-600) | バリデーション警告 |
| セマンティック: Error | #DC2626 (red-600) | エラー Toast |
| オーバーレイ | rgba(0, 0, 0, 0.5) | モーダル背景 |
| コントラスト比 | WCAG AA 準拠（4.5:1 以上） | テキスト/背景 |

### タイポグラフィ

| 要素 | フォント | サイズ | ウェイト | 備考 |
|------|---------|--------|---------|------|
| モーダルタイトル | system-ui | 18px | 600 | ヘッダー |
| 現在時刻 | monospace | 36px | 700 | 最も目立つ要素 |
| 日付 | system-ui | 14px | 400 | 時刻の下 |
| ステータス | system-ui | 14px | 600 | バッジ内テキスト |
| ボタンラベル | system-ui | 14px | 500 | 全ボタン共通 |
| サマリーラベル | system-ui | 12px | 500 | 「出勤時刻」等 |
| サマリー値 | monospace | 14px | 600 | 時刻表示 |

### レイアウト原則

| 項目 | 値 |
|------|-----|
| モーダル幅 | 450px（Desktop） / 100vw（Mobile） |
| モーダル角丸 | 12px（Desktop） / 0（Mobile） |
| 内部パディング | 24px |
| セクション間余白 | 16px |
| ボタングリッド | 2×2、gap: 12px |
| ボタンサイズ | 高さ 48px（タッチ対応） |
| ボタン角丸 | 8px |
| カード影 | 0 4px 24px rgba(0, 0, 0, 0.15) |
| 区切り線 | 1px solid #E5E7EB |

### インタラクション

| 状態 | スタイル |
|------|---------|
| ボタン: ホバー | 背景色 5% 暗く |
| ボタン: disabled | opacity: 0.4, cursor: not-allowed |
| ボタン: 押下中 | isSubmitting=true の間スピナー表示、全ボタン disabled |
| フォーカス | 2px outline (blue-600) + 2px offset |
| モーダル開閉 | フェードイン/アウト 150ms |
| 時刻更新 | 1秒ごと（setInterval）、コンポーネント破棄時にクリア |
| 打刻成功 | Toast (success)、3秒自動消去 + ステータス即時更新 |
| 打刻失敗 | Toast (error)、手動消去 + 再試行ボタン |

### アンチパターン（避けるべき表現）

- グラデーション背景の多用
- 装飾的なドロップシャドウの重ね掛け
- 無意味なアニメーション・トランジション
- ジェネリックなAI生成風のイラスト
- 過度な角丸（pill 形状の乱用）
- ボタンにアイコンを詰め込みすぎる（テキストラベルで十分）

---

## 品質チェック結果

- [x] 全クエリに対応する表示要素がある（ステータス表示、当日実績サマリー、現在時刻）
- [x] 全コマンドに対応する操作UIがある（出勤/退勤/休憩開始/休憩終了の4ボタン）
- [x] エラー状態の表示が定義されている（Toast通知 + 再試行ボタン）
- [x] 状態遷移がUI上で表現されている（ステータスバッジ + ボタン有効/無効マトリクス）

<!-- メトリクスサマリー（/estimate 自動集計用）
画面種別: モーダル
コンポーネント数: 14
DataTable: 0
SearchForm: 0
フォーム数: 0
チャート数: 0
-->
