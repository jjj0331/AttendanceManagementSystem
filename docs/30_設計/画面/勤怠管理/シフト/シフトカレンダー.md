# シフトカレンダー

## 概要

| 項目 | 内容 |
|------|------|
| 画面ID | SCR-SHF-003 |
| 画面種別 | 一覧 |
| 関連集約 | シフト（勤怠管理コンテキスト） |
| URL | `/shifts/schedules` |

---

## ワイヤーフレーム

```
┌───────────────────────────────────────────────────────────────────────────────────────┐
│ {システム名}                                                              [user ▼]   │
├───────────────────────────────────────────────────────────────────────────────────────┤
│ パンくず: ホーム > 勤怠管理 > シフトカレンダー                                        │
├───────────────────────────────────────────────────────────────────────────────────────┤
│ ┌───────────────────────────────────────────────────────────────────────────────────┐ │
│ │ 検索条件                                                                         │ │
│ │                                                                                 │ │
│ │ 従業員    [全員                  ▼]                                               │ │
│ │ 期間      [2024/04/01] ～ [2024/04/28]     ステータス [全て ▼]                    │ │
│ │                                                                                 │ │
│ │                                                  [クリア]  [■ 検索 ■]           │ │
│ └───────────────────────────────────────────────────────────────────────────────────┘ │
├───────────────────────────────────────────────────────────────────────────────────────┤
│ 件数: 16件                              [一括公開]          [■ + シフト割当 ■]       │
├───────────────────────────────────────────────────────────────────────────────────────┤
│ ┌──┬────────┬────────┬──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────────┐   │
│ │□ │従業員名▼│ 週開始▼│  月  │  火  │  水  │  木  │  金  │  土  │  日  │ステータス│   │
│ ├──┼────────┼────────┼──────┼──────┼──────┼──────┼──────┼──────┼──────┼──────────┤   │
│ │□ │山田太郎│04/01   │ 早番 │ 早番 │ 早番 │ 遅番 │ 遅番 │  -   │  -   │[公開済]  │   │
│ │□ │山田太郎│04/08   │ 日勤 │ 日勤 │ 夜勤 │  -   │ 日勤 │  -   │  -   │[下書き]  │   │
│ │□ │鈴木花子│04/01   │ 遅番 │ 遅番 │ 遅番 │ 早番 │ 早番 │  -   │  -   │[公開済]  │   │
│ │□ │鈴木花子│04/08   │ 夜勤 │  -   │ 早番 │ 早番 │ 早番 │  -   │  -   │[下書き]  │   │
│ └──┴────────┴────────┴──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────────┘   │
├───────────────────────────────────────────────────────────────────────────────────────┤
│ < 1 2 3 4 >                                                    20件/ページ ▼       │
└───────────────────────────────────────────────────────────────────────────────────────┘
```

### 行クリック時 → シフト割当モーダル（編集）

```
                       ┌──────────────────────────┐
 [行クリック] ────────→ │ シフト割当モーダル（編集） │
                       │ （SCR-SHF-004）           │
                       └──────────────────────────┘
```

### 「+ シフト割当」ボタン押下時 → シフト割当モーダル（新規）

```
                       ┌──────────────────────────┐
 [■ + シフト割当 ■] ──→ │ シフト割当モーダル（新規） │
                       │ （SCR-SHF-004）           │
                       └──────────────────────────┘
```

---

## コンポーネント構成

```
ShiftCalendarPage
├── Breadcrumb
│   └── BreadcrumbItem ("ホーム", "勤怠管理", "シフトカレンダー")
├── SearchForm (上部固定)
│   ├── EmployeeSelect (従業員)
│   ├── DateRangePicker (期間: weekFrom〜weekTo)
│   ├── StatusSelect (ステータス: DRAFT/PUBLISHED/全て)
│   └── ButtonGroup
│       ├── ClearButton (クリア)
│       └── SearchButton (検索)
├── ActionBar
│   ├── ResultCount (検索結果件数)
│   ├── BulkPublishButton ("一括公開"、選択時のみ有効)
│   └── AssignButton ("+ シフト割当" → モーダル起動)
├── DataTable
│   ├── TableHeader (ソート可: 従業員名, 週開始)
│   ├── TableRow (クリックで編集モーダル起動)
│   │   ├── Checkbox (一括選択用)
│   │   ├── EmployeeNameCell (従業員名)
│   │   ├── WeekStartCell (週開始日)
│   │   ├── DayPatternCell ×7 (月〜日のパターン名)
│   │   └── StatusBadge (DRAFT/PUBLISHED)
│   └── EmptyState ("シフトスケジュールがありません")
├── Pagination
│   ├── PageNumbers
│   └── PageSizeSelector (20件/ページ)
├── ShiftAssignModal (SCR-SHF-004、条件付き表示)
├── BulkPublishConfirmDialog (一括公開確認)
└── PublishConfirmDialog (個別公開確認)
```

---

## 表示項目

### 一覧カラム

| カラム | 表示名 | 型 | ソート | 幅 | 備考 |
|--------|--------|-----|--------|------|------|
| checkbox | - | checkbox | - | 40px | 一括選択用（DRAFTのみ選択可） |
| employeeName | 従業員名 | text | ✅ | 120px | - |
| weekStartDate | 週開始 | date | ✅ (デフォルト昇順) | 80px | MM/DD 形式 |
| monday | 月 | text | - | 60px | パターン名 or `-` |
| tuesday | 火 | text | - | 60px | パターン名 or `-` |
| wednesday | 水 | text | - | 60px | パターン名 or `-` |
| thursday | 木 | text | - | 60px | パターン名 or `-` |
| friday | 金 | text | - | 60px | パターン名 or `-` |
| saturday | 土 | text | - | 60px | パターン名 or `-` |
| sunday | 日 | text | - | 60px | パターン名 or `-` |
| status | ステータス | badge | - | 80px | 色分けバッジ |

### ステータスバッジ

| 値 | 表示 | 色 | 背景色 |
|----|------|-----|--------|
| DRAFT | 下書き | amber-700 | amber-100 |
| PUBLISHED | 公開済 | green-700 | green-100 |

### 曜日パターンセルの表示

| 状態 | 表示 | 色 |
|------|------|----|
| パターン割当あり | パターン名（例: 早番） | gray-900 |
| 割当なし | - | gray-300 |
| 夜勤パターン | パターン名 + 夜勤アイコン | indigo-700 |

---

## 検索条件

| 条件 | フィールド名 | 入力形式 | 演算子 | デフォルト | 備考 |
|------|-------------|---------|--------|-----------|------|
| 従業員 | employeeId | セレクト (EmployeeId) | = | 全員（管理職）/ 本人 | 管理職は部下全員を表示 |
| 期間（開始） | weekFrom | 日付 (date) | >= | 今週の月曜日 | 月曜日のみ選択可 |
| 期間（終了） | weekTo | 日付 (date) | <= | 4週先の月曜日 | 月曜日のみ選択可 |
| ステータス | status | セレクト (ScheduleStatus) | = | 全て | DRAFT/PUBLISHED/全て |

### 従業員セレクトの権限制御

| 権限 | 挙動 |
|------|------|
| 本人 | 自分のみ表示（セレクト非表示、固定） |
| 管理職 | 配下従業員の一覧から選択可（+ 全員） |

---

## アクション

### 画面アクション

| アクション | トリガー | 処理 | 権限 |
|-----------|---------|------|------|
| 検索 | 検索ボタン | 検索条件で一覧再取得 | read (管理職+本人) |
| クリア | クリアボタン | 検索条件をデフォルトに戻す | read |
| シフト割当 | + シフト割当ボタン | シフト割当モーダル (SCR-SHF-004) を新規モードで開く | write (管理職のみ) |
| 一括公開 | 一括公開ボタン | 選択中のDRAFTスケジュールを一括公開 | write (管理職のみ) |
| ソート変更 | カラムヘッダークリック | ソート条件変更 + 一覧再取得 | read |
| ページ切替 | ページネーション操作 | ページ変更 + 一覧再取得 | read |

### 行アクション

| アクション | 処理 | 権限 | 備考 |
|-----------|------|------|------|
| 行クリック | シフト割当モーダル (SCR-SHF-004) を編集モードで開く | write (管理職のみ) | 従業員本人は閲覧のみ |

### 一括公開の動作

1. チェックボックスで DRAFT スケジュールを選択（PUBLISHEDは選択不可）
2. 「一括公開」ボタンをクリック
3. 確認ダイアログ:「選択した {N} 件のスケジュールを公開しますか？公開すると対象従業員に通知されます。」
4. 確定: 選択されたスケジュールに対して順次 POST /actions/publish を実行
5. 成功: Toast (success)「{N} 件のスケジュールを公開しました」 + 一覧再取得
6. 一部失敗: Toast (warning)「{成功数}/{全数} 件を公開しました。{失敗数} 件は公開できませんでした。」

---

## 状態管理

```typescript
/** スケジュールステータス */
type ScheduleStatus = 'DRAFT' | 'PUBLISHED';

/** 曜日別パターン割当 */
interface DayAssignment {
  patternId: string;
  patternName: string;
  startTime: string;    // HH:mm
  endTime: string;      // HH:mm
}

/** カレンダー一覧アイテム */
interface ScheduleItem {
  scheduleId: string;
  employeeId: string;
  employeeName: string;
  weekStartDate: string;    // ISO 8601 date
  status: ScheduleStatus;
  assignments: {
    MONDAY: DayAssignment | null;
    TUESDAY: DayAssignment | null;
    WEDNESDAY: DayAssignment | null;
    THURSDAY: DayAssignment | null;
    FRIDAY: DayAssignment | null;
    SATURDAY: DayAssignment | null;
    SUNDAY: DayAssignment | null;
  };
}

/** 検索パラメータ */
interface SearchParams {
  employeeId: string | null;    // null = 全員
  weekFrom: string;             // ISO 8601 date (月曜日)
  weekTo: string;               // ISO 8601 date (月曜日)
  status: ScheduleStatus | null; // null = 全て
}

/** ページネーション */
interface PaginationState {
  page: number;
  size: number;
  sort: string;
  order: 'asc' | 'desc';
}

/** 画面全体の状態 */
interface ShiftCalendarState {
  /** 検索条件 */
  searchParams: SearchParams;

  /** ページネーション */
  pagination: PaginationState;

  /** 選択状態 */
  selection: {
    selectedIds: string[];
    isAllSelected: boolean;
  };

  /** データ */
  data: {
    content: ScheduleItem[];
    page: {
      number: number;
      size: number;
      totalElements: number;
      totalPages: number;
    };
    isLoading: boolean;
    error: {
      message: string;
      retryAction: (() => void) | null;
    } | null;
  };

  /** 割当モーダル */
  assignModal: {
    isOpen: boolean;
    mode: 'create' | 'edit';
    editTarget: ScheduleItem | null;
  };

  /** 一括公開 */
  bulkPublish: {
    isSubmitting: boolean;
  };
}
```

---

## API連携

| 操作 | エンドポイント | メソッド | パラメータ |
|------|--------------|---------|-----------:|
| カレンダー取得 | `/api/v1/shifts/schedules` | GET | employeeId, weekFrom, weekTo, status, page, size, sort |
| スケジュール詳細 | `/api/v1/shifts/schedules/{scheduleId}` | GET | - |
| スケジュール公開 | `/api/v1/shifts/schedules/{scheduleId}/actions/publish` | POST | - |

### リクエスト例（カレンダー取得）

```
GET /api/v1/shifts/schedules
  ?employeeId=
  &weekFrom=2024-04-01
  &weekTo=2024-04-22
  &status=
  &page=0
  &size=20
  &sort=weekStartDate,asc
```

---

## エラー処理

| エラー | HTTPステータス | 表示方法 | アクション |
|--------|--------------|---------|----------|
| 通信エラー | - | Toast (error) | 再試行ボタン |
| 認証エラー | 401 | リダイレクト | ログイン画面へ |
| 権限エラー | 403 | Toast (error) | 「他の従業員のシフトを閲覧する権限がありません」 |
| 競合エラー（公開時） | 409 | Toast (warning) | 「既に公開済みです」+ 一覧再取得 |
| 事前条件エラー（公開時） | 422 | Toast (warning) | 「割当済みの日が0日のため公開できません」 |
| サーバーエラー | 500 | Toast (error) | 再試行ボタン |

---

## レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| Desktop (>1024px) | フル表示（全12カラム） |
| Tablet (768-1024px) | 土日カラム非表示（10カラム） |
| Mobile (<768px) | カード形式に切り替え |

### Mobile カード形式

```
┌──────────────────────────────────┐
│ □ 山田太郎    04/01週   [公開済] │
│ 月:早番  火:早番  水:早番        │
│ 木:遅番  金:遅番                 │
├──────────────────────────────────┤
│ □ 山田太郎    04/08週   [下書き] │
│ 月:日勤  火:日勤  水:夜勤        │
│ 木: -    金:日勤                 │
└──────────────────────────────────┘
```

---

## デザインガイドライン

> aesthetic: `clean-minimal` / colorScheme: `mono-accent`

### カラー＆テーマ

| 項目 | 値 | 備考 |
|------|-----|------|
| ベースカラー | #FFFFFF | ページ背景 |
| サーフェスカラー | #F9FAFB (gray-50) | 検索フォーム背景 |
| テキスト: Primary | #111827 (gray-900) | 見出し・データ値 |
| テキスト: Secondary | #6B7280 (gray-500) | ラベル・補足 |
| テキスト: Placeholder | #D1D5DB (gray-300) | 未割当「-」表示 |
| ボーダー | #E5E7EB (gray-200) | テーブル罫線・区切り |
| アクセントカラー | #2563EB (blue-600) | Primary ボタン・ソートアイコン |
| バッジ: 下書き | amber-100 / amber-700 | DRAFT |
| バッジ: 公開済 | green-100 / green-700 | PUBLISHED |
| 夜勤パターン | indigo-100 / indigo-700 | isOvernight=true のパターン |
| コントラスト比 | WCAG AA 準拠（4.5:1 以上） | テキスト/背景 |

### タイポグラフィ

| 要素 | フォント | サイズ | ウェイト | 備考 |
|------|---------|--------|---------|------|
| ページタイトル | system-ui | 24px | 700 | パンくず下 |
| 検索ラベル | system-ui | 12px | 500 | 検索条件ラベル |
| テーブルヘッダー | system-ui | 12px | 600 | カラム名 |
| テーブルデータ | system-ui | 14px | 400 | セルデータ |
| パターン名（曜日セル） | system-ui | 13px | 400 | コンパクト表示 |
| 日付表示 | monospace | 14px | 400 | MM/DD 形式を等幅で |
| バッジテキスト | system-ui | 12px | 500 | ステータス文字列 |
| 件数表示 | system-ui | 14px | 400 | 「16件」 |
| ボタンラベル | system-ui | 14px | 500 | 検索・シフト割当 |

### レイアウト原則

| 項目 | 値 |
|------|-----|
| 基本余白 | 8px グリッド |
| ページ左右パディング | 24px |
| 検索フォーム: パディング | 16px |
| 検索フォーム: 角丸 | 8px |
| セクション間余白 | 16px |
| テーブル行高 | 48px |
| 曜日セル最小幅 | 60px |
| ボタン角丸 | 6px |
| ボタン高さ | 36px |
| バッジ角丸 | 12px (pill) |
| バッジパディング | 2px 10px |
| カード影 | なし（clean-minimal） |
| 区切り線 | 1px solid #E5E7EB |

### インタラクション

| 状態 | スタイル |
|------|---------:|
| テーブル行: ホバー | 背景色 gray-50 + カーソル pointer（管理職のみ） |
| ソートヘッダー: ホバー | テキスト色 blue-600 + カーソル pointer |
| ソートヘッダー: アクティブ | ▲/▼ アイコン表示 + テキスト色 blue-600 |
| チェックボックス | DRAFTのみ有効、PUBLISHEDはdisabled |
| ボタン: ホバー | 背景色 5% 暗く |
| ボタン: disabled | opacity: 0.4 |
| 一括公開ボタン | 選択数 > 0 のとき有効、それ以外 disabled |
| フォーカス | 2px outline (blue-600) + 2px offset |
| ローディング | テーブル部分に Skeleton UI（5行分） |
| 画面遷移 | 即時（アニメーションなし） |
| フィードバック | Toast 通知（右上、3秒自動消去） |
| ページネーション: ホバー | 背景色 gray-100 |
| ページネーション: 現在ページ | 背景色 blue-600 + テキスト白 |

### アンチパターン（避けるべき表現）

- グラデーション背景の多用
- 装飾的なドロップシャドウの重ね掛け
- 無意味なアニメーション・トランジション
- ジェネリックなAI生成風のイラスト
- 過度な角丸（pill 形状の乱用）
- テーブルのゼブラストライプ（clean-minimalでは罫線のみ）
- 曜日セルに色を付けすぎる（パターン名テキストで十分）

---

## 品質チェック結果

- [x] 全クエリに対応する表示要素がある（12カラムのDataTable、4条件の検索フォーム、ページネーション）
- [x] 全コマンドに対応する操作UIがある（シフト割当ボタン→モーダル、一括公開ボタン、行クリック→編集モーダル）
- [x] エラー状態の表示が定義されている（Toast通知、権限/競合/事前条件エラー対応）
- [x] 状態遷移がUI上で表現されている（DRAFT/PUBLISHEDバッジ、DRAFTのみ選択可のチェックボックス）

<!-- メトリクスサマリー（/estimate 自動集計用）
画面種別: 一覧
コンポーネント数: 20
DataTable: 1
SearchForm: 1
フォーム数: 0
チャート数: 0
-->
