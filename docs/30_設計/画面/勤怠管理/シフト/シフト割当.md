# シフト割当

## 概要

| 項目 | 内容 |
|------|------|
| 画面ID | SCR-SHF-004 |
| 画面種別 | モーダル |
| 関連集約 | シフト（勤怠管理コンテキスト） |
| URL | - （モーダル。シフトカレンダーから呼出） |

---

## ワイヤーフレーム

### 新規割当モード

```
         ┌────────────────────────────────────────────────────┐
         │  シフト割当                                  [×]  │
         ├────────────────────────────────────────────────────┤
         │                                                    │
         │  従業員 *                                          │
         │  ┌────────────────────────────────────────────┐   │
         │  │ 従業員を選択                           ▼   │   │
         │  └────────────────────────────────────────────┘   │
         │                                                    │
         │  週開始日（月曜日）*                                │
         │  ┌────────────────────────────────────────────┐   │
         │  │ 2024/04/01                                 │   │
         │  └────────────────────────────────────────────┘   │
         │                                                    │
         │  シフト割当                                        │
         │  ┌──────┬───────────────────────────────────┐     │
         │  │  月  │ [早番                         ▼]  │     │
         │  ├──────┼───────────────────────────────────┤     │
         │  │  火  │ [早番                         ▼]  │     │
         │  ├──────┼───────────────────────────────────┤     │
         │  │  水  │ [早番                         ▼]  │     │
         │  ├──────┼───────────────────────────────────┤     │
         │  │  木  │ [遅番                         ▼]  │     │
         │  ├──────┼───────────────────────────────────┤     │
         │  │  金  │ [遅番                         ▼]  │     │
         │  ├──────┼───────────────────────────────────┤     │
         │  │  土  │ [-- 休み --                   ▼]  │     │
         │  ├──────┼───────────────────────────────────┤     │
         │  │  日  │ [-- 休み --                   ▼]  │     │
         │  └──────┴───────────────────────────────────┘     │
         │                                                    │
         ├────────────────────────────────────────────────────┤
         │                     [キャンセル] [■ 割当 ■]       │
         └────────────────────────────────────────────────────┘
```

### 編集モード

```
         ┌────────────────────────────────────────────────────┐
         │  シフト変更                                  [×]  │
         ├────────────────────────────────────────────────────┤
         │                                                    │
         │  従業員                                            │
         │    山田太郎                         (変更不可)     │
         │                                                    │
         │  週開始日                                          │
         │    2024/04/01                       (変更不可)     │
         │                                                    │
         │  ステータス                                        │
         │    [公開済]                                        │
         │    ⚠ 変更すると下書きに戻ります                    │
         │                                                    │
         │  シフト割当                                        │
         │  ┌──────┬───────────────────────────────────┐     │
         │  │  月  │ [早番                         ▼]  │     │
         │  ├──────┼───────────────────────────────────┤     │
         │  │  火  │ [夜勤                         ▼]  │     │
         │  │  ...                                       │     │
         │  └──────┴───────────────────────────────────┘     │
         │                                                    │
         ├────────────────────────────────────────────────────┤
         │          [キャンセル] [公開する] [■ 変更 ■]       │
         └────────────────────────────────────────────────────┘
```

> 編集モード: 従業員・週開始日は読取専用。
> PUBLISHED の場合は「変更すると下書きに戻ります」警告を表示。
> 「公開する」ボタンは DRAFT 状態のとき表示。

---

## コンポーネント構成

```
ShiftAssignModal
├── ModalHeader
│   ├── Title ("シフト割当" or "シフト変更")
│   └── CloseButton
├── ModalBody
│   └── AssignForm
│       ├── EmployeeSelect (従業員、新規時のみ編集可)
│       ├── WeekStartDatePicker (週開始日、新規時のみ編集可)
│       ├── StatusInfo (編集時のみ: ステータス + 警告メッセージ)
│       └── DayAssignmentTable
│           ├── DayRow (月曜)
│           │   ├── DayLabel ("月")
│           │   └── PatternSelect (パターン選択 or "休み")
│           ├── DayRow (火曜) ...
│           ├── DayRow (水曜) ...
│           ├── DayRow (木曜) ...
│           ├── DayRow (金曜) ...
│           ├── DayRow (土曜) ...
│           └── DayRow (日曜) ...
├── ModalFooter
│   ├── CancelButton (キャンセル)
│   ├── PublishButton ("公開する"、編集+DRAFT時のみ表示)
│   └── SubmitButton ("割当" or "変更")
└── ToastNotification (結果通知)
```

---

## 表示項目

### フォームフィールド

| フィールド | 表示名 | 型 | 必須 | 制約 | モード | 備考 |
|-----------|--------|-----|------|------|--------|------|
| employeeId | 従業員 | select | ✅ | 存在する従業員 | 新規:編集可 / 編集:読取専用 | 部下のみ表示 |
| weekStartDate | 週開始日 | date | ✅ | 月曜日のみ | 新規:編集可 / 編集:読取専用 | カレンダーピッカー |
| assignments.MONDAY | 月 | select | - | ACTIVEパターンのみ | 常に編集可 | "休み" 選択可 |
| assignments.TUESDAY | 火 | select | - | ACTIVEパターンのみ | 常に編集可 | "休み" 選択可 |
| assignments.WEDNESDAY | 水 | select | - | ACTIVEパターンのみ | 常に編集可 | "休み" 選択可 |
| assignments.THURSDAY | 木 | select | - | ACTIVEパターンのみ | 常に編集可 | "休み" 選択可 |
| assignments.FRIDAY | 金 | select | - | ACTIVEパターンのみ | 常に編集可 | "休み" 選択可 |
| assignments.SATURDAY | 土 | select | - | ACTIVEパターンのみ | 常に編集可 | "休み" 選択可 |
| assignments.SUNDAY | 日 | select | - | ACTIVEパターンのみ | 常に編集可 | "休み" 選択可 |

### パターンセレクトの選択肢

| 値 | 表示 | 備考 |
|----|------|------|
| null | -- 休み -- | 割当なし |
| PAT-001 | 早番（06:00-15:00） | パターン名 + 時間帯 |
| PAT-002 | 遅番（14:00-23:00） | パターン名 + 時間帯 |
| PAT-003 | 夜勤（22:00-07:00） | パターン名 + 時間帯 |

> ACTIVEなパターンのみ表示。GET /patterns?isActive=true で取得。

### バリデーションルール

| ルール | エラーメッセージ |
|--------|----------------|
| 従業員未選択（新規時） | 従業員を選択してください |
| 週開始日未入力（新規時） | 週開始日を入力してください |
| 週開始日が月曜日でない | 月曜日を選択してください |
| 全曜日が "休み"（1日以上必須） | 少なくとも1日はシフトを割り当ててください |

---

## アクション

### モーダルアクション

| アクション | トリガー | 処理 | 権限 | 条件 |
|-----------|---------|------|------|------|
| 割当（新規） | 割当ボタン | POST /schedules → 成功時: Toast + モーダル閉 + 一覧再取得 | write (管理職) | 新規モード |
| 変更（編集） | 変更ボタン | PUT /schedules/{id} → 成功時: Toast + モーダル閉 + 一覧再取得 | write (管理職) | 編集モード |
| 公開する | 公開するボタン | POST /schedules/{id}/actions/publish → 成功時: Toast + 一覧再取得 | write (管理職) | 編集+DRAFT |
| キャンセル | キャンセルボタン or [×] or Escape or オーバーレイクリック | モーダルを閉じる（入力内容破棄） | - | - |

### 動作フロー（新規割当）

1. 従業員を選択
2. 週開始日を選択（月曜日のみ）
3. 各曜日にパターンを割り当て（最低1日）
4. 「割当」ボタン → POST /schedules
5. 成功: Toast (success)「{従業員名} の {MM/DD} 週シフトを割り当てました」
6. DRAFT 状態で作成される

### 動作フロー（変更）

1. カレンダーから行クリックで編集モーダル起動
2. 既存の割当がフォームにプリセット
3. 各曜日のパターンを変更
4. 「変更」ボタン → PUT /schedules/{id}
5. 成功: Toast (success)「シフトを変更しました」
6. PUBLISHED だった場合は DRAFT に戻る

### 動作フロー（公開）

1. 編集モーダルで「公開する」ボタンをクリック
2. 確認: 「このスケジュールを公開しますか？対象従業員に通知されます。」
3. 確定: POST /schedules/{id}/actions/publish
4. 成功: Toast (success)「スケジュールを公開しました」

---

## 状態管理

```typescript
/** 割当フォームの曜日 */
type DayOfWeek =
  | 'MONDAY'
  | 'TUESDAY'
  | 'WEDNESDAY'
  | 'THURSDAY'
  | 'FRIDAY'
  | 'SATURDAY'
  | 'SUNDAY';

/** パターン選択肢 */
interface PatternOption {
  patternId: string;
  name: string;
  startTime: string;    // HH:mm
  endTime: string;      // HH:mm
  isOvernight: boolean;
}

/** フォーム入力値 */
interface AssignFormValues {
  employeeId: string | null;
  weekStartDate: string | null;    // ISO 8601 date
  assignments: Record<DayOfWeek, string | null>;
  // null = 休み、string = patternId
}

/** フィールドエラー */
interface FieldErrors {
  employeeId?: string;
  weekStartDate?: string;
  assignments?: string;     // 全曜日が休みの場合
}

/** モーダル状態 */
interface ShiftAssignModalState {
  /** モーダル表示状態 */
  isOpen: boolean;

  /** モード */
  mode: 'create' | 'edit';

  /** 編集対象（editモード時） */
  editTarget: {
    scheduleId: string;
    employeeName: string;
    status: 'DRAFT' | 'PUBLISHED';
  } | null;

  /** パターン選択肢（ACTIVEのみ） */
  patternOptions: PatternOption[];

  /** 従業員選択肢 */
  employeeOptions: {
    employeeId: string;
    employeeName: string;
  }[];

  /** フォーム入力値 */
  formValues: AssignFormValues;

  /** フィールドエラー */
  fieldErrors: FieldErrors;

  /** 送信中フラグ（二重送信防止） */
  isSubmitting: boolean;

  /** サーバーエラー */
  serverError: {
    message: string;
  } | null;
}
```

---

## API連携

| 操作 | エンドポイント | メソッド | 備考 |
|------|--------------|---------|-----------:|
| パターン一覧取得 | `/api/v1/shifts/patterns?isActive=true` | GET | セレクト選択肢用 |
| 新規割当 | `/api/v1/shifts/schedules` | POST | 新規モード |
| シフト変更 | `/api/v1/shifts/schedules/{scheduleId}` | PUT | 編集モード |
| シフト公開 | `/api/v1/shifts/schedules/{scheduleId}/actions/publish` | POST | 編集+DRAFT時 |

### リクエスト例（新規割当）

```json
{
  "employeeId": "EMP-001",
  "weekStartDate": "2024-04-01",
  "assignments": {
    "MONDAY": "PAT-001",
    "TUESDAY": "PAT-001",
    "WEDNESDAY": "PAT-001",
    "THURSDAY": "PAT-002",
    "FRIDAY": "PAT-002"
  }
}
```

> 「休み」の曜日は assignments から除外する。

### リクエスト例（変更）

```json
{
  "assignments": {
    "MONDAY": "PAT-001",
    "TUESDAY": "PAT-003",
    "WEDNESDAY": "PAT-001",
    "THURSDAY": "PAT-002",
    "FRIDAY": "PAT-002"
  }
}
```

---

## エラー処理

| エラー | HTTPステータス | 表示方法 | アクション |
|--------|--------------|---------|----------|
| 通信エラー | - | Toast (error) | 再試行ボタン |
| 認証エラー | 401 | Toast (error) + モーダル閉じ | ログイン画面へリダイレクト |
| バリデーションエラー | 400 | フィールド下にエラーメッセージ | 「月曜日を選択してください」等 |
| 存在しないリソース | 404 | Toast (error) | 「従業員またはパターンが存在しません」 |
| 競合エラー（新規時） | 409 | Toast (warning) | 「対象週に既存スケジュールが存在します」 |
| 事前条件エラー | 422 | Toast (warning) | 「無効なパターンが指定されています」 |
| サーバーエラー | 500 | Toast (error) | 再試行ボタン |

---

## レスポンシブ対応

| ブレークポイント | 対応 |
|----------------|------|
| Desktop (>768px) | 幅 520px モーダル（中央配置） |
| Mobile (<768px) | フルスクリーンモーダル（下からスライドアップ） |

---

## デザインガイドライン

> aesthetic: `clean-minimal` / colorScheme: `mono-accent`

### カラー＆テーマ

| 項目 | 値 | 備考 |
|------|-----|------|
| ベースカラー | #FFFFFF | モーダル背景 |
| サーフェスカラー | #F9FAFB (gray-50) | 曜日割当テーブル背景 |
| テキスト: Primary | #111827 (gray-900) | ラベル・入力値 |
| テキスト: Secondary | #6B7280 (gray-500) | プレースホルダー・読取専用 |
| テキスト: Warning | #D97706 (amber-600) | 「下書きに戻ります」警告 |
| ボーダー | #E5E7EB (gray-200) | 入力フィールド・テーブル罫線 |
| ボーダー: フォーカス | #2563EB (blue-600) | フォーカス時 |
| ボーダー: エラー | #DC2626 (red-600) | バリデーションエラー時 |
| アクセントカラー | #2563EB (blue-600) | 割当/変更ボタン |
| 公開ボタン | #059669 (emerald-600) | 公開するボタン |
| エラーテキスト | #DC2626 (red-600) | エラーメッセージ |
| オーバーレイ | rgba(0, 0, 0, 0.5) | モーダル背景 |
| コントラスト比 | WCAG AA 準拠（4.5:1 以上） | テキスト/背景 |

### タイポグラフィ

| 要素 | フォント | サイズ | ウェイト | 備考 |
|------|---------|--------|---------|------|
| モーダルタイトル | system-ui | 18px | 600 | ヘッダー |
| フォームラベル | system-ui | 14px | 500 | 必須マーク付き |
| 入力テキスト | system-ui | 14px | 400 | 入力値・選択値 |
| 読取専用テキスト | system-ui | 14px | 400 | gray-500 |
| 曜日ラベル | system-ui | 14px | 600 | 月〜日 |
| 警告テキスト | system-ui | 13px | 400 | amber-600 |
| エラーメッセージ | system-ui | 12px | 400 | red-600 |
| ボタンラベル | system-ui | 14px | 500 | 全ボタン共通 |

### レイアウト原則

| 項目 | 値 |
|------|-----|
| モーダル幅 | 520px（Desktop） / 100vw（Mobile） |
| モーダル角丸 | 12px（Desktop） / 0（Mobile） |
| 内部パディング | 24px |
| フィールド間余白 | 16px |
| ラベルとフィールドの間 | 6px |
| 曜日テーブル行高 | 44px |
| 曜日ラベル幅 | 40px |
| ボタン間 gap | 12px |
| ボタンサイズ | 高さ 40px |
| ボタン角丸 | 6px |
| セレクト高さ | 40px |
| カード影 | 0 4px 24px rgba(0, 0, 0, 0.15) |
| 区切り線 | 1px solid #E5E7EB |

### インタラクション

| 状態 | スタイル |
|------|---------:|
| セレクト: フォーカス | border-color: blue-600 + ring 2px |
| セレクト: エラー | border-color: red-600 + エラーメッセージ表示 |
| 読取専用フィールド | 背景 gray-50、ボーダーなし |
| ボタン: ホバー | 背景色 5% 暗く |
| ボタン: disabled | opacity: 0.4, cursor: not-allowed |
| ボタン: 送信中 | スピナー表示、全ボタン disabled |
| 公開ボタン: ホバー | emerald-700 |
| モーダル開閉 | フェードイン/アウト 150ms |
| 割当/変更成功 | Toast (success)、3秒自動消去 + モーダル閉じ |
| 公開成功 | Toast (success)、3秒自動消去 + ステータス更新 |
| 失敗 | Toast (error) or フィールドエラー表示 |

### アンチパターン（避けるべき表現）

- グラデーション背景の多用
- 装飾的なドロップシャドウの重ね掛け
- 無意味なアニメーション・トランジション
- ジェネリックなAI生成風のイラスト
- 過度な角丸（pill 形状の乱用）
- 曜日テーブルに過度な色分け
- パターンセレクトにアイコンを詰め込みすぎる

---

## 品質チェック結果

- [x] 全フォームフィールドがAPIリクエストと一致している（employeeId, weekStartDate, assignments）
- [x] バリデーションルールがAPI制約と一致している（月曜日チェック、1日以上割当、ACTIVEパターンのみ）
- [x] エラー状態の表示が定義されている（フィールドエラー + Toast通知、競合/事前条件エラー対応）
- [x] 二重送信防止が定義されている（isSubmitting フラグ）
- [x] 新規/編集の両モードが定義されている（create/edit切り替え）
- [x] PUBLISHEDからの変更時の警告が定義されている（「下書きに戻ります」）

<!-- メトリクスサマリー（/estimate 自動集計用）
画面種別: モーダル
コンポーネント数: 16
DataTable: 0
SearchForm: 0
フォーム数: 1
チャート数: 0
-->
